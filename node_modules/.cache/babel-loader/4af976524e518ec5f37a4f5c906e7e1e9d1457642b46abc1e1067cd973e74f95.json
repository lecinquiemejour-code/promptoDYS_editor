{"ast":null,"code":"// ImageStore - Gestion persistante des images avec IndexedDB\n// Utilise idb-keyval pour simplicit√© et robustesse\nimport{get,set,del}from'idb-keyval';/**\n * Sauvegarde un fichier image en IndexedDB\n * @param {File|Blob} file - Fichier image √† sauvegarder\n * @returns {Promise<string>} - UUID g√©n√©r√© pour identifier l'image\n */export const saveImage=async file=>{console.log('üîÑ [ImageStore] D√©but sauvegarde image:',file.name||'blob',\"(\".concat(Math.round(file.size/1024),\"KB)\"));try{// G√©n√©rer un UUID unique\nconst imageId=crypto.randomUUID();console.log('üÜî [ImageStore] UUID g√©n√©r√©:',imageId);// Sauvegarder en IndexedDB\nawait set(imageId,file);console.log('‚úÖ [ImageStore] Image sauvegard√©e en IndexedDB:',imageId);console.log('üìä [ImageStore] D√©tails:',{imageId,fileName:file.name||'unnamed',fileSize:\"\".concat(Math.round(file.size/1024),\"KB\"),fileType:file.type});return imageId;}catch(error){console.error('‚ùå [ImageStore] Erreur sauvegarde:',error);throw new Error(\"\\xC9chec sauvegarde image: \".concat(error.message));}};/**\n * R√©cup√®re une image depuis IndexedDB et cr√©e une Object URL\n * @param {string} imageId - UUID de l'image\n * @returns {Promise<string|null>} - Object URL temporaire ou null si non trouv√©e\n */export const loadImage=async imageId=>{console.log('üîç [ImageStore] Chargement image:',imageId);try{// R√©cup√©rer le Blob depuis IndexedDB\nconst blob=await get(imageId);if(!blob){console.warn('‚ö†Ô∏è [ImageStore] Image non trouv√©e en IndexedDB:',imageId);return null;}console.log('üì¶ [ImageStore] Blob r√©cup√©r√©:',{imageId,blobSize:\"\".concat(Math.round(blob.size/1024),\"KB\"),blobType:blob.type});// Cr√©er Object URL temporaire\nconst objectUrl=URL.createObjectURL(blob);console.log('üîó [ImageStore] Object URL cr√©√©e:',objectUrl);return objectUrl;}catch(error){console.error('‚ùå [ImageStore] Erreur chargement:',error);return null;}};/**\n * Supprime une image de IndexedDB\n * @param {string} imageId - UUID de l'image √† supprimer\n * @returns {Promise<boolean>} - true si supprim√©e avec succ√®s\n */export const deleteImage=async imageId=>{console.log('üóëÔ∏è [ImageStore] Suppression image:',imageId);try{await del(imageId);console.log('‚úÖ [ImageStore] Image supprim√©e de IndexedDB:',imageId);return true;}catch(error){console.error('‚ùå [ImageStore] Erreur suppression:',error);return false;}};/**\n * Liste toutes les images stock√©es (debug uniquement)\n * @returns {Promise<string[]>} - Liste des imageIds\n */export const listAllImages=async()=>{console.log('üìã [ImageStore] Listing toutes les images...');try{// Note: idb-keyval ne fournit pas de m√©thode keys() directe\n// Cette fonction est pour debug - en production on trackera les IDs diff√©remment\nconsole.warn('‚ö†Ô∏è [ImageStore] listAllImages() est pour debug uniquement');return[];}catch(error){console.error('‚ùå [ImageStore] Erreur listing:',error);return[];}};/**\n * Nettoie les Object URLs pour √©viter les fuites m√©moire\n * @param {string} objectUrl - URL √† r√©voquer\n */export const revokeImageUrl=objectUrl=>{if(objectUrl&&objectUrl.startsWith('blob:')){console.log('üßπ [ImageStore] R√©vocation Object URL:',objectUrl);URL.revokeObjectURL(objectUrl);}};/**\n * Demande au navigateur de rendre le stockage persistant\n * @returns {Promise<boolean>} - true si accord√©\n */export const requestPersistentStorage=async()=>{console.log('üîí [ImageStore] Demande stockage persistant...');if('storage'in navigator&&'persist'in navigator.storage){try{const isPersistent=await navigator.storage.persist();console.log(isPersistent?'‚úÖ [ImageStore] Stockage persistant accord√©':'‚ö†Ô∏è [ImageStore] Stockage persistant refus√©');return isPersistent;}catch(error){console.error('‚ùå [ImageStore] Erreur demande persistance:',error);return false;}}else{console.warn('‚ö†Ô∏è [ImageStore] API storage.persist() non support√©e');return false;}};/**\n * Nettoyage intelligent des images orphelines\n * Supprime les images d'IndexedDB qui ne sont plus r√©f√©renc√©es dans le document\n * @param {string} htmlContent - Contenu HTML du document √† analyser\n * @returns {Promise<number>} - Nombre d'images nettoy√©es\n */export const cleanupOrphanedImages=async htmlContent=>{console.log('üßπ [ImageStore] D√©but nettoyage des images orphelines...');try{// Parser le HTML pour trouver les imageIds actuellement utilis√©s\nconst parser=new DOMParser();const doc=parser.parseFromString(htmlContent,'text/html');const usedImageIds=new Set();// Collecter tous les data-image-id dans le document\nconst imagesWithIds=doc.querySelectorAll('img[data-image-id]');imagesWithIds.forEach(img=>{const imageId=img.getAttribute('data-image-id');if(imageId){usedImageIds.add(imageId);}});console.log('üîç [ImageStore] Images utilis√©es dans le document:',usedImageIds.size);console.log('üìã [ImageStore] IDs utilis√©s:',Array.from(usedImageIds));// Note: idb-keyval ne fournit pas de m√©thode keys() native\n// En production, on maintiendrait une liste des imageIds dans localStorage\n// Pour l'instant, on log seulement les images utilis√©es\nconsole.log('‚ÑπÔ∏è [ImageStore] Nettoyage limit√© - pas de liste globale des cl√©s IndexedDB');return 0;// Pas de nettoyage effectu√© pour l'instant\n}catch(error){console.error('‚ùå [ImageStore] Erreur nettoyage:',error);return 0;}};// Log d'initialisation\nconsole.log('üöÄ [ImageStore] Module initialis√© avec idb-keyval');","map":{"version":3,"names":["get","set","del","saveImage","file","console","log","name","concat","Math","round","size","imageId","crypto","randomUUID","fileName","fileSize","fileType","type","error","Error","message","loadImage","blob","warn","blobSize","blobType","objectUrl","URL","createObjectURL","deleteImage","listAllImages","revokeImageUrl","startsWith","revokeObjectURL","requestPersistentStorage","navigator","storage","isPersistent","persist","cleanupOrphanedImages","htmlContent","parser","DOMParser","doc","parseFromString","usedImageIds","Set","imagesWithIds","querySelectorAll","forEach","img","getAttribute","add","Array","from"],"sources":["C:/Users/JEAN-NOELLEFEBVRE-SA/CascadeProjects/editor/src/utils/imageStore.js"],"sourcesContent":["// ImageStore - Gestion persistante des images avec IndexedDB\n// Utilise idb-keyval pour simplicit√© et robustesse\nimport { get, set, del } from 'idb-keyval';\n\n/**\n * Sauvegarde un fichier image en IndexedDB\n * @param {File|Blob} file - Fichier image √† sauvegarder\n * @returns {Promise<string>} - UUID g√©n√©r√© pour identifier l'image\n */\nexport const saveImage = async (file) => {\n  console.log('üîÑ [ImageStore] D√©but sauvegarde image:', file.name || 'blob', `(${Math.round(file.size/1024)}KB)`);\n  \n  try {\n    // G√©n√©rer un UUID unique\n    const imageId = crypto.randomUUID();\n    console.log('üÜî [ImageStore] UUID g√©n√©r√©:', imageId);\n    \n    // Sauvegarder en IndexedDB\n    await set(imageId, file);\n    console.log('‚úÖ [ImageStore] Image sauvegard√©e en IndexedDB:', imageId);\n    console.log('üìä [ImageStore] D√©tails:', {\n      imageId,\n      fileName: file.name || 'unnamed',\n      fileSize: `${Math.round(file.size/1024)}KB`,\n      fileType: file.type\n    });\n    \n    return imageId;\n  } catch (error) {\n    console.error('‚ùå [ImageStore] Erreur sauvegarde:', error);\n    throw new Error(`√âchec sauvegarde image: ${error.message}`);\n  }\n};\n\n/**\n * R√©cup√®re une image depuis IndexedDB et cr√©e une Object URL\n * @param {string} imageId - UUID de l'image\n * @returns {Promise<string|null>} - Object URL temporaire ou null si non trouv√©e\n */\nexport const loadImage = async (imageId) => {\n  console.log('üîç [ImageStore] Chargement image:', imageId);\n  \n  try {\n    // R√©cup√©rer le Blob depuis IndexedDB\n    const blob = await get(imageId);\n    \n    if (!blob) {\n      console.warn('‚ö†Ô∏è [ImageStore] Image non trouv√©e en IndexedDB:', imageId);\n      return null;\n    }\n    \n    console.log('üì¶ [ImageStore] Blob r√©cup√©r√©:', {\n      imageId,\n      blobSize: `${Math.round(blob.size/1024)}KB`,\n      blobType: blob.type\n    });\n    \n    // Cr√©er Object URL temporaire\n    const objectUrl = URL.createObjectURL(blob);\n    console.log('üîó [ImageStore] Object URL cr√©√©e:', objectUrl);\n    \n    return objectUrl;\n  } catch (error) {\n    console.error('‚ùå [ImageStore] Erreur chargement:', error);\n    return null;\n  }\n};\n\n/**\n * Supprime une image de IndexedDB\n * @param {string} imageId - UUID de l'image √† supprimer\n * @returns {Promise<boolean>} - true si supprim√©e avec succ√®s\n */\nexport const deleteImage = async (imageId) => {\n  console.log('üóëÔ∏è [ImageStore] Suppression image:', imageId);\n  \n  try {\n    await del(imageId);\n    console.log('‚úÖ [ImageStore] Image supprim√©e de IndexedDB:', imageId);\n    return true;\n  } catch (error) {\n    console.error('‚ùå [ImageStore] Erreur suppression:', error);\n    return false;\n  }\n};\n\n/**\n * Liste toutes les images stock√©es (debug uniquement)\n * @returns {Promise<string[]>} - Liste des imageIds\n */\nexport const listAllImages = async () => {\n  console.log('üìã [ImageStore] Listing toutes les images...');\n  \n  try {\n    // Note: idb-keyval ne fournit pas de m√©thode keys() directe\n    // Cette fonction est pour debug - en production on trackera les IDs diff√©remment\n    console.warn('‚ö†Ô∏è [ImageStore] listAllImages() est pour debug uniquement');\n    return [];\n  } catch (error) {\n    console.error('‚ùå [ImageStore] Erreur listing:', error);\n    return [];\n  }\n};\n\n/**\n * Nettoie les Object URLs pour √©viter les fuites m√©moire\n * @param {string} objectUrl - URL √† r√©voquer\n */\nexport const revokeImageUrl = (objectUrl) => {\n  if (objectUrl && objectUrl.startsWith('blob:')) {\n    console.log('üßπ [ImageStore] R√©vocation Object URL:', objectUrl);\n    URL.revokeObjectURL(objectUrl);\n  }\n};\n\n/**\n * Demande au navigateur de rendre le stockage persistant\n * @returns {Promise<boolean>} - true si accord√©\n */\nexport const requestPersistentStorage = async () => {\n  console.log('üîí [ImageStore] Demande stockage persistant...');\n  \n  if ('storage' in navigator && 'persist' in navigator.storage) {\n    try {\n      const isPersistent = await navigator.storage.persist();\n      console.log(isPersistent ? \n        '‚úÖ [ImageStore] Stockage persistant accord√©' : \n        '‚ö†Ô∏è [ImageStore] Stockage persistant refus√©'\n      );\n      return isPersistent;\n    } catch (error) {\n      console.error('‚ùå [ImageStore] Erreur demande persistance:', error);\n      return false;\n    }\n  } else {\n    console.warn('‚ö†Ô∏è [ImageStore] API storage.persist() non support√©e');\n    return false;\n  }\n};\n\n/**\n * Nettoyage intelligent des images orphelines\n * Supprime les images d'IndexedDB qui ne sont plus r√©f√©renc√©es dans le document\n * @param {string} htmlContent - Contenu HTML du document √† analyser\n * @returns {Promise<number>} - Nombre d'images nettoy√©es\n */\nexport const cleanupOrphanedImages = async (htmlContent) => {\n  console.log('üßπ [ImageStore] D√©but nettoyage des images orphelines...');\n  \n  try {\n    // Parser le HTML pour trouver les imageIds actuellement utilis√©s\n    const parser = new DOMParser();\n    const doc = parser.parseFromString(htmlContent, 'text/html');\n    const usedImageIds = new Set();\n    \n    // Collecter tous les data-image-id dans le document\n    const imagesWithIds = doc.querySelectorAll('img[data-image-id]');\n    imagesWithIds.forEach(img => {\n      const imageId = img.getAttribute('data-image-id');\n      if (imageId) {\n        usedImageIds.add(imageId);\n      }\n    });\n    \n    console.log('üîç [ImageStore] Images utilis√©es dans le document:', usedImageIds.size);\n    console.log('üìã [ImageStore] IDs utilis√©s:', Array.from(usedImageIds));\n    \n    // Note: idb-keyval ne fournit pas de m√©thode keys() native\n    // En production, on maintiendrait une liste des imageIds dans localStorage\n    // Pour l'instant, on log seulement les images utilis√©es\n    console.log('‚ÑπÔ∏è [ImageStore] Nettoyage limit√© - pas de liste globale des cl√©s IndexedDB');\n    \n    return 0; // Pas de nettoyage effectu√© pour l'instant\n  } catch (error) {\n    console.error('‚ùå [ImageStore] Erreur nettoyage:', error);\n    return 0;\n  }\n};\n\n// Log d'initialisation\nconsole.log('üöÄ [ImageStore] Module initialis√© avec idb-keyval');\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}