{"ast":null,"code":"import _objectSpread from\"C:/Users/JEAN-NOELLEFEBVRE-SA/CascadeProjects/editor/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useCallback,useEffect,useRef,forwardRef}from'react';import{convertAllPromptoDysUrlsToBlobs,getCurrentProject}from'../utils/promptoDysManager';import{loadImage,saveImage,requestPersistentStorage}from'../utils/imageStore';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const Editor=/*#__PURE__*/forwardRef((_ref,ref)=>{let{content,setContent,viewMode,onInput,currentFormat,onFormatChange,mathJaxReady,ignoreSelectionChangeRef,selectedImage,onImageClick,onEditorClick,onDeleteSelectedImage,onSelectionChange,storeBlobForUrl,editorRef}=_ref;// Utilise editorRef pass√©e en props (pas de ref locale)\nconst isInitializedRef=useRef(false);const previousContentRef=useRef('');// Fonction pour cr√©er des blobs uniques (mutualisation avec Toolbar)\nconst createUniqueBlob=useCallback((file,storeBlobForUrl)=>{const uniqueId=\"\".concat(Date.now(),\"_\").concat(Math.random().toString(36).substr(2,9));const uniqueName=\"\".concat(uniqueId,\"_\").concat(file.name);const uniqueFile=new File([file],uniqueName,{type:file.type});const blobUrl=URL.createObjectURL(uniqueFile);console.log('üéØ [createUniqueBlob] Cr√©ation blob unique:',uniqueName,'->',blobUrl);storeBlobForUrl(blobUrl,uniqueFile);return{blobUrl,uniqueFile};},[]);// Fonction mutualis√©e pour traiter les images coll√©es et les rendre uniques\nconst processImageBlobs=useCallback(async(container,storeBlobForUrl)=>{console.log('üîÑ [processImageBlobs] Traitement des images...');// Traiter les images blob: temporaires\nconst blobImages=container.querySelectorAll('img[src^=\"blob:\"]');console.log('üîç [processImageBlobs] Images blob trouv√©es:',blobImages.length);for(const img of blobImages){const originalUrl=img.src;try{console.log('üì• [processImageBlobs] Traitement blob:',originalUrl);// R√©cup√©rer le blob original\nconst response=await fetch(originalUrl);const blob=await response.blob();// Cr√©er un nouveau File avec un nom unique\nconst file=new File([blob],'pasted-image.png',{type:blob.type});const{blobUrl}=createUniqueBlob(file,storeBlobForUrl);// Remplacer l'URL dans l'image\nimg.src=blobUrl;console.log('‚úÖ [processImageBlobs] Image blob mise √† jour:',originalUrl,'->',blobUrl);}catch(error){console.error('‚ùå [processImageBlobs] Erreur blob pour:',originalUrl,error);}}// Traiter les images base64 coll√©es (copie d'√©cran Windows)\nconst base64Images=container.querySelectorAll('img[src^=\"data:image/\"]');console.log('üîç [processImageBlobs] Images base64 trouv√©es:',base64Images.length);for(const img of base64Images){const dataUrl=img.src;try{console.log('üì• [processImageBlobs] Traitement base64 (longueur:',dataUrl.length,'chars)');// Convertir data URL en blob\nconst response=await fetch(dataUrl);const blob=await response.blob();// G√©n√©rer nom de fichier unique\nconst timestamp=new Date().toISOString().replace(/[:.]/g,'-').slice(0,-5);const filename=\"pasted-screenshot-\".concat(timestamp,\".png\");// G√©n√©rer ID unique et stocker dans IndexedDB\nconst imageId=crypto.randomUUID();await saveImage(imageId,blob);// Cr√©er blob URL temporaire pour affichage\nconst blobUrl=URL.createObjectURL(blob);// Stocker le mapping URL->File pour compatibilit√©\nconst file=new File([blob],filename,{type:blob.type});if(storeBlobForUrl){storeBlobForUrl(blobUrl,file);}// Remplacer l'image base64 par blob + data-image-id\nimg.src=blobUrl;img.setAttribute('data-image-id',imageId);img.setAttribute('alt',filename);console.log('‚úÖ [processImageBlobs] Image base64 convertie:',dataUrl.substring(0,50)+'...','->',blobUrl,'ID:',imageId);}catch(error){console.error('‚ùå [processImageBlobs] Erreur base64 pour:',dataUrl.substring(0,50)+'...',error);}}},[createUniqueBlob]);// Fonction de r√©hydratation des images depuis IndexedDB\nconst rehydrateImages=useCallback(async container=>{console.log('üîÑ [rehydrateImages] D√©but r√©hydratation des images...');if(!container){console.warn('‚ö†Ô∏è [rehydrateImages] Pas de conteneur fourni');return;}// Trouver toutes les images avec data-image-id\nconst images=container.querySelectorAll('img[data-image-id]');console.log(\"\\uD83D\\uDD0D [rehydrateImages] \".concat(images.length,\" images avec data-image-id trouv\\xE9es\"));// Traiter chaque image\nfor(const img of images){const imageId=img.getAttribute('data-image-id');console.log('üîÑ [rehydrateImages] Traitement image:',imageId);try{// Charger l'image depuis IndexedDB\nconst objectUrl=await loadImage(imageId);if(objectUrl){// Conserver les attributs existants\nconst width=img.getAttribute('width');const height=img.getAttribute('height');const alt=img.getAttribute('alt')||'';console.log('‚úÖ [rehydrateImages] Image charg√©e:',{imageId,oldSrc:img.src,newSrc:objectUrl,width,height,alt});// Mettre √† jour la source\nimg.src=objectUrl;console.log('üéØ [rehydrateImages] Image r√©hydrat√©e avec succ√®s:',imageId);}else{console.warn('‚ö†Ô∏è [rehydrateImages] Image non trouv√©e en IndexedDB:',imageId);// On garde l'image avec son data-image-id pour un essai ult√©rieur\n}}catch(error){console.error('‚ùå [rehydrateImages] Erreur r√©hydratation:',imageId,error);}}console.log('‚úÖ [rehydrateImages] R√©hydratation termin√©e');},[]);// Fonction de migration des anciennes images blob: vers IndexedDB\nconst migrateOldBlobImages=useCallback(async container=>{console.log('üîÑ [migrateOldBlobImages] D√©but migration des anciennes images...');if(!container){console.warn('‚ö†Ô∏è [migrateOldBlobImages] Pas de conteneur fourni');return;}// Trouver toutes les images avec src blob: SANS data-image-id (anciennes)\nconst oldImages=container.querySelectorAll('img[src^=\"blob:\"]:not([data-image-id])');console.log(\"\\uD83D\\uDD0D [migrateOldBlobImages] \".concat(oldImages.length,\" anciennes images blob trouv\\xE9es\"));if(oldImages.length===0){console.log('‚úÖ [migrateOldBlobImages] Aucune migration n√©cessaire');return;}// Traiter chaque ancienne image\nfor(const img of oldImages){const oldBlobUrl=img.src;console.log('üîÑ [migrateOldBlobImages] Migration image:',oldBlobUrl);try{// R√©cup√©rer le blob depuis l'URL\nconst response=await fetch(oldBlobUrl);if(!response.ok){console.warn('‚ö†Ô∏è [migrateOldBlobImages] Impossible de r√©cup√©rer le blob:',response.status);continue;}const blob=await response.blob();console.log('üì¶ [migrateOldBlobImages] Blob r√©cup√©r√©:',{size:\"\".concat(Math.round(blob.size/1024),\"KB\"),type:blob.type});// Cr√©er un File pour saveImage()\nconst fileName=img.alt||\"migrated_image_\".concat(Date.now(),\".png\");const file=new File([blob],fileName,{type:blob.type});// Sauvegarder en IndexedDB\nconst imageId=await saveImage(file);console.log('üíæ [migrateOldBlobImages] Image migr√©e vers IndexedDB:',imageId);// Mettre √† jour l'√©l√©ment img avec data-image-id\nimg.setAttribute('data-image-id',imageId);// Cr√©er nouvelle Object URL\nconst newObjectUrl=URL.createObjectURL(blob);img.src=newObjectUrl;// R√©voquer l'ancienne URL si possible\ntry{URL.revokeObjectURL(oldBlobUrl);console.log('üßπ [migrateOldBlobImages] Ancienne URL r√©voqu√©e:',oldBlobUrl);}catch(revokeError){console.warn('‚ö†Ô∏è [migrateOldBlobImages] Impossible de r√©voquer ancienne URL:',revokeError);}console.log('‚úÖ [migrateOldBlobImages] Image migr√©e avec succ√®s:',{oldUrl:oldBlobUrl,newImageId:imageId,fileName});}catch(error){console.error('‚ùå [migrateOldBlobImages] Erreur migration:',oldBlobUrl,error);// On garde l'ancienne image m√™me en cas d'erreur\n}}console.log('‚úÖ [migrateOldBlobImages] Migration termin√©e');// D√©clencher une sauvegarde du contenu apr√®s migration\nif(onInput&&container.innerHTML){console.log('üíæ [migrateOldBlobImages] D√©clenchement sauvegarde apr√®s migration...');const event=new Event('input',{bubbles:true});container.dispatchEvent(event);}},[onInput]);// Gestionnaire pour l'auto-redimensionnement (toujours d√©clar√©)\nconst handleTextareaResize=useCallback(textarea=>{if(textarea){textarea.style.height='auto';textarea.style.height=Math.max(384,textarea.scrollHeight)+'px';}},[]);// Effect pour la r√©hydratation des images au chargement\nuseEffect(()=>{console.log(' [Editor] Effect r√©hydratation - Chargement initial');const initImageSystem=async()=>{console.log(' [Editor] Demande stockage persistant...');// Demander le stockage persistant\nawait requestPersistentStorage();// R√©hydrater les images si l'√©diteur est pr√™t\nif(editorRef.current){console.log(' [Editor] D√©clenchement r√©hydratation...');await rehydrateImages(editorRef.current);console.log(' [Editor] D√©clenchement migration anciennes images...');await migrateOldBlobImages(editorRef.current);}else{console.warn(' [Editor] editorRef pas encore pr√™t pour r√©hydratation');}};initImageSystem();},[rehydrateImages,migrateOldBlobImages]);// Effect pour r√©hydrater quand le contenu change (nouveau document charg√©)\nuseEffect(()=>{if(content&&content!==previousContentRef.current&&editorRef.current){console.log(' [Editor] Contenu chang√© - V√©rification r√©hydratation...');previousContentRef.current=content;// D√©lai pour laisser le DOM se mettre √† jour (plus long en production)\nconst rehydrationDelay=process.env.NODE_ENV==='production'?1000:100;console.log(\" [Editor] D\\xE9lai r\\xE9hydratation: \".concat(rehydrationDelay,\"ms (env: \").concat(process.env.NODE_ENV,\")\"));setTimeout(async()=>{await rehydrateImages(editorRef.current);await migrateOldBlobImages(editorRef.current);},rehydrationDelay);}},[content,rehydrateImages,migrateOldBlobImages]);// Fonction pour formater le HTML avec des retours √† la ligne et indentation\nconst formatHtmlForSource=useCallback(html=>{let indentLevel=0;const indentSize=2;// 2 espaces par niveau\nreturn html.replace(/<br\\s*\\/?>/gi,'<br>\\n').replace(/<\\/?(h[1-6]|p|div|ul|ol|li|strong|em|span)[^>]*>/gi,match=>{if(match.startsWith('</')){// Balise fermante : diminuer l'indentation puis ajouter la balise\nindentLevel=Math.max(0,indentLevel-1);return match+'\\n';}else{// Balise ouvrante : ajouter la balise puis augmenter l'indentation\nconst result='\\n'+' '.repeat(indentLevel*indentSize)+match;// Augmenter l'indentation pour les balises conteneurs\nif(match.match(/<(ul|ol|li|div|p|h[1-6])[^>]*>/i)){indentLevel++;}return result;}}).split('\\n').map((line,index)=>{if(index===0)return line.trim();// Premi√®re ligne sans indentation\nif(line.trim()==='')return'';// Ligne vide\nif(line.trim().startsWith('</')){// Balise fermante : r√©duire l'indentation\nconst currentIndent=Math.max(0,indentLevel-1);return' '.repeat(currentIndent*indentSize)+line.trim();}// Contenu texte : utiliser l'indentation actuelle\nreturn line.startsWith(' ')?line:' '.repeat(indentLevel*indentSize)+line.trim();}).join('\\n').replace(/^\\n+/,'')// Supprimer les retours √† la ligne en d√©but\n.replace(/\\n{2,}/g,'\\n')// Supprimer toutes les lignes vides multiples\n.trim();},[]);// Gestionnaire unifi√© WYSIWYG - connect√© directement √† onInput\nconst handleWysiwygChange=useCallback(e=>{console.log('üìù handleWysiwygChange d√©clench√©');if(!editorRef.current)return;// Nettoyer les spans vides et les &nbsp; en trop\nconst cleanContent=html=>{return html.replace(/<span(?![^>]*style=\"[^\"]*color:)[^>]*>\\s*<\\/span>/g,'')// Supprimer spans vides SAUF les spans color√©s\n.replace(/(&nbsp;\\s*){2,}/g,'&nbsp;')// R√©duire les &nbsp; multiples\n.replace(/<font[^>]*color=\"([^\"]*)\"[^>]*>(.*?)<\\/font>/g,'<span style=\"color: $1;\">$2</span>')// Convertir font en span\n.replace(/<b\\b[^>]*>(.*?)<\\/b>/g,'<strong>$1</strong>')// Convertir b en strong\n.replace(/<i\\b[^>]*>(.*?)<\\/i>/g,'<em>$1</em>');// Convertir i en em\n};const newContent=cleanContent(editorRef.current.innerHTML);console.log('üîç Contenu actuel vs nouveau:',content.length,'vs',newContent.length);// Appel direct vers onInput du hook useEditor\nif(newContent!==content){console.log('‚úÖ WYSIWYG Changement - Appel onInput direct');onInput({target:{innerHTML:newContent}});}// D√©clencher mise √† jour du formatage apr√®s un d√©lai\nif(onSelectionChange&&!(ignoreSelectionChangeRef!==null&&ignoreSelectionChangeRef!==void 0&&ignoreSelectionChangeRef.current)){console.log('üîÑ EDITOR handleWysiwygChange - Va appeler onSelectionChange dans 50ms');setTimeout(onSelectionChange,50);}else{console.log('‚ùå EDITOR handleWysiwygChange - onSelectionChange BLOQU√â - ignoreFlag:',ignoreSelectionChangeRef===null||ignoreSelectionChangeRef===void 0?void 0:ignoreSelectionChangeRef.current);}},[content,onInput,onSelectionChange]);// Gestionnaire pour les √©v√©nements de s√©lection/curseur\nconst handleSelectionChange=useCallback(()=>{console.log('üìç EDITOR handleSelectionChange - ignoreFlag:',ignoreSelectionChangeRef===null||ignoreSelectionChangeRef===void 0?void 0:ignoreSelectionChangeRef.current);if(ignoreSelectionChangeRef!==null&&ignoreSelectionChangeRef!==void 0&&ignoreSelectionChangeRef.current){console.log('‚ùå EDITOR handleSelectionChange - BLOQU√â par ignoreFlag');return;}if(viewMode==='wysiwyg'&&document.activeElement===editorRef.current){console.log('‚úÖ EDITOR handleSelectionChange - VA APPELER onSelectionChange');onSelectionChange();}else{console.log('‚ö†Ô∏è EDITOR handleSelectionChange - SKIP conditions');}// eslint-disable-next-line react-hooks/exhaustive-deps\n},[viewMode,onSelectionChange,ignoreSelectionChangeRef]);// Initialiser le contenu uniquement si n√©cessaire\nuseEffect(()=>{const initializeContent=async()=>{if(viewMode==='wysiwyg'&&editorRef.current&&editorRef.current.innerHTML!==content){// Ne pas modifier le contenu si l'utilisateur interagit activement\nconst hasFocus=document.activeElement===editorRef.current;const hasSelection=window.getSelection().rangeCount>0;// √âviter les mises √† jour pendant l'interaction utilisateur\nif(hasFocus&&hasSelection){return;// Ne pas perturber l'utilisateur\n}// Convertir les URLs relatives PromptoDYS en Blob URLs pour affichage\nconst currentProject=getCurrentProject();let displayContent=content;if(currentProject.directory){displayContent=await convertAllPromptoDysUrlsToBlobs(content,currentProject.directory);}// Mise √† jour avec le contenu converti\neditorRef.current.innerHTML=displayContent;// Re-rendre MathJax apr√®s mise √† jour du contenu\nif(window.MathJax&&window.MathJax.typesetPromise){window.MathJax.typesetPromise([editorRef.current]).catch(err=>{console.warn('Erreur MathJax:',err);});}// SOLUTION F5: Forcer le retraitement des poign√©es apr√®s initialisation\nsetTimeout(()=>{var _editorRef$current,_editorRef$current2;console.log('üîÑ [F5 Fix] Retraitement forc√© des poign√©es d\\'images apr√®s initialisation');const images=(_editorRef$current=editorRef.current)===null||_editorRef$current===void 0?void 0:_editorRef$current.querySelectorAll('img');if(images&&(_editorRef$current2=editorRef.current)!==null&&_editorRef$current2!==void 0&&_editorRef$current2.addResizeHandlesToImage){images.forEach(img=>{// Retirer le marqueur data-resizable pour forcer le retraitement\nimg.removeAttribute('data-resizable');// Retirer le wrapper s'il existe d√©j√†\nconst existingWrapper=img.closest('.resizable-image');if(existingWrapper){const parent=existingWrapper.parentNode;parent.insertBefore(img,existingWrapper);existingWrapper.remove();}// Retraiter l'image\neditorRef.current.addResizeHandlesToImage(img);});console.log('‚úÖ [F5 Fix] Poign√©es retrait√©es pour',images.length,'image(s)');}},300);// D√©lai pour s'assurer que tout est bien initialis√©\n}};initializeContent();// eslint-disable-next-line react-hooks/exhaustive-deps\n},[viewMode,content]);// Gestionnaire pour la copie - convertir HTML en texte propre et g√©rer les images s√©lectionn√©es\nconst handleCopy=useCallback(e=>{if(viewMode==='wysiwyg'&&editorRef.current){// Priorit√© 1: Si une image est s√©lectionn√©e, copier l'image\nif(selectedImage){try{// Cr√©er un √©l√©ment temporaire avec l'image\nconst tempDiv=document.createElement('div');const clonedImg=selectedImage.cloneNode(true);tempDiv.appendChild(clonedImg);// Copier au format HTML pour pr√©server la structure\ne.clipboardData.setData('text/html',tempDiv.innerHTML);// Copier aussi le src comme texte de fallback\ne.clipboardData.setData('text/plain',selectedImage.src);e.preventDefault();return;}catch(error){console.warn('Erreur copie image:',error);}}// Priorit√© 2: S√©lection de texte classique\nconst selection=window.getSelection();if(selection.rangeCount>0){const range=selection.getRangeAt(0);const selectedContent=range.cloneContents();const tempDiv=document.createElement('div');tempDiv.appendChild(selectedContent);// Convertir HTML en texte avec retours √† la ligne pr√©serv√©s\nconst htmlContent=tempDiv.innerHTML;const textContent=htmlContent.replace(/<div[^>]*>/gi,'').replace(/<\\/div>/gi,'\\n').replace(/<br\\s*\\/?>/gi,'\\n').replace(/<p[^>]*>/gi,'').replace(/<\\/p>/gi,'\\n').replace(/<[^>]+>/g,'')// Supprimer toutes les autres balises\n.replace(/&nbsp;/g,' ').replace(/&amp;/g,'&').replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&quot;/g,'\"').replace(/&#39;/g,\"'\").replace(/\\n+$/,'');// Supprimer les retours √† la ligne en fin\n// Mettre le texte propre dans le presse-papier\ne.clipboardData.setData('text/plain',textContent);e.preventDefault();}}// eslint-disable-next-line react-hooks/exhaustive-deps\n},[viewMode,selectedImage]);// Gestionnaire pour forcer le refresh apr√®s coller\nconst handlePaste=useCallback(e=>{if(viewMode==='wysiwyg'&&editorRef.current){// Attendre que le contenu soit coll√©\nsetTimeout(async()=>{console.log('üîÑ Refresh forc√© apr√®s coller');// Traiter les images coll√©es pour leur donner des URLs blob uniques\nif(storeBlobForUrl){await processImageBlobs(editorRef.current,storeBlobForUrl);}// Ajouter les poign√©es aux nouvelles images coll√©es\nconst newImages=editorRef.current.querySelectorAll('img:not([data-resizable])');newImages.forEach(img=>{if(editorRef.current.addResizeHandlesToImage){editorRef.current.addResizeHandlesToImage(img);}});// D√©clencher sauvegarde\nif(onInput){const event=new Event('input',{bubbles:true});editorRef.current.dispatchEvent(event);}},100);}},[viewMode,onInput]);// √âcouter les changements de s√©lection, la copie et le coller\nuseEffect(()=>{if(viewMode==='wysiwyg'){var _editorRef$current3,_editorRef$current4;document.addEventListener('selectionchange',handleSelectionChange);(_editorRef$current3=editorRef.current)===null||_editorRef$current3===void 0?void 0:_editorRef$current3.addEventListener('copy',handleCopy);(_editorRef$current4=editorRef.current)===null||_editorRef$current4===void 0?void 0:_editorRef$current4.addEventListener('paste',handlePaste);return()=>{var _editorRef$current5,_editorRef$current6;document.removeEventListener('selectionchange',handleSelectionChange);(_editorRef$current5=editorRef.current)===null||_editorRef$current5===void 0?void 0:_editorRef$current5.removeEventListener('copy',handleCopy);(_editorRef$current6=editorRef.current)===null||_editorRef$current6===void 0?void 0:_editorRef$current6.removeEventListener('paste',handlePaste);};}// eslint-disable-next-line react-hooks/exhaustive-deps\n},[viewMode,handleSelectionChange,handleCopy,handlePaste]);// Effect pour redimensionner au changement de contenu (toujours d√©clar√©)\nuseEffect(()=>{if(viewMode!=='wysiwyg'&&editorRef.current){handleTextareaResize(editorRef.current);}// eslint-disable-next-line react-hooks/exhaustive-deps\n},[content,viewMode,handleTextareaResize]);// Supprim√© : useEffect d'initialisation qui causait l'√©crasement des execCommand\n// Effect pour appliquer le style de s√©lection d'image\nuseEffect(()=>{if(viewMode==='wysiwyg'&&editorRef.current){// Supprimer la classe de toutes les images\nconst allImages=editorRef.current.querySelectorAll('img');allImages.forEach(img=>{const wrapper=img.closest('.resizable-image');if(wrapper){wrapper.classList.remove('image-selected');}});// Ajouter la classe √† l'image s√©lectionn√©e\nif(selectedImage){const wrapper=selectedImage.closest('.resizable-image');if(wrapper){wrapper.classList.add('image-selected');}}}},[selectedImage,viewMode,content]);// Gestion des poign√©es de redimensionnement pour les images\nuseEffect(()=>{if(viewMode==='wysiwyg'&&editorRef.current){const addResizeHandlesToImage=img=>{var _img$parentElement;// Exposer la fonction pour r√©utilisation\neditorRef.current.addResizeHandlesToImage=addResizeHandlesToImage;// Toutes les images sont trait√©es normalement\n// V√©rifier si d√©j√† trait√©\nif(img.getAttribute('data-resizable')||(_img$parentElement=img.parentElement)!==null&&_img$parentElement!==void 0&&_img$parentElement.classList.contains('resizable-image')){return;}// Attendre que l'image soit charg√©e\nif(!img.complete||img.naturalWidth===0){img.addEventListener('load',()=>addResizeHandlesToImage(img),{once:true});return;}img.setAttribute('data-resizable','true');// Wrapper l'image dans un conteneur redimensionnable\nconst wrapper=document.createElement('div');wrapper.className='resizable-image';// Ajouter gestionnaire de clic pour s√©lection d'image\nimg.addEventListener('click',e=>{e.stopPropagation();if(onImageClick){onImageClick(img);}});// Extraire les dimensions depuis le style inline ou les attributs\nlet currentWidth,currentHeight;// Priorit√© 1: attributs HTML (ex: width=\"300px\")\nconst attrWidth=img.getAttribute('width');const attrHeight=img.getAttribute('height');// Priorit√© 2: style inline (ex: style=\"width: 300px\")\nconst styleWidth=img.style.width;const styleHeight=img.style.height;if(attrWidth&&attrHeight){currentWidth=parseInt(attrWidth);currentHeight=parseInt(attrHeight);console.log('üìè Dimensions depuis attributs:',currentWidth,'x',currentHeight);}else if(styleWidth&&styleHeight){currentWidth=parseInt(styleWidth);currentHeight=parseInt(styleHeight);console.log('üìè Dimensions depuis style:',currentWidth,'x',currentHeight);}else{// Fallback: dimensions naturelles\ncurrentWidth=img.naturalWidth||300;currentHeight=img.naturalHeight||200;console.log('üìè Dimensions naturelles:',currentWidth,'x',currentHeight);}// Limiter la hauteur maximale √† 300px en pr√©servant le ratio d'aspect\nconst MAX_HEIGHT=300;if(currentHeight>MAX_HEIGHT){const aspectRatio=currentWidth/currentHeight;currentHeight=MAX_HEIGHT;currentWidth=Math.round(currentHeight*aspectRatio);console.log('üîÑ Image redimensionn√©e pour hauteur max 300px:',currentWidth,'x',currentHeight);// Appliquer les nouvelles dimensions √† l'image\nimg.setAttribute('width',currentWidth+'px');img.setAttribute('height',currentHeight+'px');img.style.width=currentWidth+'px';img.style.height=currentHeight+'px';}wrapper.style.width=currentWidth+'px';wrapper.style.height=currentHeight+'px';// Ins√©rer le wrapper\nimg.parentNode.insertBefore(wrapper,img);wrapper.appendChild(img);// Cr√©er les 4 poign√©es\n['nw','ne','sw','se'].forEach(corner=>{const handle=document.createElement('div');handle.className=\"resize-handle \".concat(corner);handle.dataset.corner=corner;handle.addEventListener('mousedown',e=>{e.preventDefault();e.stopPropagation();const startX=e.clientX;const startY=e.clientY;const startWidth=wrapper.offsetWidth;const startHeight=wrapper.offsetHeight;const aspectRatio=startWidth/startHeight;const handleMouseMove=e=>{const deltaX=e.clientX-startX;const deltaY=e.clientY-startY;let newWidth=startWidth;let newHeight=startHeight;// Calculer les nouvelles dimensions selon le coin\nswitch(corner){case'se':// Sud-Est\nnewWidth=Math.max(50,startWidth+deltaX);newHeight=newWidth/aspectRatio;break;case'sw':// Sud-Ouest\nnewWidth=Math.max(50,startWidth-deltaX);newHeight=newWidth/aspectRatio;break;case'ne':// Nord-Est\nnewWidth=Math.max(50,startWidth+deltaX);newHeight=newWidth/aspectRatio;break;case'nw':// Nord-Ouest\nnewWidth=Math.max(50,startWidth-deltaX);newHeight=newWidth/aspectRatio;break;}// Appliquer les nouvelles dimensions\nwrapper.style.width=newWidth+'px';wrapper.style.height=newHeight+'px';img.style.width='100%';img.style.height='100%';// Ajouter les attributs HTML width/height pour persistance lors des conversions\nimg.setAttribute('width',Math.round(newWidth)+'px');img.setAttribute('height',Math.round(newHeight)+'px');};const handleMouseUp=()=>{document.removeEventListener('mousemove',handleMouseMove);document.removeEventListener('mouseup',handleMouseUp);// D√©clencher l'√©v√©nement de changement pour sauvegarder\nif(onInput){const event=new Event('input',{bubbles:true});editorRef.current.dispatchEvent(event);}};document.addEventListener('mousemove',handleMouseMove);document.addEventListener('mouseup',handleMouseUp);});wrapper.appendChild(handle);});};// Observer pour d√©tecter les nouvelles images\nconst handleMutation=mutations=>{mutations.forEach(mutation=>{mutation.addedNodes.forEach(node=>{if(node.nodeName==='IMG'){addResizeHandlesToImage(node);}else if(node.querySelectorAll){node.querySelectorAll('img').forEach(addResizeHandlesToImage);}});});};const observer=new MutationObserver(handleMutation);observer.observe(editorRef.current,{childList:true,subtree:true});// Traiter les images existantes\neditorRef.current.querySelectorAll('img').forEach(addResizeHandlesToImage);return()=>observer.disconnect();}},[viewMode,onInput,content]);// Effect supprim√© - La gestion des poign√©es est maintenant dans l'effect pr√©c√©dent\n// Rendu conditionnel avec switch/case pour garantir une seule vue\nconsole.log('üîÑ Editor.js - Rendu switch/case, viewMode:',viewMode);switch(viewMode){case'wysiwyg':console.log('üéØ SWITCH - Vue WYSIWYG');return/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"style\",{children:\"\\n            .editor-content h1 { \\n              font-size: 2em; \\n              font-weight: bold; \\n              margin: 0.67em 0; \\n              line-height: 1.2;\\n            }\\n            .editor-content h2 { \\n              font-size: 1.5em; \\n              font-weight: bold; \\n              margin: 0.75em 0; \\n              line-height: 1.3;\\n            }\\n            .editor-content h3 { \\n              font-size: 1.17em; \\n              font-weight: bold; \\n              margin: 0.83em 0; \\n              line-height: 1.4;\\n            }\\n            .editor-content p {\\n              margin: 0.5em 0;\\n            }\\n            .editor-content ul {\\n              margin: 0.5em 0;\\n              padding-left: 2em;\\n              list-style-type: disc;\\n            }\\n            .editor-content ol {\\n              margin: 0.5em 0;\\n              padding-left: 2em;\\n              list-style-type: decimal;\\n            }\\n            .editor-content ol[style*=\\\"lower-alpha\\\"] {\\n              list-style-type: lower-alpha;\\n            }\\n            .editor-content li {\\n              margin: 0.25em 0;\\n            }\\n            \\n            /* Styles pour images redimensionnables */\\n            .editor-content img {\\n              max-width: 100%;\\n              height: auto;\\n              position: relative;\\n              cursor: pointer;\\n            }\\n            \\n            .resizable-image {\\n              position: relative;\\n              display: inline-block;\\n              border: 2px solid transparent;\\n            }\\n            \\n            .resizable-image:hover {\\n              border: 2px solid #3b82f6;\\n            }\\n            \\n            /* Style pour image s\\xE9lectionn\\xE9e - SOLUTION RADICALE */\\n            .image-selected {\\n              position: relative;\\n            }\\n            \\n            .image-selected::after {\\n              content: '';\\n              position: absolute;\\n              top: -4px;\\n              left: -4px;\\n              right: -4px;\\n              bottom: -4px;\\n              border: 4px solid #1d4ed8;\\n              box-shadow: 0 0 0 3px rgba(29, 78, 216, 0.3), 0 0 12px rgba(29, 78, 216, 0.4);\\n              background: rgba(29, 78, 216, 0.05);\\n              outline: 2px solid #ffffff;\\n              outline-offset: 2px;\\n              pointer-events: none;\\n              z-index: 1;\\n            }\\n            \\n            .resizable-image img {\\n              width: 100%;\\n              height: 100%;\\n              display: block;\\n              position: relative;\\n              z-index: 0;\\n            }\\n            \\n            .resizable-image .resize-handle {\\n              position: absolute;\\n              width: 10px;\\n              height: 10px;\\n              background: #3b82f6;\\n              border: 2px solid white;\\n              border-radius: 50%;\\n              opacity: 0;\\n              cursor: nw-resize;\\n              transition: opacity 0.2s;\\n            }\\n            \\n            .resizable-image:hover .resize-handle,\\n            .image-selected .resize-handle {\\n              opacity: 1;\\n            }\\n            \\n            .resize-handle.nw { top: -2px; left: -2px; cursor: nw-resize; }\\n            .resize-handle.ne { top: -2px; right: -2px; cursor: ne-resize; }\\n            .resize-handle.sw { bottom: -2px; left: -2px; cursor: sw-resize; }\\n            .resize-handle.se { bottom: -2px; right: -2px; cursor: se-resize; }\\n          \"}),/*#__PURE__*/_jsx(\"div\",{ref:el=>{editorRef.current=el;},contentEditable:\"true\",suppressContentEditableWarning:true,spellCheck:false,onInput:e=>{console.log('üéØ WYSIWYG onInput d√©clench√©!');handleWysiwygChange(e);},onKeyUp:e=>{console.log('‚å®Ô∏è WYSIWYG onKeyUp d√©clench√©! Touche:',e.key);handleWysiwygChange(e);},onPaste:e=>{console.log('üìã WYSIWYG onPaste d√©clench√©!');setTimeout(()=>handleWysiwygChange(e),10);// D√©lai pour laisser le paste s'appliquer\n},onMouseUp:e=>{console.log('üñ±Ô∏è WYSIWYG onMouseUp - S√©lection chang√©e - ignoreFlag:',ignoreSelectionChangeRef===null||ignoreSelectionChangeRef===void 0?void 0:ignoreSelectionChangeRef.current);if(onSelectionChange&&!(ignoreSelectionChangeRef!==null&&ignoreSelectionChangeRef!==void 0&&ignoreSelectionChangeRef.current)){console.log('‚úÖ EDITOR onMouseUp - VA APPELER onSelectionChange dans 10ms');setTimeout(onSelectionChange,10);}else{console.log('‚ùå EDITOR onMouseUp - onSelectionChange BLOQU√â');}},onKeyDown:e=>{// Protection contre les √©v√©nements undefined\nif(!e||!e.key){console.warn('‚ö†Ô∏è √âv√©nement onKeyDown invalide:',e);return;}console.log('üîΩ WYSIWYG onKeyDown d√©clench√©! Touche:',e.key);// Gestion des touches pour les images s√©lectionn√©es\nif(selectedImage){if(e.key==='Delete'||e.key==='Backspace'){e.preventDefault();// Supprimer l'image directement\nconst wrapper=selectedImage.closest('.resizable-image');const elementToRemove=wrapper||selectedImage;elementToRemove.remove();// D√©s√©lectionner l'image\nif(onImageClick){onImageClick(null);}// D√©clencher la sauvegarde\nif(onInput){const event=new Event('input',{bubbles:true});editorRef.current.dispatchEvent(event);}return;}else if(e.key==='Enter'){e.preventDefault();// Ins√©rer une nouvelle ligne apr√®s l'image s√©lectionn√©e\nconst wrapper=selectedImage.closest('.resizable-image');if(wrapper){const newParagraph=document.createElement('p');newParagraph.innerHTML='<br>';wrapper.parentNode.insertBefore(newParagraph,wrapper.nextSibling);console.log('üìç ENTER Image - Cr√©ation du paragraphe:',newParagraph);// Attendre que tous les √©v√©nements (onInput, handleWysiwygChange, etc.) se stabilisent\nsetTimeout(()=>{var _editorRef$current7;console.log('üìç ENTER Image - Positionnement curseur APR√àS stabilisation');const selection=window.getSelection();const range=document.createRange();console.log('üìç ENTER Image - Selection avant (delayed):',selection.rangeCount);// Positionner au d√©but du paragraphe\nrange.setStart(newParagraph,0);range.collapse(true);console.log('üìç ENTER Image - Range (delayed) startContainer:',range.startContainer);console.log('üìç ENTER Image - Range (delayed) startOffset:',range.startOffset);selection.removeAllRanges();selection.addRange(range);console.log('üìç ENTER Image - Selection (delayed) apr√®s:',selection.rangeCount);// Focus pour s'assurer que le curseur est visible\n(_editorRef$current7=editorRef.current)===null||_editorRef$current7===void 0?void 0:_editorRef$current7.focus();console.log('üìç ENTER Image - Positionnement termin√© avec succ√®s!');},100);// D√©lai pour laisser les √©v√©nements se stabiliser\n// D√©clencher la sauvegarde\nif(onInput){const event=new Event('input',{bubbles:true});editorRef.current.dispatchEvent(event);}// D√©s√©lectionner l'image\nif(onImageClick){onImageClick(null);}}return;}}// Mise √† jour du formatage pour les touches de navigation\nif(e&&e.key&&(e.key==='ArrowUp'||e.key==='ArrowDown'||e.key==='ArrowLeft'||e.key==='ArrowRight')){setTimeout(()=>{console.log('üîº EDITOR onKeyDown Navigation - ignoreFlag:',ignoreSelectionChangeRef===null||ignoreSelectionChangeRef===void 0?void 0:ignoreSelectionChangeRef.current);if(onSelectionChange&&!(ignoreSelectionChangeRef!==null&&ignoreSelectionChangeRef!==void 0&&ignoreSelectionChangeRef.current)){console.log('‚úÖ EDITOR Navigation - VA APPELER onSelectionChange');onSelectionChange();}else{console.log('‚ùå EDITOR Navigation - onSelectionChange BLOQU√â');}},10);}},onFocus:e=>{console.log('üîç WYSIWYG onFocus - Mise √† jour formatage - ignoreFlag:',ignoreSelectionChangeRef===null||ignoreSelectionChangeRef===void 0?void 0:ignoreSelectionChangeRef.current);if(onSelectionChange&&!(ignoreSelectionChangeRef!==null&&ignoreSelectionChangeRef!==void 0&&ignoreSelectionChangeRef.current)){console.log('‚úÖ EDITOR onFocus - VA APPELER onSelectionChange dans 10ms');setTimeout(onSelectionChange,10);}else{console.log('‚ùå EDITOR onFocus - onSelectionChange BLOQU√â');}},onChange:e=>{console.log('üîÑ onChange d√©clench√©!');},onClick:onEditorClick,style:{minHeight:'384px',outline:'none',padding:'20px',lineHeight:'var(--dys-line-height)',fontFamily:'var(--dys-font-family)',fontSize:'var(--dys-font-size)',color:'var(--dys-text-color)',backgroundColor:'var(--dys-bg-color)',overflow:'auto',wordWrap:'break-word',whiteSpace:'pre-wrap',border:'1px solid #e5e7eb'}})]},\"wysiwyg\");case'markdown':{console.log('üìù SWITCH - Vue MARKDOWN');const displayContent=content;return/*#__PURE__*/_jsx(\"div\",{className:\"relative\",children:/*#__PURE__*/_jsx(\"textarea\",{ref:el=>{if(editorRef)editorRef.current=el;},value:displayContent,onChange:e=>{const newValue=e.target.value;const originalContent=content;if(newValue!==originalContent){onInput(_objectSpread(_objectSpread({},e),{},{target:_objectSpread(_objectSpread({},e.target),{},{value:newValue})}));}},spellCheck:false,className:\"editor-content p-2 w-full h-full border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none\",style:{fontFamily:'var(--dys-font-family)',fontSize:'var(--dys-font-size)',lineHeight:'var(--dys-line-height)',color:'var(--dys-text-color)',backgroundColor:'var(--dys-bg-color)',overflow:'auto',wordWrap:'break-word',whiteSpace:'pre-wrap',paddingBottom:'2rem'},placeholder:\"\\xC9crivez en Markdown... # Titre 1\\n## Titre 2\\n### Titre 3 **Gras** *Italique* - Liste \\xE0 puces\\n1. Liste num\\xE9rot\\xE9e\\na. Liste alphab\\xE9tique $E = mc^2$ (formule inline)\\n$$\\\\\\\\int_{-\\\\\\\\infty}^{\\\\\\\\infty} e^{-x^2} dx = \\\\\\\\sqrt{\\\\\\\\pi}$$ (formule block)\"})},\"markdown\");}case'html':{console.log('üîß SWITCH - Vue HTML');const htmlDisplayContent=formatHtmlForSource(content);return/*#__PURE__*/_jsx(\"div\",{className:\"relative\",children:/*#__PURE__*/_jsx(\"textarea\",{ref:el=>{if(editorRef)editorRef.current=el;},value:htmlDisplayContent,onChange:e=>{const newValue=e.target.value;const originalWithCollapse=formatHtmlForSource(content);if(newValue!==originalWithCollapse){onInput(_objectSpread(_objectSpread({},e),{},{target:_objectSpread(_objectSpread({},e.target),{},{value:newValue})}));}},className:\"editor-content p-2 w-full h-full border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none\",style:{fontFamily:'Monaco, \"Cascadia Code\", \"Roboto Mono\", monospace',overflow:'auto',wordWrap:'break-word',whiteSpace:'pre-wrap',border:'1px solid #e5e7eb',paddingBottom:'2rem'},placeholder:\"Code source HTML...\"})},\"html\");}default:console.log('‚ùå SWITCH - AUCUNE VUE CORRESPONDANTE, viewMode:',viewMode);return null;}});export default Editor;","map":{"version":3,"names":["React","useCallback","useEffect","useRef","forwardRef","convertAllPromptoDysUrlsToBlobs","getCurrentProject","loadImage","saveImage","requestPersistentStorage","jsx","_jsx","jsxs","_jsxs","Editor","_ref","ref","content","setContent","viewMode","onInput","currentFormat","onFormatChange","mathJaxReady","ignoreSelectionChangeRef","selectedImage","onImageClick","onEditorClick","onDeleteSelectedImage","onSelectionChange","storeBlobForUrl","editorRef","isInitializedRef","previousContentRef","createUniqueBlob","file","uniqueId","concat","Date","now","Math","random","toString","substr","uniqueName","name","uniqueFile","File","type","blobUrl","URL","createObjectURL","console","log","processImageBlobs","container","blobImages","querySelectorAll","length","img","originalUrl","src","response","fetch","blob","error","base64Images","dataUrl","timestamp","toISOString","replace","slice","filename","imageId","crypto","randomUUID","setAttribute","substring","rehydrateImages","warn","images","getAttribute","objectUrl","width","height","alt","oldSrc","newSrc","migrateOldBlobImages","oldImages","oldBlobUrl","ok","status","size","round","fileName","newObjectUrl","revokeObjectURL","revokeError","oldUrl","newImageId","innerHTML","event","Event","bubbles","dispatchEvent","handleTextareaResize","textarea","style","max","scrollHeight","initImageSystem","current","rehydrationDelay","process","env","NODE_ENV","setTimeout","formatHtmlForSource","html","indentLevel","indentSize","match","startsWith","result","repeat","split","map","line","index","trim","currentIndent","join","handleWysiwygChange","e","cleanContent","newContent","target","handleSelectionChange","document","activeElement","initializeContent","hasFocus","hasSelection","window","getSelection","rangeCount","currentProject","displayContent","directory","MathJax","typesetPromise","catch","err","_editorRef$current","_editorRef$current2","addResizeHandlesToImage","forEach","removeAttribute","existingWrapper","closest","parent","parentNode","insertBefore","remove","handleCopy","tempDiv","createElement","clonedImg","cloneNode","appendChild","clipboardData","setData","preventDefault","selection","range","getRangeAt","selectedContent","cloneContents","htmlContent","textContent","handlePaste","newImages","_editorRef$current3","_editorRef$current4","addEventListener","_editorRef$current5","_editorRef$current6","removeEventListener","allImages","wrapper","classList","add","_img$parentElement","parentElement","contains","complete","naturalWidth","once","className","stopPropagation","currentWidth","currentHeight","attrWidth","attrHeight","styleWidth","styleHeight","parseInt","naturalHeight","MAX_HEIGHT","aspectRatio","corner","handle","dataset","startX","clientX","startY","clientY","startWidth","offsetWidth","startHeight","offsetHeight","handleMouseMove","deltaX","deltaY","newWidth","newHeight","handleMouseUp","handleMutation","mutations","mutation","addedNodes","node","nodeName","observer","MutationObserver","observe","childList","subtree","disconnect","children","el","contentEditable","suppressContentEditableWarning","spellCheck","onKeyUp","key","onPaste","onMouseUp","onKeyDown","elementToRemove","newParagraph","nextSibling","_editorRef$current7","createRange","setStart","collapse","startContainer","startOffset","removeAllRanges","addRange","focus","onFocus","onChange","onClick","minHeight","outline","padding","lineHeight","fontFamily","fontSize","color","backgroundColor","overflow","wordWrap","whiteSpace","border","value","newValue","originalContent","_objectSpread","paddingBottom","placeholder","htmlDisplayContent","originalWithCollapse"],"sources":["C:/Users/JEAN-NOELLEFEBVRE-SA/CascadeProjects/editor/src/components/Editor.js"],"sourcesContent":["import React, { useCallback, useEffect, useRef, forwardRef } from 'react';\nimport { convertAllPromptoDysUrlsToBlobs, getCurrentProject } from '../utils/promptoDysManager';\nimport { loadImage, saveImage, requestPersistentStorage } from '../utils/imageStore';\n\nconst Editor = forwardRef(({ \n  content, \n  setContent, \n  viewMode, \n  onInput, \n  currentFormat, \n  onFormatChange, \n  mathJaxReady, \n  ignoreSelectionChangeRef,\n  selectedImage,\n  onImageClick,\n  onEditorClick,\n  onDeleteSelectedImage,\n  onSelectionChange,\n  storeBlobForUrl,\n  editorRef\n}, ref) => {\n  \n  \n  // Utilise editorRef pass√©e en props (pas de ref locale)\n  const isInitializedRef = useRef(false);\n  const previousContentRef = useRef('');\n  \n  // Fonction pour cr√©er des blobs uniques (mutualisation avec Toolbar)\n  const createUniqueBlob = useCallback((file, storeBlobForUrl) => {\n    const uniqueId = `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n    const uniqueName = `${uniqueId}_${file.name}`;\n    const uniqueFile = new File([file], uniqueName, { type: file.type });\n    const blobUrl = URL.createObjectURL(uniqueFile);\n    \n    console.log('üéØ [createUniqueBlob] Cr√©ation blob unique:', uniqueName, '->', blobUrl);\n    storeBlobForUrl(blobUrl, uniqueFile);\n    \n    return { blobUrl, uniqueFile };\n  }, []);\n\n  // Fonction mutualis√©e pour traiter les images coll√©es et les rendre uniques\n  const processImageBlobs = useCallback(async (container, storeBlobForUrl) => {\n    console.log('üîÑ [processImageBlobs] Traitement des images...');\n    \n    // Traiter les images blob: temporaires\n    const blobImages = container.querySelectorAll('img[src^=\"blob:\"]');\n    console.log('üîç [processImageBlobs] Images blob trouv√©es:', blobImages.length);\n    \n    for (const img of blobImages) {\n      const originalUrl = img.src;\n      \n      try {\n        console.log('üì• [processImageBlobs] Traitement blob:', originalUrl);\n        \n        // R√©cup√©rer le blob original\n        const response = await fetch(originalUrl);\n        const blob = await response.blob();\n        \n        // Cr√©er un nouveau File avec un nom unique\n        const file = new File([blob], 'pasted-image.png', { type: blob.type });\n        const { blobUrl } = createUniqueBlob(file, storeBlobForUrl);\n        \n        // Remplacer l'URL dans l'image\n        img.src = blobUrl;\n        console.log('‚úÖ [processImageBlobs] Image blob mise √† jour:', originalUrl, '->', blobUrl);\n        \n      } catch (error) {\n        console.error('‚ùå [processImageBlobs] Erreur blob pour:', originalUrl, error);\n      }\n    }\n    \n    // Traiter les images base64 coll√©es (copie d'√©cran Windows)\n    const base64Images = container.querySelectorAll('img[src^=\"data:image/\"]');\n    console.log('üîç [processImageBlobs] Images base64 trouv√©es:', base64Images.length);\n    \n    for (const img of base64Images) {\n      const dataUrl = img.src;\n      \n      try {\n        console.log('üì• [processImageBlobs] Traitement base64 (longueur:', dataUrl.length, 'chars)');\n        \n        // Convertir data URL en blob\n        const response = await fetch(dataUrl);\n        const blob = await response.blob();\n        \n        // G√©n√©rer nom de fichier unique\n        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);\n        const filename = `pasted-screenshot-${timestamp}.png`;\n        \n        // G√©n√©rer ID unique et stocker dans IndexedDB\n        const imageId = crypto.randomUUID();\n        await saveImage(imageId, blob);\n        \n        // Cr√©er blob URL temporaire pour affichage\n        const blobUrl = URL.createObjectURL(blob);\n        \n        // Stocker le mapping URL->File pour compatibilit√©\n        const file = new File([blob], filename, { type: blob.type });\n        if (storeBlobForUrl) {\n          storeBlobForUrl(blobUrl, file);\n        }\n        \n        // Remplacer l'image base64 par blob + data-image-id\n        img.src = blobUrl;\n        img.setAttribute('data-image-id', imageId);\n        img.setAttribute('alt', filename);\n        \n        console.log('‚úÖ [processImageBlobs] Image base64 convertie:', dataUrl.substring(0, 50) + '...', '->', blobUrl, 'ID:', imageId);\n        \n      } catch (error) {\n        console.error('‚ùå [processImageBlobs] Erreur base64 pour:', dataUrl.substring(0, 50) + '...', error);\n      }\n    }\n  }, [createUniqueBlob]);\n\n  // Fonction de r√©hydratation des images depuis IndexedDB\n  const rehydrateImages = useCallback(async (container) => {\n    console.log('üîÑ [rehydrateImages] D√©but r√©hydratation des images...');\n    \n    if (!container) {\n      console.warn('‚ö†Ô∏è [rehydrateImages] Pas de conteneur fourni');\n      return;\n    }\n\n    // Trouver toutes les images avec data-image-id\n    const images = container.querySelectorAll('img[data-image-id]');\n    console.log(`üîç [rehydrateImages] ${images.length} images avec data-image-id trouv√©es`);\n\n    // Traiter chaque image\n    for (const img of images) {\n      const imageId = img.getAttribute('data-image-id');\n      console.log('üîÑ [rehydrateImages] Traitement image:', imageId);\n\n      try {\n        // Charger l'image depuis IndexedDB\n        const objectUrl = await loadImage(imageId);\n        \n        if (objectUrl) {\n          // Conserver les attributs existants\n          const width = img.getAttribute('width');\n          const height = img.getAttribute('height');\n          const alt = img.getAttribute('alt') || '';\n          \n          console.log('‚úÖ [rehydrateImages] Image charg√©e:', {\n            imageId,\n            oldSrc: img.src,\n            newSrc: objectUrl,\n            width,\n            height,\n            alt\n          });\n          \n          // Mettre √† jour la source\n          img.src = objectUrl;\n          \n          console.log('üéØ [rehydrateImages] Image r√©hydrat√©e avec succ√®s:', imageId);\n        } else {\n          console.warn('‚ö†Ô∏è [rehydrateImages] Image non trouv√©e en IndexedDB:', imageId);\n          // On garde l'image avec son data-image-id pour un essai ult√©rieur\n        }\n      } catch (error) {\n        console.error('‚ùå [rehydrateImages] Erreur r√©hydratation:', imageId, error);\n      }\n    }\n\n    console.log('‚úÖ [rehydrateImages] R√©hydratation termin√©e');\n  }, []);\n\n  // Fonction de migration des anciennes images blob: vers IndexedDB\n  const migrateOldBlobImages = useCallback(async (container) => {\n    console.log('üîÑ [migrateOldBlobImages] D√©but migration des anciennes images...');\n    \n    if (!container) {\n      console.warn('‚ö†Ô∏è [migrateOldBlobImages] Pas de conteneur fourni');\n      return;\n    }\n\n    // Trouver toutes les images avec src blob: SANS data-image-id (anciennes)\n    const oldImages = container.querySelectorAll('img[src^=\"blob:\"]:not([data-image-id])');\n    console.log(`üîç [migrateOldBlobImages] ${oldImages.length} anciennes images blob trouv√©es`);\n\n    if (oldImages.length === 0) {\n      console.log('‚úÖ [migrateOldBlobImages] Aucune migration n√©cessaire');\n      return;\n    }\n\n    // Traiter chaque ancienne image\n    for (const img of oldImages) {\n      const oldBlobUrl = img.src;\n      console.log('üîÑ [migrateOldBlobImages] Migration image:', oldBlobUrl);\n\n      try {\n        // R√©cup√©rer le blob depuis l'URL\n        const response = await fetch(oldBlobUrl);\n        if (!response.ok) {\n          console.warn('‚ö†Ô∏è [migrateOldBlobImages] Impossible de r√©cup√©rer le blob:', response.status);\n          continue;\n        }\n        \n        const blob = await response.blob();\n        console.log('üì¶ [migrateOldBlobImages] Blob r√©cup√©r√©:', {\n          size: `${Math.round(blob.size/1024)}KB`,\n          type: blob.type\n        });\n\n        // Cr√©er un File pour saveImage()\n        const fileName = img.alt || `migrated_image_${Date.now()}.png`;\n        const file = new File([blob], fileName, { type: blob.type });\n        \n        // Sauvegarder en IndexedDB\n        const imageId = await saveImage(file);\n        console.log('üíæ [migrateOldBlobImages] Image migr√©e vers IndexedDB:', imageId);\n        \n        // Mettre √† jour l'√©l√©ment img avec data-image-id\n        img.setAttribute('data-image-id', imageId);\n        \n        // Cr√©er nouvelle Object URL\n        const newObjectUrl = URL.createObjectURL(blob);\n        img.src = newObjectUrl;\n        \n        // R√©voquer l'ancienne URL si possible\n        try {\n          URL.revokeObjectURL(oldBlobUrl);\n          console.log('üßπ [migrateOldBlobImages] Ancienne URL r√©voqu√©e:', oldBlobUrl);\n        } catch (revokeError) {\n          console.warn('‚ö†Ô∏è [migrateOldBlobImages] Impossible de r√©voquer ancienne URL:', revokeError);\n        }\n        \n        console.log('‚úÖ [migrateOldBlobImages] Image migr√©e avec succ√®s:', {\n          oldUrl: oldBlobUrl,\n          newImageId: imageId,\n          fileName\n        });\n        \n      } catch (error) {\n        console.error('‚ùå [migrateOldBlobImages] Erreur migration:', oldBlobUrl, error);\n        // On garde l'ancienne image m√™me en cas d'erreur\n      }\n    }\n\n    console.log('‚úÖ [migrateOldBlobImages] Migration termin√©e');\n    \n    // D√©clencher une sauvegarde du contenu apr√®s migration\n    if (onInput && container.innerHTML) {\n      console.log('üíæ [migrateOldBlobImages] D√©clenchement sauvegarde apr√®s migration...');\n      const event = new Event('input', { bubbles: true });\n      container.dispatchEvent(event);\n    }\n  }, [onInput]);\n  \n  // Gestionnaire pour l'auto-redimensionnement (toujours d√©clar√©)\n  const handleTextareaResize = useCallback((textarea) => {\n    if (textarea) {\n      textarea.style.height = 'auto';\n      textarea.style.height = Math.max(384, textarea.scrollHeight) + 'px';\n    }\n  }, []);\n\n  // Effect pour la r√©hydratation des images au chargement\n  useEffect(() => {\n    console.log(' [Editor] Effect r√©hydratation - Chargement initial');\n    \n    const initImageSystem = async () => {\n      console.log(' [Editor] Demande stockage persistant...');\n      // Demander le stockage persistant\n      await requestPersistentStorage();\n      \n      // R√©hydrater les images si l'√©diteur est pr√™t\n      if (editorRef.current) {\n        console.log(' [Editor] D√©clenchement r√©hydratation...');\n        await rehydrateImages(editorRef.current);\n        \n        console.log(' [Editor] D√©clenchement migration anciennes images...');\n        await migrateOldBlobImages(editorRef.current);\n      } else {\n        console.warn(' [Editor] editorRef pas encore pr√™t pour r√©hydratation');\n      }\n    };\n    \n    initImageSystem();\n  }, [rehydrateImages, migrateOldBlobImages]);\n\n  // Effect pour r√©hydrater quand le contenu change (nouveau document charg√©)\n  useEffect(() => {\n    if (content && content !== previousContentRef.current && editorRef.current) {\n      console.log(' [Editor] Contenu chang√© - V√©rification r√©hydratation...');\n      previousContentRef.current = content;\n      \n      // D√©lai pour laisser le DOM se mettre √† jour (plus long en production)\n      const rehydrationDelay = process.env.NODE_ENV === 'production' ? 1000 : 100;\n      console.log(` [Editor] D√©lai r√©hydratation: ${rehydrationDelay}ms (env: ${process.env.NODE_ENV})`);\n      \n      setTimeout(async () => {\n        await rehydrateImages(editorRef.current);\n        await migrateOldBlobImages(editorRef.current);\n      }, rehydrationDelay);\n    }\n  }, [content, rehydrateImages, migrateOldBlobImages]);\n\n  // Fonction pour formater le HTML avec des retours √† la ligne et indentation\n  const formatHtmlForSource = useCallback((html) => {\n    let indentLevel = 0;\n    const indentSize = 2; // 2 espaces par niveau\n    \n    return html\n      .replace(/<br\\s*\\/?>/gi, '<br>\\n')\n      .replace(/<\\/?(h[1-6]|p|div|ul|ol|li|strong|em|span)[^>]*>/gi, (match) => {\n        if (match.startsWith('</')) {\n          // Balise fermante : diminuer l'indentation puis ajouter la balise\n          indentLevel = Math.max(0, indentLevel - 1);\n          return match + '\\n';\n        } else {\n          // Balise ouvrante : ajouter la balise puis augmenter l'indentation\n          const result = '\\n' + ' '.repeat(indentLevel * indentSize) + match;\n          // Augmenter l'indentation pour les balises conteneurs\n          if (match.match(/<(ul|ol|li|div|p|h[1-6])[^>]*>/i)) {\n            indentLevel++;\n          }\n          return result;\n        }\n      })\n      .split('\\n')\n      .map((line, index) => {\n        if (index === 0) return line.trim(); // Premi√®re ligne sans indentation\n        if (line.trim() === '') return ''; // Ligne vide\n        if (line.trim().startsWith('</')) {\n          // Balise fermante : r√©duire l'indentation\n          const currentIndent = Math.max(0, indentLevel - 1);\n          return ' '.repeat(currentIndent * indentSize) + line.trim();\n        }\n        // Contenu texte : utiliser l'indentation actuelle\n        return line.startsWith(' ') ? line : ' '.repeat(indentLevel * indentSize) + line.trim();\n      })\n      .join('\\n')\n      .replace(/^\\n+/, '') // Supprimer les retours √† la ligne en d√©but\n      .replace(/\\n{2,}/g, '\\n') // Supprimer toutes les lignes vides multiples\n      .trim();\n  }, []);\n\n  // Gestionnaire unifi√© WYSIWYG - connect√© directement √† onInput\n  const handleWysiwygChange = useCallback((e) => {\n    console.log('üìù handleWysiwygChange d√©clench√©');\n    \n    if (!editorRef.current) return;\n    \n    // Nettoyer les spans vides et les &nbsp; en trop\n    const cleanContent = (html) => {\n      return html\n        .replace(/<span(?![^>]*style=\"[^\"]*color:)[^>]*>\\s*<\\/span>/g, '') // Supprimer spans vides SAUF les spans color√©s\n        .replace(/(&nbsp;\\s*){2,}/g, '&nbsp;') // R√©duire les &nbsp; multiples\n        .replace(/<font[^>]*color=\"([^\"]*)\"[^>]*>(.*?)<\\/font>/g, '<span style=\"color: $1;\">$2</span>') // Convertir font en span\n        .replace(/<b\\b[^>]*>(.*?)<\\/b>/g, '<strong>$1</strong>') // Convertir b en strong\n        .replace(/<i\\b[^>]*>(.*?)<\\/i>/g, '<em>$1</em>'); // Convertir i en em\n    };\n    \n    const newContent = cleanContent(editorRef.current.innerHTML);\n    console.log('üîç Contenu actuel vs nouveau:', content.length, 'vs', newContent.length);\n    \n    // Appel direct vers onInput du hook useEditor\n    if (newContent !== content) {\n      console.log('‚úÖ WYSIWYG Changement - Appel onInput direct');\n      onInput({ target: { innerHTML: newContent } });\n    }\n    \n    // D√©clencher mise √† jour du formatage apr√®s un d√©lai\n    if (onSelectionChange && !ignoreSelectionChangeRef?.current) {\n      console.log('üîÑ EDITOR handleWysiwygChange - Va appeler onSelectionChange dans 50ms');\n      setTimeout(onSelectionChange, 50);\n    } else {\n      console.log('‚ùå EDITOR handleWysiwygChange - onSelectionChange BLOQU√â - ignoreFlag:', ignoreSelectionChangeRef?.current);\n    }\n  }, [content, onInput, onSelectionChange]);\n\n  // Gestionnaire pour les √©v√©nements de s√©lection/curseur\n  const handleSelectionChange = useCallback(() => {\n    console.log('üìç EDITOR handleSelectionChange - ignoreFlag:', ignoreSelectionChangeRef?.current);\n    if (ignoreSelectionChangeRef?.current) {\n      console.log('‚ùå EDITOR handleSelectionChange - BLOQU√â par ignoreFlag');\n      return;\n    }\n    if (viewMode === 'wysiwyg' && document.activeElement === editorRef.current) {\n      console.log('‚úÖ EDITOR handleSelectionChange - VA APPELER onSelectionChange');\n      onSelectionChange();\n    } else {\n      console.log('‚ö†Ô∏è EDITOR handleSelectionChange - SKIP conditions');\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [viewMode, onSelectionChange, ignoreSelectionChangeRef]);\n\n\n  // Initialiser le contenu uniquement si n√©cessaire\n  useEffect(() => {\n    const initializeContent = async () => {\n      if (viewMode === 'wysiwyg' && editorRef.current && editorRef.current.innerHTML !== content) {\n        // Ne pas modifier le contenu si l'utilisateur interagit activement\n        const hasFocus = document.activeElement === editorRef.current;\n        const hasSelection = window.getSelection().rangeCount > 0;\n        \n        // √âviter les mises √† jour pendant l'interaction utilisateur\n        if (hasFocus && hasSelection) {\n          return; // Ne pas perturber l'utilisateur\n        }\n        \n        // Convertir les URLs relatives PromptoDYS en Blob URLs pour affichage\n        const currentProject = getCurrentProject();\n        let displayContent = content;\n        \n        if (currentProject.directory) {\n          displayContent = await convertAllPromptoDysUrlsToBlobs(content, currentProject.directory);\n        }\n        \n        // Mise √† jour avec le contenu converti\n        editorRef.current.innerHTML = displayContent;\n        \n        // Re-rendre MathJax apr√®s mise √† jour du contenu\n        if (window.MathJax && window.MathJax.typesetPromise) {\n          window.MathJax.typesetPromise([editorRef.current]).catch((err) => {\n            console.warn('Erreur MathJax:', err);\n          });\n        }\n        \n        // SOLUTION F5: Forcer le retraitement des poign√©es apr√®s initialisation\n        setTimeout(() => {\n          console.log('üîÑ [F5 Fix] Retraitement forc√© des poign√©es d\\'images apr√®s initialisation');\n          const images = editorRef.current?.querySelectorAll('img');\n          if (images && editorRef.current?.addResizeHandlesToImage) {\n            images.forEach(img => {\n              // Retirer le marqueur data-resizable pour forcer le retraitement\n              img.removeAttribute('data-resizable');\n              // Retirer le wrapper s'il existe d√©j√†\n              const existingWrapper = img.closest('.resizable-image');\n              if (existingWrapper) {\n                const parent = existingWrapper.parentNode;\n                parent.insertBefore(img, existingWrapper);\n                existingWrapper.remove();\n              }\n              // Retraiter l'image\n              editorRef.current.addResizeHandlesToImage(img);\n            });\n            console.log('‚úÖ [F5 Fix] Poign√©es retrait√©es pour', images.length, 'image(s)');\n          }\n        }, 300); // D√©lai pour s'assurer que tout est bien initialis√©\n      }\n    };\n    \n    initializeContent();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [viewMode, content]);\n\n  // Gestionnaire pour la copie - convertir HTML en texte propre et g√©rer les images s√©lectionn√©es\n  const handleCopy = useCallback((e) => {\n    if (viewMode === 'wysiwyg' && editorRef.current) {\n      // Priorit√© 1: Si une image est s√©lectionn√©e, copier l'image\n      if (selectedImage) {\n        try {\n          // Cr√©er un √©l√©ment temporaire avec l'image\n          const tempDiv = document.createElement('div');\n          const clonedImg = selectedImage.cloneNode(true);\n          tempDiv.appendChild(clonedImg);\n          \n          // Copier au format HTML pour pr√©server la structure\n          e.clipboardData.setData('text/html', tempDiv.innerHTML);\n          // Copier aussi le src comme texte de fallback\n          e.clipboardData.setData('text/plain', selectedImage.src);\n          e.preventDefault();\n          return;\n        } catch (error) {\n          console.warn('Erreur copie image:', error);\n        }\n      }\n      \n      // Priorit√© 2: S√©lection de texte classique\n      const selection = window.getSelection();\n      if (selection.rangeCount > 0) {\n        const range = selection.getRangeAt(0);\n        const selectedContent = range.cloneContents();\n        const tempDiv = document.createElement('div');\n        tempDiv.appendChild(selectedContent);\n        \n        // Convertir HTML en texte avec retours √† la ligne pr√©serv√©s\n        const htmlContent = tempDiv.innerHTML;\n        const textContent = htmlContent\n          .replace(/<div[^>]*>/gi, '')\n          .replace(/<\\/div>/gi, '\\n')\n          .replace(/<br\\s*\\/?>/gi, '\\n')\n          .replace(/<p[^>]*>/gi, '')\n          .replace(/<\\/p>/gi, '\\n')\n          .replace(/<[^>]+>/g, '') // Supprimer toutes les autres balises\n          .replace(/&nbsp;/g, ' ')\n          .replace(/&amp;/g, '&')\n          .replace(/&lt;/g, '<')\n          .replace(/&gt;/g, '>')\n          .replace(/&quot;/g, '\"')\n          .replace(/&#39;/g, \"'\")\n          .replace(/\\n+$/, ''); // Supprimer les retours √† la ligne en fin\n        \n        // Mettre le texte propre dans le presse-papier\n        e.clipboardData.setData('text/plain', textContent);\n        e.preventDefault();\n      }\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [viewMode, selectedImage]);\n\n  // Gestionnaire pour forcer le refresh apr√®s coller\n  const handlePaste = useCallback((e) => {\n    if (viewMode === 'wysiwyg' && editorRef.current) {\n      // Attendre que le contenu soit coll√©\n      setTimeout(async () => {\n        console.log('üîÑ Refresh forc√© apr√®s coller');\n        \n        // Traiter les images coll√©es pour leur donner des URLs blob uniques\n        if (storeBlobForUrl) {\n          await processImageBlobs(editorRef.current, storeBlobForUrl);\n        }\n        \n        // Ajouter les poign√©es aux nouvelles images coll√©es\n        const newImages = editorRef.current.querySelectorAll('img:not([data-resizable])');\n        newImages.forEach(img => {\n          if (editorRef.current.addResizeHandlesToImage) {\n            editorRef.current.addResizeHandlesToImage(img);\n          }\n        });\n        \n        // D√©clencher sauvegarde\n        if (onInput) {\n          const event = new Event('input', { bubbles: true });\n          editorRef.current.dispatchEvent(event);\n        }\n      }, 100);\n    }\n  }, [viewMode, onInput]);\n\n  // √âcouter les changements de s√©lection, la copie et le coller\n  useEffect(() => {\n    if (viewMode === 'wysiwyg') {\n      document.addEventListener('selectionchange', handleSelectionChange);\n      editorRef.current?.addEventListener('copy', handleCopy);\n      editorRef.current?.addEventListener('paste', handlePaste);\n      \n      return () => {\n        document.removeEventListener('selectionchange', handleSelectionChange);\n        editorRef.current?.removeEventListener('copy', handleCopy);\n        editorRef.current?.removeEventListener('paste', handlePaste);\n      };\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [viewMode, handleSelectionChange, handleCopy, handlePaste]);\n\n  // Effect pour redimensionner au changement de contenu (toujours d√©clar√©)\n  useEffect(() => {\n    if (viewMode !== 'wysiwyg' && editorRef.current) {\n      handleTextareaResize(editorRef.current);\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [content, viewMode, handleTextareaResize]);\n\n\n\n// Supprim√© : useEffect d'initialisation qui causait l'√©crasement des execCommand\n\n// Effect pour appliquer le style de s√©lection d'image\nuseEffect(() => {\n  if (viewMode === 'wysiwyg' && editorRef.current) {\n    // Supprimer la classe de toutes les images\n    const allImages = editorRef.current.querySelectorAll('img');\n    allImages.forEach(img => {\n      const wrapper = img.closest('.resizable-image');\n      if (wrapper) {\n        wrapper.classList.remove('image-selected');\n      }\n    });\n\n    // Ajouter la classe √† l'image s√©lectionn√©e\n    if (selectedImage) {\n      const wrapper = selectedImage.closest('.resizable-image');\n      if (wrapper) {\n        wrapper.classList.add('image-selected');\n      }\n    }\n  }\n}, [selectedImage, viewMode, content]);\n\n  // Gestion des poign√©es de redimensionnement pour les images\n  useEffect(() => {\n    if (viewMode === 'wysiwyg' && editorRef.current) {\n      const addResizeHandlesToImage = (img) => {\n        // Exposer la fonction pour r√©utilisation\n        editorRef.current.addResizeHandlesToImage = addResizeHandlesToImage;\n        // Toutes les images sont trait√©es normalement\n        \n        // V√©rifier si d√©j√† trait√©\n        if (img.getAttribute('data-resizable') || img.parentElement?.classList.contains('resizable-image')) {\n          return;\n        }\n        \n        // Attendre que l'image soit charg√©e\n        if (!img.complete || img.naturalWidth === 0) {\n          img.addEventListener('load', () => addResizeHandlesToImage(img), { once: true });\n          return;\n        }\n        \n        img.setAttribute('data-resizable', 'true');\n        \n        // Wrapper l'image dans un conteneur redimensionnable\n        const wrapper = document.createElement('div');\n        wrapper.className = 'resizable-image';\n        \n        // Ajouter gestionnaire de clic pour s√©lection d'image\n        img.addEventListener('click', (e) => {\n          e.stopPropagation();\n          if (onImageClick) {\n            onImageClick(img);\n          }\n        });\n        \n        // Extraire les dimensions depuis le style inline ou les attributs\n        let currentWidth, currentHeight;\n        \n        // Priorit√© 1: attributs HTML (ex: width=\"300px\")\n        const attrWidth = img.getAttribute('width');\n        const attrHeight = img.getAttribute('height');\n        \n        // Priorit√© 2: style inline (ex: style=\"width: 300px\")\n        const styleWidth = img.style.width;\n        const styleHeight = img.style.height;\n        \n        if (attrWidth && attrHeight) {\n          currentWidth = parseInt(attrWidth);\n          currentHeight = parseInt(attrHeight);\n          console.log('üìè Dimensions depuis attributs:', currentWidth, 'x', currentHeight);\n        } else if (styleWidth && styleHeight) {\n          currentWidth = parseInt(styleWidth);\n          currentHeight = parseInt(styleHeight);\n          console.log('üìè Dimensions depuis style:', currentWidth, 'x', currentHeight);\n        } else {\n          // Fallback: dimensions naturelles\n          currentWidth = img.naturalWidth || 300;\n          currentHeight = img.naturalHeight || 200;\n          console.log('üìè Dimensions naturelles:', currentWidth, 'x', currentHeight);\n        }\n        \n        // Limiter la hauteur maximale √† 300px en pr√©servant le ratio d'aspect\n        const MAX_HEIGHT = 300;\n        if (currentHeight > MAX_HEIGHT) {\n          const aspectRatio = currentWidth / currentHeight;\n          currentHeight = MAX_HEIGHT;\n          currentWidth = Math.round(currentHeight * aspectRatio);\n          console.log('üîÑ Image redimensionn√©e pour hauteur max 300px:', currentWidth, 'x', currentHeight);\n          \n          // Appliquer les nouvelles dimensions √† l'image\n          img.setAttribute('width', currentWidth + 'px');\n          img.setAttribute('height', currentHeight + 'px');\n          img.style.width = currentWidth + 'px';\n          img.style.height = currentHeight + 'px';\n        }\n        \n        wrapper.style.width = currentWidth + 'px';\n        wrapper.style.height = currentHeight + 'px';\n          \n          // Ins√©rer le wrapper\n          img.parentNode.insertBefore(wrapper, img);\n          wrapper.appendChild(img);\n          \n          // Cr√©er les 4 poign√©es\n          ['nw', 'ne', 'sw', 'se'].forEach((corner) => {\n            const handle = document.createElement('div');\n            handle.className = `resize-handle ${corner}`;\n            handle.dataset.corner = corner;\n            \n            handle.addEventListener('mousedown', (e) => {\n              e.preventDefault();\n              e.stopPropagation();\n              \n              const startX = e.clientX;\n              const startY = e.clientY;\n              const startWidth = wrapper.offsetWidth;\n              const startHeight = wrapper.offsetHeight;\n              const aspectRatio = startWidth / startHeight;\n              \n              const handleMouseMove = (e) => {\n                const deltaX = e.clientX - startX;\n                const deltaY = e.clientY - startY;\n                \n                let newWidth = startWidth;\n                let newHeight = startHeight;\n                \n                // Calculer les nouvelles dimensions selon le coin\n                switch(corner) {\n                  case 'se': // Sud-Est\n                    newWidth = Math.max(50, startWidth + deltaX);\n                    newHeight = newWidth / aspectRatio;\n                    break;\n                  case 'sw': // Sud-Ouest\n                    newWidth = Math.max(50, startWidth - deltaX);\n                    newHeight = newWidth / aspectRatio;\n                    break;\n                  case 'ne': // Nord-Est\n                    newWidth = Math.max(50, startWidth + deltaX);\n                    newHeight = newWidth / aspectRatio;\n                    break;\n                  case 'nw': // Nord-Ouest\n                    newWidth = Math.max(50, startWidth - deltaX);\n                    newHeight = newWidth / aspectRatio;\n                    break;\n                }\n                \n                // Appliquer les nouvelles dimensions\n                wrapper.style.width = newWidth + 'px';\n                wrapper.style.height = newHeight + 'px';\n                img.style.width = '100%';\n                img.style.height = '100%';\n                \n                // Ajouter les attributs HTML width/height pour persistance lors des conversions\n                img.setAttribute('width', Math.round(newWidth) + 'px');\n                img.setAttribute('height', Math.round(newHeight) + 'px');\n              };\n              \n              const handleMouseUp = () => {\n                document.removeEventListener('mousemove', handleMouseMove);\n                document.removeEventListener('mouseup', handleMouseUp);\n                \n                // D√©clencher l'√©v√©nement de changement pour sauvegarder\n                if (onInput) {\n                  const event = new Event('input', { bubbles: true });\n                  editorRef.current.dispatchEvent(event);\n                }\n              };\n              \n              document.addEventListener('mousemove', handleMouseMove);\n              document.addEventListener('mouseup', handleMouseUp);\n            });\n            \n            wrapper.appendChild(handle);\n          });\n      };\n      \n      // Observer pour d√©tecter les nouvelles images\n      const handleMutation = (mutations) => {\n        mutations.forEach(mutation => {\n          mutation.addedNodes.forEach(node => {\n            if (node.nodeName === 'IMG') {\n              addResizeHandlesToImage(node);\n            } else if (node.querySelectorAll) {\n              node.querySelectorAll('img').forEach(addResizeHandlesToImage);\n            }\n          });\n        });\n      };\n      \n      const observer = new MutationObserver(handleMutation);\n      observer.observe(editorRef.current, {\n        childList: true,\n        subtree: true\n      });\n      \n      // Traiter les images existantes\n      editorRef.current.querySelectorAll('img').forEach(addResizeHandlesToImage);\n      \n      return () => observer.disconnect();\n    }\n  }, [viewMode, onInput, content]);\n  \n  // Effect supprim√© - La gestion des poign√©es est maintenant dans l'effect pr√©c√©dent\n\n  // Rendu conditionnel avec switch/case pour garantir une seule vue\n  console.log('üîÑ Editor.js - Rendu switch/case, viewMode:', viewMode);\n  \n  switch (viewMode) {\n    case 'wysiwyg':\n      console.log('üéØ SWITCH - Vue WYSIWYG');\n      return (\n        <div key=\"wysiwyg\">\n          <style>{`\n            .editor-content h1 { \n              font-size: 2em; \n              font-weight: bold; \n              margin: 0.67em 0; \n              line-height: 1.2;\n            }\n            .editor-content h2 { \n              font-size: 1.5em; \n              font-weight: bold; \n              margin: 0.75em 0; \n              line-height: 1.3;\n            }\n            .editor-content h3 { \n              font-size: 1.17em; \n              font-weight: bold; \n              margin: 0.83em 0; \n              line-height: 1.4;\n            }\n            .editor-content p {\n              margin: 0.5em 0;\n            }\n            .editor-content ul {\n              margin: 0.5em 0;\n              padding-left: 2em;\n              list-style-type: disc;\n            }\n            .editor-content ol {\n              margin: 0.5em 0;\n              padding-left: 2em;\n              list-style-type: decimal;\n            }\n            .editor-content ol[style*=\"lower-alpha\"] {\n              list-style-type: lower-alpha;\n            }\n            .editor-content li {\n              margin: 0.25em 0;\n            }\n            \n            /* Styles pour images redimensionnables */\n            .editor-content img {\n              max-width: 100%;\n              height: auto;\n              position: relative;\n              cursor: pointer;\n            }\n            \n            .resizable-image {\n              position: relative;\n              display: inline-block;\n              border: 2px solid transparent;\n            }\n            \n            .resizable-image:hover {\n              border: 2px solid #3b82f6;\n            }\n            \n            /* Style pour image s√©lectionn√©e - SOLUTION RADICALE */\n            .image-selected {\n              position: relative;\n            }\n            \n            .image-selected::after {\n              content: '';\n              position: absolute;\n              top: -4px;\n              left: -4px;\n              right: -4px;\n              bottom: -4px;\n              border: 4px solid #1d4ed8;\n              box-shadow: 0 0 0 3px rgba(29, 78, 216, 0.3), 0 0 12px rgba(29, 78, 216, 0.4);\n              background: rgba(29, 78, 216, 0.05);\n              outline: 2px solid #ffffff;\n              outline-offset: 2px;\n              pointer-events: none;\n              z-index: 1;\n            }\n            \n            .resizable-image img {\n              width: 100%;\n              height: 100%;\n              display: block;\n              position: relative;\n              z-index: 0;\n            }\n            \n            .resizable-image .resize-handle {\n              position: absolute;\n              width: 10px;\n              height: 10px;\n              background: #3b82f6;\n              border: 2px solid white;\n              border-radius: 50%;\n              opacity: 0;\n              cursor: nw-resize;\n              transition: opacity 0.2s;\n            }\n            \n            .resizable-image:hover .resize-handle,\n            .image-selected .resize-handle {\n              opacity: 1;\n            }\n            \n            .resize-handle.nw { top: -2px; left: -2px; cursor: nw-resize; }\n            .resize-handle.ne { top: -2px; right: -2px; cursor: ne-resize; }\n            .resize-handle.sw { bottom: -2px; left: -2px; cursor: sw-resize; }\n            .resize-handle.se { bottom: -2px; right: -2px; cursor: se-resize; }\n          `}</style>\n          <div\n            ref={(el) => { editorRef.current = el; }}\n            contentEditable=\"true\"\n            suppressContentEditableWarning={true}\n            spellCheck={false}\n            onInput={(e) => {\n              console.log('üéØ WYSIWYG onInput d√©clench√©!');\n              handleWysiwygChange(e);\n            }}\n            onKeyUp={(e) => {\n              console.log('‚å®Ô∏è WYSIWYG onKeyUp d√©clench√©! Touche:', e.key);\n              handleWysiwygChange(e);\n            }}\n            onPaste={(e) => {\n              console.log('üìã WYSIWYG onPaste d√©clench√©!');\n              setTimeout(() => handleWysiwygChange(e), 10); // D√©lai pour laisser le paste s'appliquer\n            }}\n            onMouseUp={(e) => {\n              console.log('üñ±Ô∏è WYSIWYG onMouseUp - S√©lection chang√©e - ignoreFlag:', ignoreSelectionChangeRef?.current);\n              if (onSelectionChange && !ignoreSelectionChangeRef?.current) {\n                console.log('‚úÖ EDITOR onMouseUp - VA APPELER onSelectionChange dans 10ms');\n                setTimeout(onSelectionChange, 10);\n              } else {\n                console.log('‚ùå EDITOR onMouseUp - onSelectionChange BLOQU√â');\n              }\n            }}\n            onKeyDown={(e) => {\n              // Protection contre les √©v√©nements undefined\n              if (!e || !e.key) {\n                console.warn('‚ö†Ô∏è √âv√©nement onKeyDown invalide:', e);\n                return;\n              }\n              \n              console.log('üîΩ WYSIWYG onKeyDown d√©clench√©! Touche:', e.key);\n              \n              // Gestion des touches pour les images s√©lectionn√©es\n              if (selectedImage) {\n                if (e.key === 'Delete' || e.key === 'Backspace') {\n                  e.preventDefault();\n                  // Supprimer l'image directement\n                  const wrapper = selectedImage.closest('.resizable-image');\n                  const elementToRemove = wrapper || selectedImage;\n                  elementToRemove.remove();\n                  \n                  // D√©s√©lectionner l'image\n                  if (onImageClick) {\n                    onImageClick(null);\n                  }\n                  \n                  // D√©clencher la sauvegarde\n                  if (onInput) {\n                    const event = new Event('input', { bubbles: true });\n                    editorRef.current.dispatchEvent(event);\n                  }\n                  return;\n                } else if (e.key === 'Enter') {\n                  e.preventDefault();\n                  // Ins√©rer une nouvelle ligne apr√®s l'image s√©lectionn√©e\n                  const wrapper = selectedImage.closest('.resizable-image');\n                  if (wrapper) {\n                    const newParagraph = document.createElement('p');\n                    newParagraph.innerHTML = '<br>';\n                    wrapper.parentNode.insertBefore(newParagraph, wrapper.nextSibling);\n                    \n                    console.log('üìç ENTER Image - Cr√©ation du paragraphe:', newParagraph);\n                    \n                    // Attendre que tous les √©v√©nements (onInput, handleWysiwygChange, etc.) se stabilisent\n                    setTimeout(() => {\n                      console.log('üìç ENTER Image - Positionnement curseur APR√àS stabilisation');\n                      \n                      const selection = window.getSelection();\n                      const range = document.createRange();\n                      \n                      console.log('üìç ENTER Image - Selection avant (delayed):', selection.rangeCount);\n                      \n                      // Positionner au d√©but du paragraphe\n                      range.setStart(newParagraph, 0);\n                      range.collapse(true);\n                      \n                      console.log('üìç ENTER Image - Range (delayed) startContainer:', range.startContainer);\n                      console.log('üìç ENTER Image - Range (delayed) startOffset:', range.startOffset);\n                      \n                      selection.removeAllRanges();\n                      selection.addRange(range);\n                      \n                      console.log('üìç ENTER Image - Selection (delayed) apr√®s:', selection.rangeCount);\n                      \n                      // Focus pour s'assurer que le curseur est visible\n                      editorRef.current?.focus();\n                      \n                      console.log('üìç ENTER Image - Positionnement termin√© avec succ√®s!');\n                    }, 100); // D√©lai pour laisser les √©v√©nements se stabiliser\n                    \n                    // D√©clencher la sauvegarde\n                    if (onInput) {\n                      const event = new Event('input', { bubbles: true });\n                      editorRef.current.dispatchEvent(event);\n                    }\n                    \n                    // D√©s√©lectionner l'image\n                    if (onImageClick) {\n                      onImageClick(null);\n                    }\n                  }\n                  return;\n                }\n              }\n              \n              // Mise √† jour du formatage pour les touches de navigation\n              if (e && e.key && (e.key === 'ArrowUp' || e.key === 'ArrowDown' || e.key === 'ArrowLeft' || e.key === 'ArrowRight')) {\n                setTimeout(() => {\n                  console.log('üîº EDITOR onKeyDown Navigation - ignoreFlag:', ignoreSelectionChangeRef?.current);\n                  if (onSelectionChange && !ignoreSelectionChangeRef?.current) {\n                    console.log('‚úÖ EDITOR Navigation - VA APPELER onSelectionChange');\n                    onSelectionChange();\n                  } else {\n                    console.log('‚ùå EDITOR Navigation - onSelectionChange BLOQU√â');\n                  }\n                }, 10);\n              }\n            }}\n            onFocus={(e) => {\n              console.log('üîç WYSIWYG onFocus - Mise √† jour formatage - ignoreFlag:', ignoreSelectionChangeRef?.current);\n              if (onSelectionChange && !ignoreSelectionChangeRef?.current) {\n                console.log('‚úÖ EDITOR onFocus - VA APPELER onSelectionChange dans 10ms');\n                setTimeout(onSelectionChange, 10);\n              } else {\n                console.log('‚ùå EDITOR onFocus - onSelectionChange BLOQU√â');\n              }\n            }}\n            onChange={(e) => {\n              console.log('üîÑ onChange d√©clench√©!');\n            }}\n            onClick={onEditorClick}\n            style={{\n              minHeight: '384px',\n              outline: 'none',\n              padding: '20px',\n              lineHeight: 'var(--dys-line-height)',\n              fontFamily: 'var(--dys-font-family)',\n              fontSize: 'var(--dys-font-size)',\n              color: 'var(--dys-text-color)',\n              backgroundColor: 'var(--dys-bg-color)',\n              overflow: 'auto',\n              wordWrap: 'break-word',\n              whiteSpace: 'pre-wrap',\n              border: '1px solid #e5e7eb',\n            }}\n          />\n        </div>\n      );\n\n    case 'markdown': {\n      console.log('üìù SWITCH - Vue MARKDOWN');\n      const displayContent = content;\n      \n      return (\n        <div key=\"markdown\" className=\"relative\">\n          <textarea\n            ref={(el) => {\n              if (editorRef) editorRef.current = el;\n            }}\n            value={displayContent}\n            onChange={(e) => {\n              const newValue = e.target.value;\n              const originalContent = content;\n              \n              if (newValue !== originalContent) {\n                onInput({ ...e, target: { ...e.target, value: newValue } });\n              }\n            }}\n            spellCheck={false}\n            className=\"editor-content p-2 w-full h-full border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none\"\n            style={{\n              fontFamily: 'var(--dys-font-family)',\n              fontSize: 'var(--dys-font-size)',\n              lineHeight: 'var(--dys-line-height)',\n              color: 'var(--dys-text-color)',\n              backgroundColor: 'var(--dys-bg-color)',\n              overflow: 'auto',\n              wordWrap: 'break-word',\n              whiteSpace: 'pre-wrap',\n              paddingBottom: '2rem'\n            }}\n            placeholder=\"√âcrivez en Markdown...\n\n# Titre 1\n## Titre 2\n### Titre 3\n\n**Gras** *Italique*\n\n- Liste √† puces\n1. Liste num√©rot√©e\na. Liste alphab√©tique\n\n$E = mc^2$ (formule inline)\n$$\\\\int_{-\\\\infty}^{\\\\infty} e^{-x^2} dx = \\\\sqrt{\\\\pi}$$ (formule block)\"\n          />\n        </div>\n      );\n    }\n\n    case 'html': {\n      console.log('üîß SWITCH - Vue HTML');\n      const htmlDisplayContent = formatHtmlForSource(content);\n    \n      return (\n        <div key=\"html\" className=\"relative\">\n          <textarea\n            ref={(el) => {\n              if (editorRef) editorRef.current = el;\n            }}\n            value={htmlDisplayContent}\n            onChange={(e) => {\n              const newValue = e.target.value;\n              const originalWithCollapse = formatHtmlForSource(content);\n              \n              if (newValue !== originalWithCollapse) {\n                onInput({ ...e, target: { ...e.target, value: newValue } });\n              }\n            }}\n            className=\"editor-content p-2 w-full h-full border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none\"\n            style={{ \n              fontFamily: 'Monaco, \"Cascadia Code\", \"Roboto Mono\", monospace',\n              overflow: 'auto',\n              wordWrap: 'break-word',\n              whiteSpace: 'pre-wrap',\n              border: '1px solid #e5e7eb',\n              paddingBottom: '2rem'\n            }}\n            placeholder=\"Code source HTML...\"\n          />\n        </div>\n      );\n    }\n\n    default:\n      console.log('‚ùå SWITCH - AUCUNE VUE CORRESPONDANTE, viewMode:', viewMode);\n      return null;\n  }\n});\n\nexport default Editor;\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}