{"ast":null,"code":"var _jsxFileName = \"C:\\\\Users\\\\JEAN-NOELLEFEBVRE-SA\\\\CascadeProjects\\\\editor\\\\src\\\\components\\\\Editor.js\",\n  _s = $RefreshSig$();\nimport React, { useCallback, useEffect, useState } from 'react';\nimport { detectBase64, applyBase64Collapse } from '../utils/base64Collapse';\nimport { convertAllPromptoDysUrlsToBlobs, getCurrentProject } from '../utils/promptoDysManager';\nimport { useImageStorage } from '../hooks/useImageStorage';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst Editor = ({\n  viewMode,\n  content,\n  editorRef,\n  onInput,\n  onSelectionChange,\n  currentFormat,\n  convertIndexedUrlsToBlob\n}) => {\n  _s();\n  // √âtat pour g√©rer l'expansion des donn√©es Base64\n  const [expandedBase64, setExpandedBase64] = useState({});\n\n  // √âtat pour g√©rer l'image actuellement s√©lectionn√©e\n  const [selectedImage, setSelectedImage] = useState(null);\n\n  // Hook pour g√©rer les images IndexedDB\n  const {\n    loadImage\n  } = useImageStorage();\n\n  // Gestionnaire pour l'auto-redimensionnement (toujours d√©clar√©)\n  const handleTextareaResize = useCallback(textarea => {\n    if (textarea) {\n      textarea.style.height = 'auto';\n      textarea.style.height = Math.max(384, textarea.scrollHeight) + 'px';\n    }\n  }, []);\n\n  // Gestionnaire pour toggle Base64\n  const handleBase64Toggle = useCallback(e => {\n    const clickedText = e.target.value;\n    const cursorPos = e.target.selectionStart;\n\n    // Chercher si on a cliqu√© sur un bouton \"üëÅÔ∏è Voir\"\n    const beforeCursor = clickedText.substring(Math.max(0, cursorPos - 100), cursorPos + 20);\n    const toggleMatch = beforeCursor.match(/üëÅÔ∏è Voir/);\n    if (toggleMatch) {\n      // Trouver l'index du Base64 correspondant\n      const base64Matches = detectBase64(content);\n\n      // Pour simplifier, on toggle le premier Base64 trouv√©\n      // Dans une version plus avanc√©e, on pourrait calculer l'index exact\n      if (base64Matches.length > 0) {\n        const toggleIndex = 0; // Simplifi√© pour cette version\n        setExpandedBase64(prev => ({\n          ...prev,\n          [toggleIndex]: !prev[toggleIndex]\n        }));\n      }\n    }\n  }, [content]);\n\n  // Fonction pour obtenir le contenu avec Base64 collaps√©s\n  const getCollapsedContent = useCallback(originalContent => {\n    if (viewMode === 'wysiwyg') {\n      return originalContent; // Pas de collapse en WYSIWYG\n    }\n    return applyBase64Collapse(originalContent, expandedBase64);\n  }, [viewMode, expandedBase64]);\n\n  // Fonction pour formater le HTML avec des retours √† la ligne et indentation\n  const formatHtmlForSource = useCallback(html => {\n    let indentLevel = 0;\n    const indentSize = 2; // 2 espaces par niveau\n\n    return html.replace(/<br\\s*\\/?>/gi, '<br>\\n').replace(/<\\/?(h[1-6]|p|div|ul|ol|li|strong|em|span)[^>]*>/gi, match => {\n      if (match.startsWith('</')) {\n        // Balise fermante : diminuer l'indentation puis ajouter la balise\n        indentLevel = Math.max(0, indentLevel - 1);\n        return match + '\\n';\n      } else {\n        // Balise ouvrante : ajouter la balise puis augmenter l'indentation\n        const result = '\\n' + ' '.repeat(indentLevel * indentSize) + match;\n        // Augmenter l'indentation pour les balises conteneurs\n        if (match.match(/<(ul|ol|li|div|p|h[1-6])[^>]*>/i)) {\n          indentLevel++;\n        }\n        return result;\n      }\n    }).split('\\n').map((line, index) => {\n      if (index === 0) return line.trim(); // Premi√®re ligne sans indentation\n      if (line.trim() === '') return ''; // Ligne vide\n      if (line.trim().startsWith('</')) {\n        // Balise fermante : r√©duire l'indentation\n        const currentIndent = Math.max(0, indentLevel - 1);\n        return ' '.repeat(currentIndent * indentSize) + line.trim();\n      }\n      // Contenu texte : utiliser l'indentation actuelle\n      return line.startsWith(' ') ? line : ' '.repeat(indentLevel * indentSize) + line.trim();\n    }).join('\\n').replace(/^\\n+/, '') // Supprimer les retours √† la ligne en d√©but\n    .replace(/\\n{2,}/g, '\\n') // Supprimer toutes les lignes vides multiples\n    .trim();\n  }, []);\n\n  // Gestionnaire pour s√©lectionner une image\n  const handleImageClick = useCallback((e, wrapper) => {\n    e.stopPropagation();\n\n    // D√©s√©lectionner l'ancienne image\n    if (selectedImage) {\n      selectedImage.classList.remove('selected-image');\n    }\n\n    // S√©lectionner la nouvelle image\n    wrapper.classList.add('selected-image');\n    setSelectedImage(wrapper);\n\n    // Cr√©er une s√©lection qui englobe tout le wrapper\n    const selection = window.getSelection();\n    const range = document.createRange();\n    range.selectNode(wrapper);\n    selection.removeAllRanges();\n    selection.addRange(range);\n    console.log('‚úÖ Image s√©lectionn√©e:', wrapper);\n  }, [selectedImage]);\n\n  // Gestionnaire pour d√©s√©lectionner les images\n  const handleDeselectImage = useCallback(() => {\n    if (selectedImage) {\n      selectedImage.classList.remove('selected-image');\n      setSelectedImage(null);\n      console.log('‚úÖ Image d√©s√©lectionn√©e');\n    }\n  }, [selectedImage]);\n\n  // Gestionnaire pour le coller - convertir automatiquement Markdown avec dimensions\n  const handlePaste = useCallback(e => {\n    if (viewMode === 'wysiwyg' && editorRef.current) {\n      // R√©cup√©rer le texte coll√©\n      const pastedText = e.clipboardData.getData('text/plain');\n\n      // Regex pour d√©tecter les images Markdown avec dimensions\n      const imageMarkdownRegex = /!\\[([^\\]]*)\\]\\(([^)]+)\\)\\{width=([^}\\s]+)\\s+height=([^}\\s]+)\\}/g;\n\n      // V√©rifier s'il y a des images Markdown avec dimensions\n      if (imageMarkdownRegex.test(pastedText)) {\n        e.preventDefault();\n\n        // Convertir toutes les images Markdown avec dimensions en HTML\n        const convertedHtml = pastedText.replace(imageMarkdownRegex, (match, alt, src, width, height) => {\n          // Nettoyer les valeurs de dimensions (retirer 'px' s'il est pr√©sent)\n          const widthValue = width.replace('px', '');\n          const heightValue = height.replace('px', '');\n          return `<img alt=\"${alt}\" src=\"${src}\" width=\"${widthValue}\" height=\"${heightValue}\" style=\"max-width: 100%; height: auto;\">`;\n        });\n\n        // Ins√©rer le HTML converti √† la position du curseur\n        const selection = window.getSelection();\n        if (selection.rangeCount > 0) {\n          const range = selection.getRangeAt(0);\n          range.deleteContents();\n\n          // Cr√©er un √©l√©ment temporaire pour parser le HTML\n          const tempDiv = document.createElement('div');\n          tempDiv.innerHTML = convertedHtml;\n\n          // Ins√©rer tous les noeuds convertis\n          while (tempDiv.firstChild) {\n            range.insertNode(tempDiv.firstChild);\n          }\n\n          // R√©initialiser la s√©lection apr√®s le contenu ins√©r√©\n          range.collapse(false);\n          selection.removeAllRanges();\n          selection.addRange(range);\n\n          // D√©clencher l'√©v√©nement de changement pour sauvegarder\n          if (onInput) {\n            const event = new Event('input', {\n              bubbles: true\n            });\n            editorRef.current.dispatchEvent(event);\n          }\n          console.log('‚úÖ Markdown avec dimensions converti:', convertedHtml);\n        }\n      }\n    }\n  }, [viewMode, onInput]);\n\n  // Gestionnaire pour les touches Delete/Backspace et Ctrl+X sur images s√©lectionn√©es\n  const handleKeyDown = useCallback(e => {\n    if (selectedImage) {\n      // Supprimer l'image avec Delete/Backspace\n      if (e.key === 'Delete' || e.key === 'Backspace') {\n        e.preventDefault();\n        e.stopPropagation();\n        selectedImage.remove();\n        setSelectedImage(null);\n\n        // D√©clencher l'√©v√©nement de changement pour sauvegarder\n        if (onInput) {\n          const event = new Event('input', {\n            bubbles: true\n          });\n          editorRef.current.dispatchEvent(event);\n        }\n        console.log('‚úÖ Image supprim√©e');\n      }\n\n      // Couper l'image avec Ctrl+X\n      if (e.ctrlKey && e.key === 'x') {\n        e.preventDefault();\n        e.stopPropagation();\n\n        // D'abord copier l'image avec ses dimensions en format Markdown\n        const img = selectedImage.querySelector('img');\n        if (img) {\n          // Extraire les dimensions du wrapper\n          const wrapperStyle = window.getComputedStyle(selectedImage);\n          const width = selectedImage.style.width || wrapperStyle.width;\n          const height = selectedImage.style.height || wrapperStyle.height;\n\n          // G√©n√©rer la syntaxe Markdown √©tendue avec dimensions\n          const alt = img.alt || 'Image';\n          const src = img.src;\n          let markdownText = `![${alt}](${src})`;\n\n          // Ajouter les dimensions si elles existent\n          if (width && width !== 'auto' && height && height !== 'auto') {\n            const widthValue = width.replace('px', '') + 'px';\n            const heightValue = height.replace('px', '') + 'px';\n            markdownText += `{width=${widthValue} height=${heightValue}}`;\n          }\n\n          // Cr√©er un √©l√©ment temporaire pour copier le texte\n          const tempTextArea = document.createElement('textarea');\n          tempTextArea.value = markdownText;\n          document.body.appendChild(tempTextArea);\n          tempTextArea.select();\n          document.execCommand('copy');\n          document.body.removeChild(tempTextArea);\n          console.log('‚úÖ Image coup√©e en Markdown:', markdownText);\n        }\n\n        // Supprimer l'image\n        selectedImage.remove();\n        setSelectedImage(null);\n\n        // D√©clencher l'√©v√©nement de changement pour sauvegarder\n        if (onInput) {\n          const event = new Event('input', {\n            bubbles: true\n          });\n          editorRef.current.dispatchEvent(event);\n        }\n      }\n    }\n  }, [selectedImage, onInput]);\n\n  // Gestionnaire unifi√© pour tous les changements\n  const handleChange = useCallback(e => {\n    if (viewMode === 'wysiwyg' && editorRef.current) {\n      // Nettoyer les spans vides et les &nbsp; en trop\n      const cleanContent = html => {\n        return html.replace(/<span(?![^>]*style=\"[^\"]*color:)[^>]*>\\s*<\\/span>/g, '') // Supprimer spans vides SAUF les spans color√©s\n        .replace(/(&nbsp;\\s*){2,}/g, '&nbsp;') // R√©duire les &nbsp; multiples\n        .replace(/<font[^>]*color=\"([^\"]*)\"[^>]*>(.*?)<\\/font>/g, '<span style=\"color: $1;\">$2</span>') // Convertir font en span\n        .replace(/<b\\b[^>]*>(.*?)<\\/b>/g, '<strong>$1</strong>') // Convertir b en strong\n        .replace(/<i\\b[^>]*>(.*?)<\\/i>/g, '<em>$1</em>'); // Convertir i en em\n      };\n      const newContent = cleanContent(editorRef.current.innerHTML);\n\n      // √âviter les boucles infinies avec une v√©rification plus stricte\n      if (newContent !== content && newContent.trim() !== content.trim()) {\n        onInput({\n          target: {\n            innerHTML: newContent,\n            value: newContent\n          }\n        });\n      }\n\n      // Re-rendre MathJax apr√®s modification du contenu\n      if (window.MathJax && window.MathJax.typesetPromise) {\n        window.MathJax.typesetPromise([editorRef.current]).catch(err => {\n          console.warn('Erreur MathJax:', err);\n        });\n      }\n\n      // Mettre √† jour l'√©tat de formatage avec un d√©lai pour √©viter les conflits\n      requestAnimationFrame(() => {\n        if (document.activeElement === editorRef.current) {\n          onSelectionChange();\n        }\n      });\n    }\n\n    // D√©s√©lectionner l'image si on clique dans le texte\n    handleDeselectImage();\n  }, [viewMode, editorRef, onInput, onSelectionChange, content, handleDeselectImage]);\n\n  // Gestionnaire pour les √©v√©nements de s√©lection/curseur\n  const handleSelectionChange = useCallback(() => {\n    if (viewMode === 'wysiwyg' && document.activeElement === editorRef.current) {\n      onSelectionChange();\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [viewMode, onSelectionChange]);\n\n  // Initialiser le contenu uniquement si n√©cessaire\n  useEffect(() => {\n    const initializeContent = async () => {\n      if (viewMode === 'wysiwyg' && editorRef.current && editorRef.current.innerHTML !== content) {\n        // Ne pas modifier le contenu si l'utilisateur interagit activement\n        const hasFocus = document.activeElement === editorRef.current;\n        const hasSelection = window.getSelection().rangeCount > 0;\n\n        // √âviter les mises √† jour pendant l'interaction utilisateur\n        if (hasFocus && hasSelection) {\n          return; // Ne pas perturber l'utilisateur\n        }\n\n        // Convertir les URLs relatives PromptoDYS en Blob URLs pour affichage\n        const currentProject = getCurrentProject();\n        let displayContent = content;\n        if (currentProject.directory) {\n          displayContent = await convertAllPromptoDysUrlsToBlobs(content, currentProject.directory);\n        }\n\n        // La conversion indexed:// ‚Üí blob: est d√©j√† g√©r√©e par App.js au chargement initial\n\n        // Mise √† jour avec le contenu converti (IndexedDB g√©r√© par MutationObserver)\n        editorRef.current.innerHTML = displayContent;\n\n        // Re-rendre MathJax apr√®s mise √† jour du contenu\n        if (window.MathJax && window.MathJax.typesetPromise) {\n          window.MathJax.typesetPromise([editorRef.current]).catch(err => {\n            console.warn('Erreur MathJax:', err);\n          });\n        }\n      }\n    };\n    initializeContent();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [viewMode, content]);\n\n  // Gestionnaire pour la copie - g√©rer images s√©lectionn√©es et convertir HTML en texte\n  const handleCopy = useCallback(e => {\n    if (viewMode === 'wysiwyg' && editorRef.current) {\n      // Cas sp√©cial : image s√©lectionn√©e\n      if (selectedImage) {\n        e.preventDefault();\n\n        // Trouver l'image dans le wrapper\n        const img = selectedImage.querySelector('img');\n        if (img) {\n          // Extraire les dimensions du wrapper\n          const wrapperStyle = window.getComputedStyle(selectedImage);\n          const width = selectedImage.style.width || wrapperStyle.width;\n          const height = selectedImage.style.height || wrapperStyle.height;\n\n          // G√©n√©rer la syntaxe Markdown √©tendue avec dimensions\n          const alt = img.alt || 'Image';\n          const src = img.src;\n          let markdownText = `![${alt}](${src})`;\n\n          // Ajouter les dimensions si elles existent\n          if (width && width !== 'auto' && height && height !== 'auto') {\n            const widthValue = width.replace('px', '') + 'px';\n            const heightValue = height.replace('px', '') + 'px';\n            markdownText += `{width=${widthValue} height=${heightValue}}`;\n          }\n\n          // Copier le Markdown dans le presse-papier\n          e.clipboardData.setData('text/plain', markdownText);\n          console.log('‚úÖ Image copi√©e en Markdown:', markdownText);\n        }\n        return;\n      }\n\n      // Cas normal : s√©lection de texte\n      const selection = window.getSelection();\n      if (selection.rangeCount > 0) {\n        const range = selection.getRangeAt(0);\n        const selectedContent = range.cloneContents();\n        const tempDiv = document.createElement('div');\n        tempDiv.appendChild(selectedContent);\n\n        // Convertir HTML en texte avec retours √† la ligne pr√©serv√©s\n        const htmlContent = tempDiv.innerHTML;\n        const textContent = htmlContent.replace(/<div[^>]*>/gi, '').replace(/<\\/div>/gi, '\\n').replace(/<br\\s*\\/?>/gi, '\\n').replace(/<p[^>]*>/gi, '').replace(/<\\/p>/gi, '\\n').replace(/<[^>]+>/g, '') // Supprimer toutes les autres balises\n        .replace(/&nbsp;/g, ' ').replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '\"').replace(/&#39;/g, \"'\").replace(/\\n+$/, ''); // Supprimer les retours √† la ligne en fin\n\n        // Mettre le texte propre dans le presse-papier\n        e.clipboardData.setData('text/plain', textContent);\n        e.preventDefault();\n      }\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [viewMode, selectedImage]);\n\n  // √âcouter les changements de s√©lection, la copie et les touches clavier\n  useEffect(() => {\n    if (viewMode === 'wysiwyg') {\n      var _editorRef$current;\n      document.addEventListener('selectionchange', handleSelectionChange);\n      document.addEventListener('keydown', handleKeyDown);\n      (_editorRef$current = editorRef.current) === null || _editorRef$current === void 0 ? void 0 : _editorRef$current.addEventListener('copy', handleCopy);\n      return () => {\n        var _editorRef$current2;\n        document.removeEventListener('selectionchange', handleSelectionChange);\n        document.removeEventListener('keydown', handleKeyDown);\n        (_editorRef$current2 = editorRef.current) === null || _editorRef$current2 === void 0 ? void 0 : _editorRef$current2.removeEventListener('copy', handleCopy);\n      };\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [viewMode, handleSelectionChange, handleCopy, handleKeyDown]);\n\n  // Effect pour redimensionner au changement de contenu (toujours d√©clar√©)\n  useEffect(() => {\n    if (viewMode !== 'wysiwyg' && editorRef.current) {\n      handleTextareaResize(editorRef.current);\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [content, viewMode, handleTextareaResize]);\n\n  // Fonction pour convertir toutes les images indexed:// pr√©sentes dans le DOM\n  const convertAllIndexedImages = useCallback(async () => {\n    if (viewMode !== 'wysiwyg' || !editorRef.current) return;\n    const images = editorRef.current.querySelectorAll('img[src^=\"indexed://\"]');\n    console.log(`üîç DIAGNOSTIC: ${images.length} images indexed:// trouv√©es dans le DOM`);\n    for (const img of images) {\n      const imageId = img.src.replace('indexed://', '');\n      console.log('üîé DIAGNOSTIC: Tentative chargement imageId:', imageId);\n      try {\n        const imageData = await loadImage(imageId);\n        console.log('üîé DIAGNOSTIC: R√©sultat loadImage:', imageData);\n        if (imageData && imageData.blobUrl) {\n          // Tester si la blob URL est valide\n          const testImg = new Image();\n          testImg.onload = () => console.log('‚úÖ DIAGNOSTIC: Blob URL valide:', imageData.blobUrl);\n          testImg.onerror = () => console.error('‚ùå DIAGNOSTIC: Blob URL invalide:', imageData.blobUrl);\n          testImg.src = imageData.blobUrl;\n          img.src = imageData.blobUrl;\n          console.log('‚úÖ Image convertie au chargement:', imageId, '‚Üí', imageData.blobUrl);\n\n          // R√©appliquer les poign√©es apr√®s conversion\n          setTimeout(() => {\n            var _editorRef$current3;\n            if ((_editorRef$current3 = editorRef.current) !== null && _editorRef$current3 !== void 0 && _editorRef$current3.contains(img) && editorRef.current.addResizeHandlesToImage) {\n              editorRef.current.addResizeHandlesToImage(img);\n            }\n          }, 100);\n        } else {\n          console.error('‚ùå DIAGNOSTIC: loadImage a retourn√© null/undefined pour:', imageId);\n        }\n      } catch (error) {\n        console.error('‚ùå DIAGNOSTIC: Erreur loadImage pour', imageId, ':', error);\n      }\n    }\n  }, [viewMode, loadImage]);\n\n  // MutationObserver pour convertir les images indexed:// en temps r√©el\n  useEffect(() => {\n    if (viewMode !== 'wysiwyg' || !editorRef.current) return;\n\n    // Conversion initiale des images d√©j√† pr√©sentes\n    convertAllIndexedImages().then(() => {\n      // Ajouter les poign√©es apr√®s la conversion\n      setTimeout(() => {\n        const addHandles = () => {\n          var _editorRef$current4;\n          const images = (_editorRef$current4 = editorRef.current) === null || _editorRef$current4 === void 0 ? void 0 : _editorRef$current4.querySelectorAll('img:not([data-resizable])');\n          images === null || images === void 0 ? void 0 : images.forEach(img => {\n            if (!img.src.startsWith('indexed://')) {\n              img.setAttribute('data-resizable', 'true');\n              // D√©clencher l'ajout des poign√©es\n              const event = new Event('load', {\n                bubbles: true\n              });\n              img.dispatchEvent(event);\n            }\n          });\n        };\n        addHandles();\n      }, 500);\n    });\n    const observer = new MutationObserver(async mutations => {\n      // Traiter les mutations de fa√ßon s√©quentielle pour √©viter les race conditions\n      for (const mutation of mutations) {\n        // V√©rifier les nouveaux n≈ìuds ajout√©s\n        for (const node of mutation.addedNodes) {\n          if (node.nodeType === Node.ELEMENT_NODE) {\n            // Chercher les images avec src indexed://\n            const images = node.tagName === 'IMG' ? [node] : node.querySelectorAll ? node.querySelectorAll('img[src^=\"indexed://\"]') : [];\n            for (const img of images) {\n              if (img.src && img.src.startsWith('indexed://')) {\n                const imageId = img.src.replace('indexed://', '');\n                console.log('üîç Image IndexedDB d√©tect√©e (mutation):', imageId);\n                try {\n                  // Attendre que loadImage soit compl√®tement r√©solu\n                  const imageData = await loadImage(imageId);\n                  if (imageData && imageData.blobUrl) {\n                    // V√©rifier que la blob URL est valide avant l'assignation\n                    img.src = imageData.blobUrl;\n                    console.log('‚úÖ Image DOM convertie (mutation):', imageId, '‚Üí', imageData.blobUrl);\n                  } else {\n                    console.warn('‚ö†Ô∏è Pas de blob URL g√©n√©r√©e pour:', imageId);\n                  }\n                } catch (error) {\n                  console.warn('‚ö†Ô∏è Erreur conversion image (mutation):', imageId, error);\n                }\n              }\n            }\n          }\n        }\n\n        // V√©rifier les modifications d'attributs (src modifi√©)\n        if (mutation.type === 'attributes' && mutation.attributeName === 'src') {\n          const img = mutation.target;\n          if (img.tagName === 'IMG' && img.src && img.src.startsWith('indexed://')) {\n            const imageId = img.src.replace('indexed://', '');\n            console.log('üîç Attribut src modifi√© vers IndexedDB:', imageId);\n            try {\n              // Attendre que loadImage soit compl√®tement r√©solu\n              const imageData = await loadImage(imageId);\n              if (imageData && imageData.blobUrl) {\n                // V√©rifier que la blob URL est valide avant l'assignation\n                img.src = imageData.blobUrl;\n                console.log('‚úÖ Image DOM convertie (attr):', imageId, '‚Üí', imageData.blobUrl);\n              } else {\n                console.warn('‚ö†Ô∏è Pas de blob URL g√©n√©r√©e pour:', imageId);\n              }\n            } catch (error) {\n              console.warn('‚ö†Ô∏è Erreur conversion image (attr):', imageId, error);\n            }\n          }\n        }\n      }\n    });\n\n    // Observer les modifications dans l'√©diteur\n    observer.observe(editorRef.current, {\n      childList: true,\n      subtree: true,\n      attributes: true,\n      attributeFilter: ['src']\n    });\n    return () => {\n      observer.disconnect();\n    };\n  }, [viewMode, loadImage, convertAllIndexedImages]);\n\n  // Effect pour ajouter les poign√©es de redimensionnement aux images\n  useEffect(() => {\n    if (viewMode === 'wysiwyg' && editorRef.current) {\n      const addResizeHandlesToImage = img => {\n        var _img$parentElement;\n        // Exposer la fonction pour r√©utilisation\n        editorRef.current.addResizeHandlesToImage = addResizeHandlesToImage;\n        // Ignorer les images indexed:// non converties\n        if (img.src.startsWith('indexed://')) {\n          console.log('‚è≥ Image indexed:// ignor√©e, en attente de conversion:', img.src);\n          return;\n        }\n\n        // V√©rifier si d√©j√† trait√©\n        if (img.getAttribute('data-resizable') || (_img$parentElement = img.parentElement) !== null && _img$parentElement !== void 0 && _img$parentElement.classList.contains('resizable-image')) {\n          return;\n        }\n\n        // Attendre que l'image soit charg√©e\n        if (!img.complete || img.naturalWidth === 0) {\n          img.addEventListener('load', () => addResizeHandlesToImage(img), {\n            once: true\n          });\n          return;\n        }\n        img.setAttribute('data-resizable', 'true');\n\n        // Wrapper l'image dans un conteneur redimensionnable\n        const wrapper = document.createElement('div');\n        wrapper.className = 'resizable-image';\n\n        // Extraire les dimensions depuis le style inline ou les attributs\n        let currentWidth, currentHeight;\n\n        // Priorit√© 1: attributs HTML (ex: width=\"300px\")\n        const attrWidth = img.getAttribute('width');\n        const attrHeight = img.getAttribute('height');\n\n        // Priorit√© 2: style inline (ex: style=\"width: 300px\")\n        const styleWidth = img.style.width;\n        const styleHeight = img.style.height;\n        if (attrWidth && attrHeight) {\n          currentWidth = parseInt(attrWidth);\n          currentHeight = parseInt(attrHeight);\n          console.log('üìè Dimensions depuis attributs:', currentWidth, 'x', currentHeight);\n        } else if (styleWidth && styleHeight) {\n          currentWidth = parseInt(styleWidth);\n          currentHeight = parseInt(styleHeight);\n          console.log('üìè Dimensions depuis style:', currentWidth, 'x', currentHeight);\n        } else {\n          // Fallback: dimensions naturelles\n          currentWidth = img.naturalWidth || 300;\n          currentHeight = img.naturalHeight || 200;\n          console.log('üìè Dimensions naturelles:', currentWidth, 'x', currentHeight);\n        }\n        wrapper.style.width = currentWidth + 'px';\n        wrapper.style.height = currentHeight + 'px';\n\n        // Ins√©rer le wrapper\n        img.parentNode.insertBefore(wrapper, img);\n        wrapper.appendChild(img);\n\n        // Ajouter le gestionnaire de clic pour la s√©lection\n        wrapper.addEventListener('click', e => handleImageClick(e, wrapper));\n        img.addEventListener('click', e => handleImageClick(e, wrapper));\n\n        // Cr√©er les 4 poign√©es\n        ['nw', 'ne', 'sw', 'se'].forEach(corner => {\n          const handle = document.createElement('div');\n          handle.className = `resize-handle ${corner}`;\n          handle.dataset.corner = corner;\n          handle.addEventListener('mousedown', e => {\n            e.preventDefault();\n            e.stopPropagation();\n            const startX = e.clientX;\n            const startY = e.clientY;\n            const startWidth = wrapper.offsetWidth;\n            const startHeight = wrapper.offsetHeight;\n            const aspectRatio = startWidth / startHeight;\n            const handleMouseMove = e => {\n              const deltaX = e.clientX - startX;\n              const deltaY = e.clientY - startY;\n              let newWidth = startWidth;\n              let newHeight = startHeight;\n\n              // Calculer les nouvelles dimensions selon le coin\n              switch (corner) {\n                case 'se':\n                  // Sud-Est\n                  newWidth = Math.max(50, startWidth + deltaX);\n                  newHeight = newWidth / aspectRatio;\n                  break;\n                case 'sw':\n                  // Sud-Ouest\n                  newWidth = Math.max(50, startWidth - deltaX);\n                  newHeight = newWidth / aspectRatio;\n                  break;\n                case 'ne':\n                  // Nord-Est\n                  newWidth = Math.max(50, startWidth + deltaX);\n                  newHeight = newWidth / aspectRatio;\n                  break;\n                case 'nw':\n                  // Nord-Ouest\n                  newWidth = Math.max(50, startWidth - deltaX);\n                  newHeight = newWidth / aspectRatio;\n                  break;\n              }\n\n              // Appliquer les nouvelles dimensions\n              wrapper.style.width = newWidth + 'px';\n              wrapper.style.height = newHeight + 'px';\n              img.style.width = '100%';\n              img.style.height = '100%';\n\n              // Ajouter les attributs HTML width/height pour persistance lors des conversions\n              img.setAttribute('width', Math.round(newWidth) + 'px');\n              img.setAttribute('height', Math.round(newHeight) + 'px');\n            };\n            const handleMouseUp = () => {\n              document.removeEventListener('mousemove', handleMouseMove);\n              document.removeEventListener('mouseup', handleMouseUp);\n\n              // D√©clencher l'√©v√©nement de changement pour sauvegarder\n              if (onInput) {\n                const event = new Event('input', {\n                  bubbles: true\n                });\n                editorRef.current.dispatchEvent(event);\n              }\n            };\n            document.addEventListener('mousemove', handleMouseMove);\n            document.addEventListener('mouseup', handleMouseUp);\n          });\n          wrapper.appendChild(handle);\n        });\n      };\n\n      // Observer pour d√©tecter les nouvelles images\n      const handleMutation = mutations => {\n        mutations.forEach(mutation => {\n          mutation.addedNodes.forEach(node => {\n            if (node.nodeName === 'IMG') {\n              addResizeHandlesToImage(node);\n            } else if (node.querySelectorAll) {\n              node.querySelectorAll('img').forEach(addResizeHandlesToImage);\n            }\n          });\n        });\n      };\n      const observer = new MutationObserver(handleMutation);\n      observer.observe(editorRef.current, {\n        childList: true,\n        subtree: true\n      });\n\n      // Traiter les images existantes\n      editorRef.current.querySelectorAll('img').forEach(addResizeHandlesToImage);\n      return () => observer.disconnect();\n    }\n  }, [viewMode, onInput]);\n\n  // Effect supprim√© - La gestion des poign√©es est maintenant dans l'effect pr√©c√©dent\n\n  // Rendu conditionnel avec switch/case pour garantir une seule vue\n  console.log('üîÑ Editor.js - Rendu switch/case, viewMode:', viewMode);\n  switch (viewMode) {\n    case 'wysiwyg':\n      console.log('üéØ SWITCH - Vue WYSIWYG');\n      return /*#__PURE__*/_jsxDEV(\"div\", {\n        children: [/*#__PURE__*/_jsxDEV(\"style\", {\n          children: `\n            .editor-content h1 { \n              font-size: 2em; \n              font-weight: bold; \n              margin: 0.67em 0; \n              line-height: 1.2;\n            }\n            .editor-content h2 { \n              font-size: 1.5em; \n              font-weight: bold; \n              margin: 0.75em 0; \n              line-height: 1.3;\n            }\n            .editor-content h3 { \n              font-size: 1.17em; \n              font-weight: bold; \n              margin: 0.83em 0; \n              line-height: 1.4;\n            }\n            .editor-content p {\n              margin: 0.5em 0;\n            }\n            .editor-content ul {\n              margin: 0.5em 0;\n              padding-left: 2em;\n              list-style-type: disc;\n            }\n            .editor-content ol {\n              margin: 0.5em 0;\n              padding-left: 2em;\n              list-style-type: decimal;\n            }\n            .editor-content ol[style*=\"lower-alpha\"] {\n              list-style-type: lower-alpha;\n            }\n            .editor-content li {\n              margin: 0.25em 0;\n            }\n            \n            /* Styles pour images redimensionnables */\n            .editor-content img {\n              max-width: 100%;\n              height: auto;\n              position: relative;\n              cursor: pointer;\n            }\n            \n            .resizable-image {\n              position: relative;\n              display: inline-block;\n              border: 2px solid transparent;\n            }\n            \n            .resizable-image:hover {\n              border: 2px solid #3b82f6;\n            }\n            \n            .resizable-image img {\n              width: 100%;\n              height: 100%;\n              display: block;\n            }\n            \n            .resizable-image .resize-handle {\n              position: absolute;\n              width: 10px;\n              height: 10px;\n              background: #3b82f6;\n              border: 2px solid white;\n              border-radius: 50%;\n              opacity: 0;\n              cursor: nw-resize;\n              transition: opacity 0.2s;\n            }\n            \n            .resizable-image:hover .resize-handle {\n              opacity: 1;\n            }\n            \n            .resize-handle.nw { top: -6px; left: -6px; cursor: nw-resize; }\n            .resize-handle.ne { top: -6px; right: -6px; cursor: ne-resize; }\n            .resize-handle.sw { bottom: -6px; left: -6px; cursor: sw-resize; }\n            .resize-handle.se { bottom: -6px; right: -6px; cursor: se-resize; }\n            \n            /* Styles pour image s√©lectionn√©e */\n            .resizable-image.selected-image {\n              border: 3px solid #2563eb !important;\n              box-shadow: 0 0 8px rgba(37, 99, 235, 0.3);\n            }\n            \n            .resizable-image.selected-image .resize-handle {\n              opacity: 1 !important;\n              background: #2563eb;\n              border: 2px solid white;\n            }\n          `\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 752,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          ref: editorRef,\n          contentEditable: true,\n          spellCheck: false,\n          onInput: handleChange,\n          onKeyDown: handleKeyDown,\n          suppressContentEditableWarning: true,\n          className: \"editor-content p-2 focus:outline-none h-full\",\n          style: {\n            fontFamily: 'var(--dys-font-family)',\n            fontSize: 'var(--dys-font-size)',\n            lineHeight: 'var(--dys-line-height)',\n            color: 'var(--dys-text-color)',\n            backgroundColor: 'var(--dys-bg-color)',\n            overflow: 'auto',\n            wordWrap: 'break-word',\n            whiteSpace: 'pre-wrap',\n            border: '1px solid #e5e7eb',\n            paddingBottom: '2rem'\n          }\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 848,\n          columnNumber: 11\n        }, this)]\n      }, \"wysiwyg\", true, {\n        fileName: _jsxFileName,\n        lineNumber: 751,\n        columnNumber: 9\n      }, this);\n    case 'markdown':\n      {\n        console.log('üìù SWITCH - Vue MARKDOWN');\n        const displayContent = getCollapsedContent(content);\n        return /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"relative\",\n          children: [/*#__PURE__*/_jsxDEV(\"textarea\", {\n            ref: el => {\n              editorRef.current = el;\n            },\n            value: displayContent,\n            onChange: e => {\n              const newValue = e.target.value;\n              const originalWithCollapse = getCollapsedContent(content);\n              if (newValue !== originalWithCollapse) {\n                onInput({\n                  ...e,\n                  target: {\n                    ...e.target,\n                    value: newValue\n                  }\n                });\n              }\n            },\n            onClick: handleBase64Toggle,\n            className: \"editor-content p-2 w-full h-full border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none\",\n            style: {\n              fontFamily: 'var(--dys-font-family)',\n              fontSize: 'var(--dys-font-size)',\n              lineHeight: 'var(--dys-line-height)',\n              color: 'var(--dys-text-color)',\n              backgroundColor: 'var(--dys-bg-color)',\n              overflow: 'auto',\n              wordWrap: 'break-word',\n              whiteSpace: 'pre-wrap',\n              paddingBottom: '2rem'\n            },\n            placeholder: \"\\xC9crivez en Markdown... # Titre 1\\n## Titre 2\\n### Titre 3 **Gras** *Italique* - Liste \\xE0 puces\\n1. Liste num\\xE9rot\\xE9e\\na. Liste alphab\\xE9tique $E = mc^2$ (formule inline)\\n$$\\\\\\\\int_{-\\\\\\\\infty}^{\\\\\\\\infty} e^{-x^2} dx = \\\\\\\\sqrt{\\\\\\\\pi}$$ (formule block)\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 878,\n            columnNumber: 11\n          }, this), detectBase64(content).length > 0 && /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"absolute top-2 right-2 bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs\",\n            children: [\"\\uD83D\\uDCF7 \", detectBase64(content).length, \" image(s) Base64\"]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 920,\n            columnNumber: 13\n          }, this)]\n        }, \"markdown\", true, {\n          fileName: _jsxFileName,\n          lineNumber: 877,\n          columnNumber: 9\n        }, this);\n      }\n    case 'html':\n      {\n        console.log('üîß SWITCH - Vue HTML');\n        const htmlDisplayContent = formatHtmlForSource(getCollapsedContent(content));\n        return /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"relative\",\n          children: [/*#__PURE__*/_jsxDEV(\"textarea\", {\n            ref: el => {\n              editorRef.current = el;\n            },\n            value: htmlDisplayContent,\n            onChange: e => {\n              const newValue = e.target.value;\n              const originalWithCollapse = formatHtmlForSource(getCollapsedContent(content));\n              if (newValue !== originalWithCollapse) {\n                onInput({\n                  ...e,\n                  target: {\n                    ...e.target,\n                    value: newValue\n                  }\n                });\n              }\n            },\n            onClick: handleBase64Toggle,\n            className: \"w-full h-full p-2 focus:outline-none resize-none\",\n            style: {\n              fontFamily: 'Monaco, \"Cascadia Code\", \"Roboto Mono\", monospace',\n              overflow: 'auto',\n              wordWrap: 'break-word',\n              whiteSpace: 'pre-wrap',\n              border: '1px solid #e5e7eb',\n              paddingBottom: '2rem'\n            },\n            placeholder: \"Code source HTML...\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 934,\n            columnNumber: 11\n          }, this), detectBase64(content).length > 0 && /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"absolute top-2 right-2 bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs\",\n            children: [\"\\uD83D\\uDCF7 \", detectBase64(content).length, \" image(s) Base64\"]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 960,\n            columnNumber: 13\n          }, this)]\n        }, \"html\", true, {\n          fileName: _jsxFileName,\n          lineNumber: 933,\n          columnNumber: 9\n        }, this);\n      }\n    default:\n      console.log('‚ùå SWITCH - AUCUNE VUE CORRESPONDANTE, viewMode:', viewMode);\n      return null;\n  }\n};\n_s(Editor, \"rVxktLWkQr5sD9FEONenZQB1lw4=\", false, function () {\n  return [useImageStorage];\n});\n_c = Editor;\nexport default Editor;\nvar _c;\n$RefreshReg$(_c, \"Editor\");","map":{"version":3,"names":["React","useCallback","useEffect","useState","detectBase64","applyBase64Collapse","convertAllPromptoDysUrlsToBlobs","getCurrentProject","useImageStorage","jsxDEV","_jsxDEV","Editor","viewMode","content","editorRef","onInput","onSelectionChange","currentFormat","convertIndexedUrlsToBlob","_s","expandedBase64","setExpandedBase64","selectedImage","setSelectedImage","loadImage","handleTextareaResize","textarea","style","height","Math","max","scrollHeight","handleBase64Toggle","e","clickedText","target","value","cursorPos","selectionStart","beforeCursor","substring","toggleMatch","match","base64Matches","length","toggleIndex","prev","getCollapsedContent","originalContent","formatHtmlForSource","html","indentLevel","indentSize","replace","startsWith","result","repeat","split","map","line","index","trim","currentIndent","join","handleImageClick","wrapper","stopPropagation","classList","remove","add","selection","window","getSelection","range","document","createRange","selectNode","removeAllRanges","addRange","console","log","handleDeselectImage","handlePaste","current","pastedText","clipboardData","getData","imageMarkdownRegex","test","preventDefault","convertedHtml","alt","src","width","widthValue","heightValue","rangeCount","getRangeAt","deleteContents","tempDiv","createElement","innerHTML","firstChild","insertNode","collapse","event","Event","bubbles","dispatchEvent","handleKeyDown","key","ctrlKey","img","querySelector","wrapperStyle","getComputedStyle","markdownText","tempTextArea","body","appendChild","select","execCommand","removeChild","handleChange","cleanContent","newContent","MathJax","typesetPromise","catch","err","warn","requestAnimationFrame","activeElement","handleSelectionChange","initializeContent","hasFocus","hasSelection","currentProject","displayContent","directory","handleCopy","setData","selectedContent","cloneContents","htmlContent","textContent","_editorRef$current","addEventListener","_editorRef$current2","removeEventListener","convertAllIndexedImages","images","querySelectorAll","imageId","imageData","blobUrl","testImg","Image","onload","onerror","error","setTimeout","_editorRef$current3","contains","addResizeHandlesToImage","then","addHandles","_editorRef$current4","forEach","setAttribute","observer","MutationObserver","mutations","mutation","node","addedNodes","nodeType","Node","ELEMENT_NODE","tagName","type","attributeName","observe","childList","subtree","attributes","attributeFilter","disconnect","_img$parentElement","getAttribute","parentElement","complete","naturalWidth","once","className","currentWidth","currentHeight","attrWidth","attrHeight","styleWidth","styleHeight","parseInt","naturalHeight","parentNode","insertBefore","corner","handle","dataset","startX","clientX","startY","clientY","startWidth","offsetWidth","startHeight","offsetHeight","aspectRatio","handleMouseMove","deltaX","deltaY","newWidth","newHeight","round","handleMouseUp","handleMutation","nodeName","children","fileName","_jsxFileName","lineNumber","columnNumber","ref","contentEditable","spellCheck","onKeyDown","suppressContentEditableWarning","fontFamily","fontSize","lineHeight","color","backgroundColor","overflow","wordWrap","whiteSpace","border","paddingBottom","el","onChange","newValue","originalWithCollapse","onClick","placeholder","htmlDisplayContent","_c","$RefreshReg$"],"sources":["C:/Users/JEAN-NOELLEFEBVRE-SA/CascadeProjects/editor/src/components/Editor.js"],"sourcesContent":["import React, { useCallback, useEffect, useState } from 'react';\nimport { detectBase64, applyBase64Collapse } from '../utils/base64Collapse';\nimport { convertAllPromptoDysUrlsToBlobs, getCurrentProject } from '../utils/promptoDysManager';\nimport { useImageStorage } from '../hooks/useImageStorage';\n\nconst Editor = ({ \n  viewMode,  \n  content, \n  editorRef, \n  onInput, \n  onSelectionChange,\n  currentFormat,\n  convertIndexedUrlsToBlob\n}) => {\n  \n  // √âtat pour g√©rer l'expansion des donn√©es Base64\n  const [expandedBase64, setExpandedBase64] = useState({});\n  \n  // √âtat pour g√©rer l'image actuellement s√©lectionn√©e\n  const [selectedImage, setSelectedImage] = useState(null);\n  \n  // Hook pour g√©rer les images IndexedDB\n  const { loadImage } = useImageStorage();\n  \n  // Gestionnaire pour l'auto-redimensionnement (toujours d√©clar√©)\n  const handleTextareaResize = useCallback((textarea) => {\n    if (textarea) {\n      textarea.style.height = 'auto';\n      textarea.style.height = Math.max(384, textarea.scrollHeight) + 'px';\n    }\n  }, []);\n\n  // Gestionnaire pour toggle Base64\n  const handleBase64Toggle = useCallback((e) => {\n    const clickedText = e.target.value;\n    const cursorPos = e.target.selectionStart;\n    \n    // Chercher si on a cliqu√© sur un bouton \"üëÅÔ∏è Voir\"\n    const beforeCursor = clickedText.substring(Math.max(0, cursorPos - 100), cursorPos + 20);\n    const toggleMatch = beforeCursor.match(/üëÅÔ∏è Voir/);\n    \n    if (toggleMatch) {\n      // Trouver l'index du Base64 correspondant\n      const base64Matches = detectBase64(content);\n      \n      // Pour simplifier, on toggle le premier Base64 trouv√©\n      // Dans une version plus avanc√©e, on pourrait calculer l'index exact\n      if (base64Matches.length > 0) {\n        const toggleIndex = 0; // Simplifi√© pour cette version\n        setExpandedBase64(prev => ({\n          ...prev,\n          [toggleIndex]: !prev[toggleIndex]\n        }));\n      }\n    }\n  }, [content]);\n\n  // Fonction pour obtenir le contenu avec Base64 collaps√©s\n  const getCollapsedContent = useCallback((originalContent) => {\n    if (viewMode === 'wysiwyg') {\n      return originalContent; // Pas de collapse en WYSIWYG\n    }\n    return applyBase64Collapse(originalContent, expandedBase64);\n  }, [viewMode, expandedBase64]);\n\n  // Fonction pour formater le HTML avec des retours √† la ligne et indentation\n  const formatHtmlForSource = useCallback((html) => {\n    let indentLevel = 0;\n    const indentSize = 2; // 2 espaces par niveau\n    \n    return html\n      .replace(/<br\\s*\\/?>/gi, '<br>\\n')\n      .replace(/<\\/?(h[1-6]|p|div|ul|ol|li|strong|em|span)[^>]*>/gi, (match) => {\n        if (match.startsWith('</')) {\n          // Balise fermante : diminuer l'indentation puis ajouter la balise\n          indentLevel = Math.max(0, indentLevel - 1);\n          return match + '\\n';\n        } else {\n          // Balise ouvrante : ajouter la balise puis augmenter l'indentation\n          const result = '\\n' + ' '.repeat(indentLevel * indentSize) + match;\n          // Augmenter l'indentation pour les balises conteneurs\n          if (match.match(/<(ul|ol|li|div|p|h[1-6])[^>]*>/i)) {\n            indentLevel++;\n          }\n          return result;\n        }\n      })\n      .split('\\n')\n      .map((line, index) => {\n        if (index === 0) return line.trim(); // Premi√®re ligne sans indentation\n        if (line.trim() === '') return ''; // Ligne vide\n        if (line.trim().startsWith('</')) {\n          // Balise fermante : r√©duire l'indentation\n          const currentIndent = Math.max(0, indentLevel - 1);\n          return ' '.repeat(currentIndent * indentSize) + line.trim();\n        }\n        // Contenu texte : utiliser l'indentation actuelle\n        return line.startsWith(' ') ? line : ' '.repeat(indentLevel * indentSize) + line.trim();\n      })\n      .join('\\n')\n      .replace(/^\\n+/, '') // Supprimer les retours √† la ligne en d√©but\n      .replace(/\\n{2,}/g, '\\n') // Supprimer toutes les lignes vides multiples\n      .trim();\n  }, []);\n\n  // Gestionnaire pour s√©lectionner une image\n  const handleImageClick = useCallback((e, wrapper) => {\n    e.stopPropagation();\n    \n    // D√©s√©lectionner l'ancienne image\n    if (selectedImage) {\n      selectedImage.classList.remove('selected-image');\n    }\n    \n    // S√©lectionner la nouvelle image\n    wrapper.classList.add('selected-image');\n    setSelectedImage(wrapper);\n    \n    // Cr√©er une s√©lection qui englobe tout le wrapper\n    const selection = window.getSelection();\n    const range = document.createRange();\n    range.selectNode(wrapper);\n    selection.removeAllRanges();\n    selection.addRange(range);\n    \n    console.log('‚úÖ Image s√©lectionn√©e:', wrapper);\n  }, [selectedImage]);\n  \n  // Gestionnaire pour d√©s√©lectionner les images\n  const handleDeselectImage = useCallback(() => {\n    if (selectedImage) {\n      selectedImage.classList.remove('selected-image');\n      setSelectedImage(null);\n      console.log('‚úÖ Image d√©s√©lectionn√©e');\n    }\n  }, [selectedImage]);\n  \n  // Gestionnaire pour le coller - convertir automatiquement Markdown avec dimensions\n  const handlePaste = useCallback((e) => {\n    if (viewMode === 'wysiwyg' && editorRef.current) {\n      // R√©cup√©rer le texte coll√©\n      const pastedText = e.clipboardData.getData('text/plain');\n      \n      // Regex pour d√©tecter les images Markdown avec dimensions\n      const imageMarkdownRegex = /!\\[([^\\]]*)\\]\\(([^)]+)\\)\\{width=([^}\\s]+)\\s+height=([^}\\s]+)\\}/g;\n      \n      // V√©rifier s'il y a des images Markdown avec dimensions\n      if (imageMarkdownRegex.test(pastedText)) {\n        e.preventDefault();\n        \n        // Convertir toutes les images Markdown avec dimensions en HTML\n        const convertedHtml = pastedText.replace(\n          imageMarkdownRegex,\n          (match, alt, src, width, height) => {\n            // Nettoyer les valeurs de dimensions (retirer 'px' s'il est pr√©sent)\n            const widthValue = width.replace('px', '');\n            const heightValue = height.replace('px', '');\n            return `<img alt=\"${alt}\" src=\"${src}\" width=\"${widthValue}\" height=\"${heightValue}\" style=\"max-width: 100%; height: auto;\">`;\n          }\n        );\n        \n        // Ins√©rer le HTML converti √† la position du curseur\n        const selection = window.getSelection();\n        if (selection.rangeCount > 0) {\n          const range = selection.getRangeAt(0);\n          range.deleteContents();\n          \n          // Cr√©er un √©l√©ment temporaire pour parser le HTML\n          const tempDiv = document.createElement('div');\n          tempDiv.innerHTML = convertedHtml;\n          \n          // Ins√©rer tous les noeuds convertis\n          while (tempDiv.firstChild) {\n            range.insertNode(tempDiv.firstChild);\n          }\n          \n          // R√©initialiser la s√©lection apr√®s le contenu ins√©r√©\n          range.collapse(false);\n          selection.removeAllRanges();\n          selection.addRange(range);\n          \n          // D√©clencher l'√©v√©nement de changement pour sauvegarder\n          if (onInput) {\n            const event = new Event('input', { bubbles: true });\n            editorRef.current.dispatchEvent(event);\n          }\n          \n          console.log('‚úÖ Markdown avec dimensions converti:', convertedHtml);\n        }\n      }\n    }\n  }, [viewMode, onInput]);\n  \n  // Gestionnaire pour les touches Delete/Backspace et Ctrl+X sur images s√©lectionn√©es\n  const handleKeyDown = useCallback((e) => {\n    if (selectedImage) {\n      // Supprimer l'image avec Delete/Backspace\n      if (e.key === 'Delete' || e.key === 'Backspace') {\n        e.preventDefault();\n        e.stopPropagation();\n        \n        selectedImage.remove();\n        setSelectedImage(null);\n        \n        // D√©clencher l'√©v√©nement de changement pour sauvegarder\n        if (onInput) {\n          const event = new Event('input', { bubbles: true });\n          editorRef.current.dispatchEvent(event);\n        }\n        \n        console.log('‚úÖ Image supprim√©e');\n      }\n      \n      // Couper l'image avec Ctrl+X\n      if (e.ctrlKey && e.key === 'x') {\n        e.preventDefault();\n        e.stopPropagation();\n        \n        // D'abord copier l'image avec ses dimensions en format Markdown\n        const img = selectedImage.querySelector('img');\n        if (img) {\n          // Extraire les dimensions du wrapper\n          const wrapperStyle = window.getComputedStyle(selectedImage);\n          const width = selectedImage.style.width || wrapperStyle.width;\n          const height = selectedImage.style.height || wrapperStyle.height;\n          \n          // G√©n√©rer la syntaxe Markdown √©tendue avec dimensions\n          const alt = img.alt || 'Image';\n          const src = img.src;\n          let markdownText = `![${alt}](${src})`;\n          \n          // Ajouter les dimensions si elles existent\n          if (width && width !== 'auto' && height && height !== 'auto') {\n            const widthValue = width.replace('px', '') + 'px';\n            const heightValue = height.replace('px', '') + 'px';\n            markdownText += `{width=${widthValue} height=${heightValue}}`;\n          }\n          \n          // Cr√©er un √©l√©ment temporaire pour copier le texte\n          const tempTextArea = document.createElement('textarea');\n          tempTextArea.value = markdownText;\n          document.body.appendChild(tempTextArea);\n          tempTextArea.select();\n          document.execCommand('copy');\n          document.body.removeChild(tempTextArea);\n          \n          console.log('‚úÖ Image coup√©e en Markdown:', markdownText);\n        }\n        \n        // Supprimer l'image\n        selectedImage.remove();\n        setSelectedImage(null);\n        \n        // D√©clencher l'√©v√©nement de changement pour sauvegarder\n        if (onInput) {\n          const event = new Event('input', { bubbles: true });\n          editorRef.current.dispatchEvent(event);\n        }\n      }\n    }\n  }, [selectedImage, onInput]);\n\n  // Gestionnaire unifi√© pour tous les changements\n  const handleChange = useCallback((e) => {\n    if (viewMode === 'wysiwyg' && editorRef.current) {\n      // Nettoyer les spans vides et les &nbsp; en trop\n      const cleanContent = (html) => {\n        return html\n          .replace(/<span(?![^>]*style=\"[^\"]*color:)[^>]*>\\s*<\\/span>/g, '') // Supprimer spans vides SAUF les spans color√©s\n          .replace(/(&nbsp;\\s*){2,}/g, '&nbsp;') // R√©duire les &nbsp; multiples\n          .replace(/<font[^>]*color=\"([^\"]*)\"[^>]*>(.*?)<\\/font>/g, '<span style=\"color: $1;\">$2</span>') // Convertir font en span\n          .replace(/<b\\b[^>]*>(.*?)<\\/b>/g, '<strong>$1</strong>') // Convertir b en strong\n          .replace(/<i\\b[^>]*>(.*?)<\\/i>/g, '<em>$1</em>'); // Convertir i en em\n      };\n      \n      const newContent = cleanContent(editorRef.current.innerHTML);\n      \n      // √âviter les boucles infinies avec une v√©rification plus stricte\n      if (newContent !== content && newContent.trim() !== content.trim()) {\n        onInput({ target: { innerHTML: newContent, value: newContent } });\n      }\n      \n      // Re-rendre MathJax apr√®s modification du contenu\n      if (window.MathJax && window.MathJax.typesetPromise) {\n        window.MathJax.typesetPromise([editorRef.current]).catch((err) => {\n          console.warn('Erreur MathJax:', err);\n        });\n      }\n      \n      // Mettre √† jour l'√©tat de formatage avec un d√©lai pour √©viter les conflits\n      requestAnimationFrame(() => {\n        if (document.activeElement === editorRef.current) {\n          onSelectionChange();\n        }\n      });\n    }\n    \n    // D√©s√©lectionner l'image si on clique dans le texte\n    handleDeselectImage();\n  }, [viewMode, editorRef, onInput, onSelectionChange, content, handleDeselectImage]);\n\n  // Gestionnaire pour les √©v√©nements de s√©lection/curseur\n  const handleSelectionChange = useCallback(() => {\n    if (viewMode === 'wysiwyg' && document.activeElement === editorRef.current) {\n      onSelectionChange();\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [viewMode, onSelectionChange]);\n\n\n  // Initialiser le contenu uniquement si n√©cessaire\n  useEffect(() => {\n    const initializeContent = async () => {\n      if (viewMode === 'wysiwyg' && editorRef.current && editorRef.current.innerHTML !== content) {\n        // Ne pas modifier le contenu si l'utilisateur interagit activement\n        const hasFocus = document.activeElement === editorRef.current;\n        const hasSelection = window.getSelection().rangeCount > 0;\n        \n        // √âviter les mises √† jour pendant l'interaction utilisateur\n        if (hasFocus && hasSelection) {\n          return; // Ne pas perturber l'utilisateur\n        }\n        \n        // Convertir les URLs relatives PromptoDYS en Blob URLs pour affichage\n        const currentProject = getCurrentProject();\n        let displayContent = content;\n        \n        if (currentProject.directory) {\n          displayContent = await convertAllPromptoDysUrlsToBlobs(content, currentProject.directory);\n        }\n        \n        // La conversion indexed:// ‚Üí blob: est d√©j√† g√©r√©e par App.js au chargement initial\n        \n        // Mise √† jour avec le contenu converti (IndexedDB g√©r√© par MutationObserver)\n        editorRef.current.innerHTML = displayContent;\n        \n        // Re-rendre MathJax apr√®s mise √† jour du contenu\n        if (window.MathJax && window.MathJax.typesetPromise) {\n          window.MathJax.typesetPromise([editorRef.current]).catch((err) => {\n            console.warn('Erreur MathJax:', err);\n          });\n        }\n      }\n    };\n    \n    initializeContent();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [viewMode, content]);\n\n  // Gestionnaire pour la copie - g√©rer images s√©lectionn√©es et convertir HTML en texte\n  const handleCopy = useCallback((e) => {\n    if (viewMode === 'wysiwyg' && editorRef.current) {\n      // Cas sp√©cial : image s√©lectionn√©e\n      if (selectedImage) {\n        e.preventDefault();\n        \n        // Trouver l'image dans le wrapper\n        const img = selectedImage.querySelector('img');\n        if (img) {\n          // Extraire les dimensions du wrapper\n          const wrapperStyle = window.getComputedStyle(selectedImage);\n          const width = selectedImage.style.width || wrapperStyle.width;\n          const height = selectedImage.style.height || wrapperStyle.height;\n          \n          // G√©n√©rer la syntaxe Markdown √©tendue avec dimensions\n          const alt = img.alt || 'Image';\n          const src = img.src;\n          let markdownText = `![${alt}](${src})`;\n          \n          // Ajouter les dimensions si elles existent\n          if (width && width !== 'auto' && height && height !== 'auto') {\n            const widthValue = width.replace('px', '') + 'px';\n            const heightValue = height.replace('px', '') + 'px';\n            markdownText += `{width=${widthValue} height=${heightValue}}`;\n          }\n          \n          // Copier le Markdown dans le presse-papier\n          e.clipboardData.setData('text/plain', markdownText);\n          \n          console.log('‚úÖ Image copi√©e en Markdown:', markdownText);\n        }\n        return;\n      }\n      \n      // Cas normal : s√©lection de texte\n      const selection = window.getSelection();\n      if (selection.rangeCount > 0) {\n        const range = selection.getRangeAt(0);\n        const selectedContent = range.cloneContents();\n        const tempDiv = document.createElement('div');\n        tempDiv.appendChild(selectedContent);\n        \n        // Convertir HTML en texte avec retours √† la ligne pr√©serv√©s\n        const htmlContent = tempDiv.innerHTML;\n        const textContent = htmlContent\n          .replace(/<div[^>]*>/gi, '')\n          .replace(/<\\/div>/gi, '\\n')\n          .replace(/<br\\s*\\/?>/gi, '\\n')\n          .replace(/<p[^>]*>/gi, '')\n          .replace(/<\\/p>/gi, '\\n')\n          .replace(/<[^>]+>/g, '') // Supprimer toutes les autres balises\n          .replace(/&nbsp;/g, ' ')\n          .replace(/&amp;/g, '&')\n          .replace(/&lt;/g, '<')\n          .replace(/&gt;/g, '>')\n          .replace(/&quot;/g, '\"')\n          .replace(/&#39;/g, \"'\")\n          .replace(/\\n+$/, ''); // Supprimer les retours √† la ligne en fin\n        \n        // Mettre le texte propre dans le presse-papier\n        e.clipboardData.setData('text/plain', textContent);\n        e.preventDefault();\n      }\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [viewMode, selectedImage]);\n\n  // √âcouter les changements de s√©lection, la copie et les touches clavier\n  useEffect(() => {\n    if (viewMode === 'wysiwyg') {\n      document.addEventListener('selectionchange', handleSelectionChange);\n      document.addEventListener('keydown', handleKeyDown);\n      editorRef.current?.addEventListener('copy', handleCopy);\n      \n      return () => {\n        document.removeEventListener('selectionchange', handleSelectionChange);\n        document.removeEventListener('keydown', handleKeyDown);\n        editorRef.current?.removeEventListener('copy', handleCopy);\n      };\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [viewMode, handleSelectionChange, handleCopy, handleKeyDown]);\n\n  // Effect pour redimensionner au changement de contenu (toujours d√©clar√©)\n  useEffect(() => {\n    if (viewMode !== 'wysiwyg' && editorRef.current) {\n      handleTextareaResize(editorRef.current);\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [content, viewMode, handleTextareaResize]);\n\n  // Fonction pour convertir toutes les images indexed:// pr√©sentes dans le DOM\n  const convertAllIndexedImages = useCallback(async () => {\n    if (viewMode !== 'wysiwyg' || !editorRef.current) return;\n    \n    const images = editorRef.current.querySelectorAll('img[src^=\"indexed://\"]');\n    console.log(`üîç DIAGNOSTIC: ${images.length} images indexed:// trouv√©es dans le DOM`);\n    \n    for (const img of images) {\n      const imageId = img.src.replace('indexed://', '');\n      console.log('üîé DIAGNOSTIC: Tentative chargement imageId:', imageId);\n      \n      try {\n        const imageData = await loadImage(imageId);\n        console.log('üîé DIAGNOSTIC: R√©sultat loadImage:', imageData);\n        \n        if (imageData && imageData.blobUrl) {\n          // Tester si la blob URL est valide\n          const testImg = new Image();\n          testImg.onload = () => console.log('‚úÖ DIAGNOSTIC: Blob URL valide:', imageData.blobUrl);\n          testImg.onerror = () => console.error('‚ùå DIAGNOSTIC: Blob URL invalide:', imageData.blobUrl);\n          testImg.src = imageData.blobUrl;\n          \n          img.src = imageData.blobUrl;\n          console.log('‚úÖ Image convertie au chargement:', imageId, '‚Üí', imageData.blobUrl);\n          \n          // R√©appliquer les poign√©es apr√®s conversion\n          setTimeout(() => {\n            if (editorRef.current?.contains(img) && editorRef.current.addResizeHandlesToImage) {\n              editorRef.current.addResizeHandlesToImage(img);\n            }\n          }, 100);\n        } else {\n          console.error('‚ùå DIAGNOSTIC: loadImage a retourn√© null/undefined pour:', imageId);\n        }\n      } catch (error) {\n        console.error('‚ùå DIAGNOSTIC: Erreur loadImage pour', imageId, ':', error);\n      }\n    }\n  }, [viewMode, loadImage]);\n\n  // MutationObserver pour convertir les images indexed:// en temps r√©el\n  useEffect(() => {\n    if (viewMode !== 'wysiwyg' || !editorRef.current) return;\n\n    // Conversion initiale des images d√©j√† pr√©sentes\n    convertAllIndexedImages().then(() => {\n      // Ajouter les poign√©es apr√®s la conversion\n      setTimeout(() => {\n        const addHandles = () => {\n          const images = editorRef.current?.querySelectorAll('img:not([data-resizable])');\n          images?.forEach((img) => {\n            if (!img.src.startsWith('indexed://')) {\n              img.setAttribute('data-resizable', 'true');\n              // D√©clencher l'ajout des poign√©es\n              const event = new Event('load', { bubbles: true });\n              img.dispatchEvent(event);\n            }\n          });\n        };\n        addHandles();\n      }, 500);\n    });\n\n    const observer = new MutationObserver(async (mutations) => {\n      // Traiter les mutations de fa√ßon s√©quentielle pour √©viter les race conditions\n      for (const mutation of mutations) {\n        // V√©rifier les nouveaux n≈ìuds ajout√©s\n        for (const node of mutation.addedNodes) {\n          if (node.nodeType === Node.ELEMENT_NODE) {\n            // Chercher les images avec src indexed://\n            const images = node.tagName === 'IMG' \n              ? [node] \n              : node.querySelectorAll ? node.querySelectorAll('img[src^=\"indexed://\"]') : [];\n            \n            for (const img of images) {\n              if (img.src && img.src.startsWith('indexed://')) {\n                const imageId = img.src.replace('indexed://', '');\n                console.log('üîç Image IndexedDB d√©tect√©e (mutation):', imageId);\n                \n                try {\n                  // Attendre que loadImage soit compl√®tement r√©solu\n                  const imageData = await loadImage(imageId);\n                  if (imageData && imageData.blobUrl) {\n                    // V√©rifier que la blob URL est valide avant l'assignation\n                    img.src = imageData.blobUrl;\n                    console.log('‚úÖ Image DOM convertie (mutation):', imageId, '‚Üí', imageData.blobUrl);\n                  } else {\n                    console.warn('‚ö†Ô∏è Pas de blob URL g√©n√©r√©e pour:', imageId);\n                  }\n                } catch (error) {\n                  console.warn('‚ö†Ô∏è Erreur conversion image (mutation):', imageId, error);\n                }\n              }\n            }\n          }\n        }\n\n        // V√©rifier les modifications d'attributs (src modifi√©)\n        if (mutation.type === 'attributes' && mutation.attributeName === 'src') {\n          const img = mutation.target;\n          if (img.tagName === 'IMG' && img.src && img.src.startsWith('indexed://')) {\n            const imageId = img.src.replace('indexed://', '');\n            console.log('üîç Attribut src modifi√© vers IndexedDB:', imageId);\n            \n            try {\n              // Attendre que loadImage soit compl√®tement r√©solu\n              const imageData = await loadImage(imageId);\n              if (imageData && imageData.blobUrl) {\n                // V√©rifier que la blob URL est valide avant l'assignation\n                img.src = imageData.blobUrl;\n                console.log('‚úÖ Image DOM convertie (attr):', imageId, '‚Üí', imageData.blobUrl);\n              } else {\n                console.warn('‚ö†Ô∏è Pas de blob URL g√©n√©r√©e pour:', imageId);\n              }\n            } catch (error) {\n              console.warn('‚ö†Ô∏è Erreur conversion image (attr):', imageId, error);\n            }\n          }\n        }\n      }\n    });\n\n  // Observer les modifications dans l'√©diteur\n  observer.observe(editorRef.current, {\n    childList: true,\n    subtree: true,\n    attributes: true,\n    attributeFilter: ['src']\n  });\n\n  return () => {\n    observer.disconnect();\n  };\n}, [viewMode, loadImage, convertAllIndexedImages]);\n\n  // Effect pour ajouter les poign√©es de redimensionnement aux images\n  useEffect(() => {\n    if (viewMode === 'wysiwyg' && editorRef.current) {\n      const addResizeHandlesToImage = (img) => {\n        // Exposer la fonction pour r√©utilisation\n        editorRef.current.addResizeHandlesToImage = addResizeHandlesToImage;\n        // Ignorer les images indexed:// non converties\n        if (img.src.startsWith('indexed://')) {\n          console.log('‚è≥ Image indexed:// ignor√©e, en attente de conversion:', img.src);\n          return;\n        }\n        \n        // V√©rifier si d√©j√† trait√©\n        if (img.getAttribute('data-resizable') || img.parentElement?.classList.contains('resizable-image')) {\n          return;\n        }\n        \n        // Attendre que l'image soit charg√©e\n        if (!img.complete || img.naturalWidth === 0) {\n          img.addEventListener('load', () => addResizeHandlesToImage(img), { once: true });\n          return;\n        }\n        \n        img.setAttribute('data-resizable', 'true');\n        \n        // Wrapper l'image dans un conteneur redimensionnable\n        const wrapper = document.createElement('div');\n        wrapper.className = 'resizable-image';\n        \n        // Extraire les dimensions depuis le style inline ou les attributs\n        let currentWidth, currentHeight;\n        \n        // Priorit√© 1: attributs HTML (ex: width=\"300px\")\n        const attrWidth = img.getAttribute('width');\n        const attrHeight = img.getAttribute('height');\n        \n        // Priorit√© 2: style inline (ex: style=\"width: 300px\")\n        const styleWidth = img.style.width;\n        const styleHeight = img.style.height;\n        \n        if (attrWidth && attrHeight) {\n          currentWidth = parseInt(attrWidth);\n          currentHeight = parseInt(attrHeight);\n          console.log('üìè Dimensions depuis attributs:', currentWidth, 'x', currentHeight);\n        } else if (styleWidth && styleHeight) {\n          currentWidth = parseInt(styleWidth);\n          currentHeight = parseInt(styleHeight);\n          console.log('üìè Dimensions depuis style:', currentWidth, 'x', currentHeight);\n        } else {\n          // Fallback: dimensions naturelles\n          currentWidth = img.naturalWidth || 300;\n          currentHeight = img.naturalHeight || 200;\n          console.log('üìè Dimensions naturelles:', currentWidth, 'x', currentHeight);\n        }\n        \n        wrapper.style.width = currentWidth + 'px';\n        wrapper.style.height = currentHeight + 'px';\n          \n          // Ins√©rer le wrapper\n          img.parentNode.insertBefore(wrapper, img);\n          wrapper.appendChild(img);\n          \n          // Ajouter le gestionnaire de clic pour la s√©lection\n          wrapper.addEventListener('click', (e) => handleImageClick(e, wrapper));\n          img.addEventListener('click', (e) => handleImageClick(e, wrapper));\n          \n          // Cr√©er les 4 poign√©es\n          ['nw', 'ne', 'sw', 'se'].forEach((corner) => {\n            const handle = document.createElement('div');\n            handle.className = `resize-handle ${corner}`;\n            handle.dataset.corner = corner;\n            \n            handle.addEventListener('mousedown', (e) => {\n              e.preventDefault();\n              e.stopPropagation();\n              \n              const startX = e.clientX;\n              const startY = e.clientY;\n              const startWidth = wrapper.offsetWidth;\n              const startHeight = wrapper.offsetHeight;\n              const aspectRatio = startWidth / startHeight;\n              \n              const handleMouseMove = (e) => {\n                const deltaX = e.clientX - startX;\n                const deltaY = e.clientY - startY;\n                \n                let newWidth = startWidth;\n                let newHeight = startHeight;\n                \n                // Calculer les nouvelles dimensions selon le coin\n                switch(corner) {\n                  case 'se': // Sud-Est\n                    newWidth = Math.max(50, startWidth + deltaX);\n                    newHeight = newWidth / aspectRatio;\n                    break;\n                  case 'sw': // Sud-Ouest\n                    newWidth = Math.max(50, startWidth - deltaX);\n                    newHeight = newWidth / aspectRatio;\n                    break;\n                  case 'ne': // Nord-Est\n                    newWidth = Math.max(50, startWidth + deltaX);\n                    newHeight = newWidth / aspectRatio;\n                    break;\n                  case 'nw': // Nord-Ouest\n                    newWidth = Math.max(50, startWidth - deltaX);\n                    newHeight = newWidth / aspectRatio;\n                    break;\n                }\n                \n                // Appliquer les nouvelles dimensions\n                wrapper.style.width = newWidth + 'px';\n                wrapper.style.height = newHeight + 'px';\n                img.style.width = '100%';\n                img.style.height = '100%';\n                \n                // Ajouter les attributs HTML width/height pour persistance lors des conversions\n                img.setAttribute('width', Math.round(newWidth) + 'px');\n                img.setAttribute('height', Math.round(newHeight) + 'px');\n              };\n              \n              const handleMouseUp = () => {\n                document.removeEventListener('mousemove', handleMouseMove);\n                document.removeEventListener('mouseup', handleMouseUp);\n                \n                // D√©clencher l'√©v√©nement de changement pour sauvegarder\n                if (onInput) {\n                  const event = new Event('input', { bubbles: true });\n                  editorRef.current.dispatchEvent(event);\n                }\n              };\n              \n              document.addEventListener('mousemove', handleMouseMove);\n              document.addEventListener('mouseup', handleMouseUp);\n            });\n            \n            wrapper.appendChild(handle);\n          });\n      };\n      \n      // Observer pour d√©tecter les nouvelles images\n      const handleMutation = (mutations) => {\n        mutations.forEach(mutation => {\n          mutation.addedNodes.forEach(node => {\n            if (node.nodeName === 'IMG') {\n              addResizeHandlesToImage(node);\n            } else if (node.querySelectorAll) {\n              node.querySelectorAll('img').forEach(addResizeHandlesToImage);\n            }\n          });\n        });\n      };\n      \n      const observer = new MutationObserver(handleMutation);\n      observer.observe(editorRef.current, {\n        childList: true,\n        subtree: true\n      });\n      \n      // Traiter les images existantes\n      editorRef.current.querySelectorAll('img').forEach(addResizeHandlesToImage);\n      \n      return () => observer.disconnect();\n    }\n  }, [viewMode, onInput]);\n  \n  // Effect supprim√© - La gestion des poign√©es est maintenant dans l'effect pr√©c√©dent\n\n  // Rendu conditionnel avec switch/case pour garantir une seule vue\n  console.log('üîÑ Editor.js - Rendu switch/case, viewMode:', viewMode);\n  \n  switch (viewMode) {\n    case 'wysiwyg':\n      console.log('üéØ SWITCH - Vue WYSIWYG');\n      return (\n        <div key=\"wysiwyg\">\n          <style>{`\n            .editor-content h1 { \n              font-size: 2em; \n              font-weight: bold; \n              margin: 0.67em 0; \n              line-height: 1.2;\n            }\n            .editor-content h2 { \n              font-size: 1.5em; \n              font-weight: bold; \n              margin: 0.75em 0; \n              line-height: 1.3;\n            }\n            .editor-content h3 { \n              font-size: 1.17em; \n              font-weight: bold; \n              margin: 0.83em 0; \n              line-height: 1.4;\n            }\n            .editor-content p {\n              margin: 0.5em 0;\n            }\n            .editor-content ul {\n              margin: 0.5em 0;\n              padding-left: 2em;\n              list-style-type: disc;\n            }\n            .editor-content ol {\n              margin: 0.5em 0;\n              padding-left: 2em;\n              list-style-type: decimal;\n            }\n            .editor-content ol[style*=\"lower-alpha\"] {\n              list-style-type: lower-alpha;\n            }\n            .editor-content li {\n              margin: 0.25em 0;\n            }\n            \n            /* Styles pour images redimensionnables */\n            .editor-content img {\n              max-width: 100%;\n              height: auto;\n              position: relative;\n              cursor: pointer;\n            }\n            \n            .resizable-image {\n              position: relative;\n              display: inline-block;\n              border: 2px solid transparent;\n            }\n            \n            .resizable-image:hover {\n              border: 2px solid #3b82f6;\n            }\n            \n            .resizable-image img {\n              width: 100%;\n              height: 100%;\n              display: block;\n            }\n            \n            .resizable-image .resize-handle {\n              position: absolute;\n              width: 10px;\n              height: 10px;\n              background: #3b82f6;\n              border: 2px solid white;\n              border-radius: 50%;\n              opacity: 0;\n              cursor: nw-resize;\n              transition: opacity 0.2s;\n            }\n            \n            .resizable-image:hover .resize-handle {\n              opacity: 1;\n            }\n            \n            .resize-handle.nw { top: -6px; left: -6px; cursor: nw-resize; }\n            .resize-handle.ne { top: -6px; right: -6px; cursor: ne-resize; }\n            .resize-handle.sw { bottom: -6px; left: -6px; cursor: sw-resize; }\n            .resize-handle.se { bottom: -6px; right: -6px; cursor: se-resize; }\n            \n            /* Styles pour image s√©lectionn√©e */\n            .resizable-image.selected-image {\n              border: 3px solid #2563eb !important;\n              box-shadow: 0 0 8px rgba(37, 99, 235, 0.3);\n            }\n            \n            .resizable-image.selected-image .resize-handle {\n              opacity: 1 !important;\n              background: #2563eb;\n              border: 2px solid white;\n            }\n          `}</style>\n          <div\n            ref={editorRef}\n            contentEditable\n            spellCheck={false}\n            onInput={handleChange}\n            onKeyDown={handleKeyDown}\n            suppressContentEditableWarning={true}\n            className=\"editor-content p-2 focus:outline-none h-full\"\n            style={{ \n              fontFamily: 'var(--dys-font-family)',\n              fontSize: 'var(--dys-font-size)',\n              lineHeight: 'var(--dys-line-height)',\n              color: 'var(--dys-text-color)',\n              backgroundColor: 'var(--dys-bg-color)',\n              overflow: 'auto',\n              wordWrap: 'break-word',\n              whiteSpace: 'pre-wrap',\n              border: '1px solid #e5e7eb',\n              paddingBottom: '2rem'\n            }}\n          />\n        </div>\n      );\n\n    case 'markdown': {\n      console.log('üìù SWITCH - Vue MARKDOWN');\n      const displayContent = getCollapsedContent(content);\n      \n      return (\n        <div key=\"markdown\" className=\"relative\">\n          <textarea\n            ref={(el) => {\n              editorRef.current = el;\n            }}\n            value={displayContent}\n            onChange={(e) => {\n              const newValue = e.target.value;\n              const originalWithCollapse = getCollapsedContent(content);\n              \n              if (newValue !== originalWithCollapse) {\n                onInput({ ...e, target: { ...e.target, value: newValue } });\n              }\n            }}\n            onClick={handleBase64Toggle}\n            className=\"editor-content p-2 w-full h-full border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none\"\n            style={{\n              fontFamily: 'var(--dys-font-family)',\n              fontSize: 'var(--dys-font-size)',\n              lineHeight: 'var(--dys-line-height)',\n              color: 'var(--dys-text-color)',\n              backgroundColor: 'var(--dys-bg-color)',\n              overflow: 'auto',\n              wordWrap: 'break-word',\n              whiteSpace: 'pre-wrap',\n              paddingBottom: '2rem'\n            }}\n            placeholder=\"√âcrivez en Markdown...\n\n# Titre 1\n## Titre 2\n### Titre 3\n\n**Gras** *Italique*\n\n- Liste √† puces\n1. Liste num√©rot√©e\na. Liste alphab√©tique\n\n$E = mc^2$ (formule inline)\n$$\\\\int_{-\\\\infty}^{\\\\infty} e^{-x^2} dx = \\\\sqrt{\\\\pi}$$ (formule block)\"\n          />\n          {detectBase64(content).length > 0 && (\n            <div className=\"absolute top-2 right-2 bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs\">\n              üì∑ {detectBase64(content).length} image(s) Base64\n            </div>\n          )}\n        </div>\n      );\n    }\n\n    case 'html': {\n      console.log('üîß SWITCH - Vue HTML');\n      const htmlDisplayContent = formatHtmlForSource(getCollapsedContent(content));\n    \n      return (\n        <div key=\"html\" className=\"relative\">\n          <textarea\n            ref={(el) => {\n              editorRef.current = el;\n            }}\n            value={htmlDisplayContent}\n            onChange={(e) => {\n              const newValue = e.target.value;\n              const originalWithCollapse = formatHtmlForSource(getCollapsedContent(content));\n              \n              if (newValue !== originalWithCollapse) {\n                onInput({ ...e, target: { ...e.target, value: newValue } });\n              }\n            }}\n            onClick={handleBase64Toggle}\n            className=\"w-full h-full p-2 focus:outline-none resize-none\"\n            style={{ \n              fontFamily: 'Monaco, \"Cascadia Code\", \"Roboto Mono\", monospace',\n              overflow: 'auto',\n              wordWrap: 'break-word',\n              whiteSpace: 'pre-wrap',\n              border: '1px solid #e5e7eb',\n              paddingBottom: '2rem'\n            }}\n            placeholder=\"Code source HTML...\"\n          />\n          {detectBase64(content).length > 0 && (\n            <div className=\"absolute top-2 right-2 bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs\">\n              üì∑ {detectBase64(content).length} image(s) Base64\n            </div>\n          )}\n        </div>\n      );\n    }\n\n    default:\n      console.log('‚ùå SWITCH - AUCUNE VUE CORRESPONDANTE, viewMode:', viewMode);\n      return null;\n  }\n};\n\nexport default Editor;\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}