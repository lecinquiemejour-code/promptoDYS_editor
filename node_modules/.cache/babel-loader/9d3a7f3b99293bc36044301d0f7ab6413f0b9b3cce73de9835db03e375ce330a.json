{"ast":null,"code":"import _objectSpread from\"C:/Users/JEAN-NOELLEFEBVRE-SA/CascadeProjects/editor/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useCallback,useEffect,useState}from'react';import{detectBase64,applyBase64Collapse}from'../utils/base64Collapse';import{convertAllPromptoDysUrlsToBlobs,getCurrentProject}from'../utils/promptoDysManager';import{useImageStorage}from'../hooks/useImageStorage';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const Editor=_ref=>{let{viewMode,content,editorRef,onInput,onSelectionChange,currentFormat,convertIndexedUrlsToBlob,selectedImage,onImageClick,onEditorClick,onDeleteSelectedImage}=_ref;// √âtat pour g√©rer l'expansion des donn√©es Base64\nconst[expandedBase64,setExpandedBase64]=useState({});// Hook pour g√©rer les images IndexedDB\nconst{loadImage}=useImageStorage();// Gestionnaire pour l'auto-redimensionnement (toujours d√©clar√©)\nconst handleTextareaResize=useCallback(textarea=>{if(textarea){textarea.style.height='auto';textarea.style.height=Math.max(384,textarea.scrollHeight)+'px';}},[]);// Gestionnaire pour toggle Base64\nconst handleBase64Toggle=useCallback(e=>{const clickedText=e.target.value;const cursorPos=e.target.selectionStart;// Chercher si on a cliqu√© sur un bouton \"üëÅÔ∏è Voir\"\nconst beforeCursor=clickedText.substring(Math.max(0,cursorPos-100),cursorPos+20);const toggleMatch=beforeCursor.match(/üëÅÔ∏è Voir/);if(toggleMatch){// Trouver l'index du Base64 correspondant\nconst base64Matches=detectBase64(content);// Pour simplifier, on toggle le premier Base64 trouv√©\n// Dans une version plus avanc√©e, on pourrait calculer l'index exact\nif(base64Matches.length>0){const toggleIndex=0;// Simplifi√© pour cette version\nsetExpandedBase64(prev=>_objectSpread(_objectSpread({},prev),{},{[toggleIndex]:!prev[toggleIndex]}));}}},[content]);// Fonction pour obtenir le contenu avec Base64 collaps√©s\nconst getCollapsedContent=useCallback(originalContent=>{if(viewMode==='wysiwyg'){return originalContent;// Pas de collapse en WYSIWYG\n}return applyBase64Collapse(originalContent,expandedBase64);},[viewMode,expandedBase64]);// Fonction pour formater le HTML avec des retours √† la ligne et indentation\nconst formatHtmlForSource=useCallback(html=>{let indentLevel=0;const indentSize=2;// 2 espaces par niveau\nreturn html.replace(/<br\\s*\\/?>/gi,'<br>\\n').replace(/<\\/?(h[1-6]|p|div|ul|ol|li|strong|em|span)[^>]*>/gi,match=>{if(match.startsWith('</')){// Balise fermante : diminuer l'indentation puis ajouter la balise\nindentLevel=Math.max(0,indentLevel-1);return match+'\\n';}else{// Balise ouvrante : ajouter la balise puis augmenter l'indentation\nconst result='\\n'+' '.repeat(indentLevel*indentSize)+match;// Augmenter l'indentation pour les balises conteneurs\nif(match.match(/<(ul|ol|li|div|p|h[1-6])[^>]*>/i)){indentLevel++;}return result;}}).split('\\n').map((line,index)=>{if(index===0)return line.trim();// Premi√®re ligne sans indentation\nif(line.trim()==='')return'';// Ligne vide\nif(line.trim().startsWith('</')){// Balise fermante : r√©duire l'indentation\nconst currentIndent=Math.max(0,indentLevel-1);return' '.repeat(currentIndent*indentSize)+line.trim();}// Contenu texte : utiliser l'indentation actuelle\nreturn line.startsWith(' ')?line:' '.repeat(indentLevel*indentSize)+line.trim();}).join('\\n').replace(/^\\n+/,'')// Supprimer les retours √† la ligne en d√©but\n.replace(/\\n{2,}/g,'\\n')// Supprimer toutes les lignes vides multiples\n.trim();},[]);// Gestionnaire unifi√© pour tous les changements\nconst handleChange=useCallback(e=>{if(viewMode==='wysiwyg'&&editorRef.current){// Nettoyer les spans vides et les &nbsp; en trop\nconst cleanContent=html=>{return html.replace(/<span(?![^>]*style=\"[^\"]*color:)[^>]*>\\s*<\\/span>/g,'')// Supprimer spans vides SAUF les spans color√©s\n.replace(/(&nbsp;\\s*){2,}/g,'&nbsp;')// R√©duire les &nbsp; multiples\n.replace(/<font[^>]*color=\"([^\"]*)\"[^>]*>(.*?)<\\/font>/g,'<span style=\"color: $1;\">$2</span>')// Convertir font en span\n.replace(/<b\\b[^>]*>(.*?)<\\/b>/g,'<strong>$1</strong>')// Convertir b en strong\n.replace(/<i\\b[^>]*>(.*?)<\\/i>/g,'<em>$1</em>');// Convertir i en em\n};const newContent=cleanContent(editorRef.current.innerHTML);// √âviter les boucles infinies avec une v√©rification plus stricte\nif(newContent!==content&&newContent.trim()!==content.trim()){onInput({target:{innerHTML:newContent,value:newContent}});}// Re-rendre MathJax apr√®s modification du contenu\nif(window.MathJax&&window.MathJax.typesetPromise){window.MathJax.typesetPromise([editorRef.current]).catch(err=>{console.warn('Erreur MathJax:',err);});}// Mettre √† jour l'√©tat de formatage avec un d√©lai pour √©viter les conflits\nrequestAnimationFrame(()=>{if(document.activeElement===editorRef.current){onSelectionChange();}});}},[viewMode,editorRef,onInput,onSelectionChange,content]);// Gestionnaire pour les √©v√©nements de s√©lection/curseur\nconst handleSelectionChange=useCallback(()=>{if(viewMode==='wysiwyg'&&document.activeElement===editorRef.current){onSelectionChange();}// eslint-disable-next-line react-hooks/exhaustive-deps\n},[viewMode,onSelectionChange]);// Initialiser le contenu uniquement si n√©cessaire\nuseEffect(()=>{const initializeContent=async()=>{if(viewMode==='wysiwyg'&&editorRef.current&&editorRef.current.innerHTML!==content){// Ne pas modifier le contenu si l'utilisateur interagit activement\nconst hasFocus=document.activeElement===editorRef.current;const hasSelection=window.getSelection().rangeCount>0;// √âviter les mises √† jour pendant l'interaction utilisateur\nif(hasFocus&&hasSelection){return;// Ne pas perturber l'utilisateur\n}// Convertir les URLs relatives PromptoDYS en Blob URLs pour affichage\nconst currentProject=getCurrentProject();let displayContent=content;if(currentProject.directory){displayContent=await convertAllPromptoDysUrlsToBlobs(content,currentProject.directory);}// La conversion indexed:// ‚Üí blob: est d√©j√† g√©r√©e par App.js au chargement initial\n// Mise √† jour avec le contenu converti (IndexedDB g√©r√© par MutationObserver)\neditorRef.current.innerHTML=displayContent;// Re-rendre MathJax apr√®s mise √† jour du contenu\nif(window.MathJax&&window.MathJax.typesetPromise){window.MathJax.typesetPromise([editorRef.current]).catch(err=>{console.warn('Erreur MathJax:',err);});}}};initializeContent();// eslint-disable-next-line react-hooks/exhaustive-deps\n},[viewMode,content]);// Gestionnaire pour la copie - convertir HTML en texte propre et g√©rer les images s√©lectionn√©es\nconst handleCopy=useCallback(e=>{if(viewMode==='wysiwyg'&&editorRef.current){// Priorit√© 1: Si une image est s√©lectionn√©e, copier l'image\nif(selectedImage){try{// Cr√©er un √©l√©ment temporaire avec l'image\nconst tempDiv=document.createElement('div');const clonedImg=selectedImage.cloneNode(true);tempDiv.appendChild(clonedImg);// Copier au format HTML pour pr√©server la structure\ne.clipboardData.setData('text/html',tempDiv.innerHTML);// Copier aussi le src comme texte de fallback\ne.clipboardData.setData('text/plain',selectedImage.src);e.preventDefault();return;}catch(error){console.warn('Erreur copie image:',error);}}// Priorit√© 2: S√©lection de texte classique\nconst selection=window.getSelection();if(selection.rangeCount>0){const range=selection.getRangeAt(0);const selectedContent=range.cloneContents();const tempDiv=document.createElement('div');tempDiv.appendChild(selectedContent);// Convertir HTML en texte avec retours √† la ligne pr√©serv√©s\nconst htmlContent=tempDiv.innerHTML;const textContent=htmlContent.replace(/<div[^>]*>/gi,'').replace(/<\\/div>/gi,'\\n').replace(/<br\\s*\\/?>/gi,'\\n').replace(/<p[^>]*>/gi,'').replace(/<\\/p>/gi,'\\n').replace(/<[^>]+>/g,'')// Supprimer toutes les autres balises\n.replace(/&nbsp;/g,' ').replace(/&amp;/g,'&').replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&quot;/g,'\"').replace(/&#39;/g,\"'\").replace(/\\n+$/,'');// Supprimer les retours √† la ligne en fin\n// Mettre le texte propre dans le presse-papier\ne.clipboardData.setData('text/plain',textContent);e.preventDefault();}}// eslint-disable-next-line react-hooks/exhaustive-deps\n},[viewMode,selectedImage]);// Gestionnaire pour forcer le refresh apr√®s coller\nconst handlePaste=useCallback(e=>{if(viewMode==='wysiwyg'&&editorRef.current){// Attendre que le contenu soit coll√©\nsetTimeout(async()=>{console.log('üîÑ Refresh forc√© apr√®s coller');// Reconvertir toutes les images indexed:// qui pourraient avoir √©t√© coll√©es\nconst indexedImages=editorRef.current.querySelectorAll('img[src^=\"indexed://\"]');for(const img of indexedImages){const imageId=img.src.replace('indexed://','');try{const imageData=await loadImage(imageId);if(imageData!==null&&imageData!==void 0&&imageData.blobUrl){img.src=imageData.blobUrl;img.setAttribute('data-image-id',imageId);console.log('‚úÖ Image refresh apr√®s coller:',imageId);}}catch(error){console.warn('‚ö†Ô∏è Erreur refresh image apr√®s coller:',error);}}// Ajouter les poign√©es aux nouvelles images coll√©es\nconst newImages=editorRef.current.querySelectorAll('img:not([data-resizable])');newImages.forEach(img=>{if(editorRef.current.addResizeHandlesToImage){editorRef.current.addResizeHandlesToImage(img);}});// D√©clencher sauvegarde\nif(onInput){const event=new Event('input',{bubbles:true});editorRef.current.dispatchEvent(event);}},100);}},[viewMode,loadImage,onInput]);// √âcouter les changements de s√©lection, la copie et le coller\nuseEffect(()=>{if(viewMode==='wysiwyg'){var _editorRef$current,_editorRef$current2;document.addEventListener('selectionchange',handleSelectionChange);(_editorRef$current=editorRef.current)===null||_editorRef$current===void 0?void 0:_editorRef$current.addEventListener('copy',handleCopy);(_editorRef$current2=editorRef.current)===null||_editorRef$current2===void 0?void 0:_editorRef$current2.addEventListener('paste',handlePaste);return()=>{var _editorRef$current3,_editorRef$current4;document.removeEventListener('selectionchange',handleSelectionChange);(_editorRef$current3=editorRef.current)===null||_editorRef$current3===void 0?void 0:_editorRef$current3.removeEventListener('copy',handleCopy);(_editorRef$current4=editorRef.current)===null||_editorRef$current4===void 0?void 0:_editorRef$current4.removeEventListener('paste',handlePaste);};}// eslint-disable-next-line react-hooks/exhaustive-deps\n},[viewMode,handleSelectionChange,handleCopy,handlePaste]);// Effect pour redimensionner au changement de contenu (toujours d√©clar√©)\nuseEffect(()=>{if(viewMode!=='wysiwyg'&&editorRef.current){handleTextareaResize(editorRef.current);}// eslint-disable-next-line react-hooks/exhaustive-deps\n},[content,viewMode,handleTextareaResize]);// Fonction pour convertir toutes les images indexed:// pr√©sentes dans le DOM\nconst convertAllIndexedImages=useCallback(async()=>{if(viewMode!=='wysiwyg'||!editorRef.current)return;const images=editorRef.current.querySelectorAll('img[src^=\"indexed://\"]');console.log(\"\\uD83D\\uDD0D DIAGNOSTIC: \".concat(images.length,\" images indexed:// trouv\\xE9es dans le DOM\"));for(const img of images){const imageId=img.src.replace('indexed://','');console.log('üîé DIAGNOSTIC: Tentative chargement imageId:',imageId);try{const imageData=await loadImage(imageId);console.log('üîé DIAGNOSTIC: R√©sultat loadImage:',imageData);if(imageData&&imageData.blobUrl){// Tester si la blob URL est valide\nconst testImg=new Image();testImg.onload=()=>console.log('‚úÖ DIAGNOSTIC: Blob URL valide:',imageData.blobUrl);testImg.onerror=()=>console.error('‚ùå DIAGNOSTIC: Blob URL invalide:',imageData.blobUrl);testImg.src=imageData.blobUrl;img.src=imageData.blobUrl;console.log('‚úÖ Image convertie au chargement:',imageId,'‚Üí',imageData.blobUrl);// R√©appliquer les poign√©es apr√®s conversion\nsetTimeout(()=>{var _editorRef$current5;if((_editorRef$current5=editorRef.current)!==null&&_editorRef$current5!==void 0&&_editorRef$current5.contains(img)&&editorRef.current.addResizeHandlesToImage){editorRef.current.addResizeHandlesToImage(img);}},100);}else{console.error('‚ùå DIAGNOSTIC: loadImage a retourn√© null/undefined pour:',imageId);}}catch(error){console.error('‚ùå DIAGNOSTIC: Erreur loadImage pour',imageId,':',error);}}},[viewMode,loadImage]);// MutationObserver pour convertir les images indexed:// en temps r√©el\nuseEffect(()=>{if(viewMode!=='wysiwyg'||!editorRef.current)return;// Conversion initiale des images d√©j√† pr√©sentes\nconvertAllIndexedImages().then(()=>{// Ajouter les poign√©es apr√®s la conversion\nsetTimeout(()=>{const addHandles=()=>{var _editorRef$current6;const images=(_editorRef$current6=editorRef.current)===null||_editorRef$current6===void 0?void 0:_editorRef$current6.querySelectorAll('img:not([data-resizable])');images===null||images===void 0?void 0:images.forEach(img=>{if(!img.src.startsWith('indexed://')){img.setAttribute('data-resizable','true');// D√©clencher l'ajout des poign√©es\nconst event=new Event('load',{bubbles:true});img.dispatchEvent(event);}});};addHandles();},500);});const observer=new MutationObserver(async mutations=>{// Traiter les mutations de fa√ßon s√©quentielle pour √©viter les race conditions\nfor(const mutation of mutations){// V√©rifier les nouveaux n≈ìuds ajout√©s\nfor(const node of mutation.addedNodes){if(node.nodeType===Node.ELEMENT_NODE){// Chercher les images avec src indexed://\nconst images=node.tagName==='IMG'?[node]:node.querySelectorAll?node.querySelectorAll('img[src^=\"indexed://\"]'):[];for(const img of images){if(img.src&&img.src.startsWith('indexed://')){const imageId=img.src.replace('indexed://','');console.log('üîç Image IndexedDB d√©tect√©e (mutation):',imageId);try{// Attendre que loadImage soit compl√®tement r√©solu\nconst imageData=await loadImage(imageId);if(imageData&&imageData.blobUrl){// V√©rifier que la blob URL est valide avant l'assignation\nimg.src=imageData.blobUrl;console.log('‚úÖ Image DOM convertie (mutation):',imageId,'‚Üí',imageData.blobUrl);}else{console.warn('‚ö†Ô∏è Pas de blob URL g√©n√©r√©e pour:',imageId);}}catch(error){console.warn('‚ö†Ô∏è Erreur conversion image (mutation):',imageId,error);}}}}}// V√©rifier les modifications d'attributs (src modifi√©)\nif(mutation.type==='attributes'&&mutation.attributeName==='src'){const img=mutation.target;if(img.tagName==='IMG'&&img.src&&img.src.startsWith('indexed://')){const imageId=img.src.replace('indexed://','');console.log('üîç Attribut src modifi√© vers IndexedDB:',imageId);try{// Attendre que loadImage soit compl√®tement r√©solu\nconst imageData=await loadImage(imageId);if(imageData&&imageData.blobUrl){// V√©rifier que la blob URL est valide avant l'assignation\nimg.src=imageData.blobUrl;console.log('‚úÖ Image DOM convertie (attr):',imageId,'‚Üí',imageData.blobUrl);}else{console.warn('‚ö†Ô∏è Pas de blob URL g√©n√©r√©e pour:',imageId);}}catch(error){console.warn('‚ö†Ô∏è Erreur conversion image (attr):',imageId,error);}}}}});// Observer les modifications dans l'√©diteur\nobserver.observe(editorRef.current,{childList:true,subtree:true,attributes:true,attributeFilter:['src']});return()=>{observer.disconnect();};},[viewMode,loadImage,convertAllIndexedImages]);// Effect pour appliquer le style de s√©lection d'image\nuseEffect(()=>{if(viewMode==='wysiwyg'&&editorRef.current){// Supprimer la classe de toutes les images\nconst allImages=editorRef.current.querySelectorAll('img');allImages.forEach(img=>{const wrapper=img.closest('.resizable-image');if(wrapper){wrapper.classList.remove('image-selected');}});// Ajouter la classe √† l'image s√©lectionn√©e\nif(selectedImage){const wrapper=selectedImage.closest('.resizable-image');if(wrapper){wrapper.classList.add('image-selected');}}}},[selectedImage,viewMode]);// Gestion des poign√©es de redimensionnement pour les images\nuseEffect(()=>{if(viewMode==='wysiwyg'&&editorRef.current){const addResizeHandlesToImage=img=>{var _img$parentElement;// Exposer la fonction pour r√©utilisation\neditorRef.current.addResizeHandlesToImage=addResizeHandlesToImage;// Ignorer les images indexed:// non converties\nif(img.src.startsWith('indexed://')){console.log('‚è≥ Image indexed:// ignor√©e, en attente de conversion:',img.src);return;}// V√©rifier si d√©j√† trait√©\nif(img.getAttribute('data-resizable')||(_img$parentElement=img.parentElement)!==null&&_img$parentElement!==void 0&&_img$parentElement.classList.contains('resizable-image')){return;}// Attendre que l'image soit charg√©e\nif(!img.complete||img.naturalWidth===0){img.addEventListener('load',()=>addResizeHandlesToImage(img),{once:true});return;}img.setAttribute('data-resizable','true');// Wrapper l'image dans un conteneur redimensionnable\nconst wrapper=document.createElement('div');wrapper.className='resizable-image';// Ajouter gestionnaire de clic pour s√©lection d'image\nimg.addEventListener('click',e=>{e.stopPropagation();if(onImageClick){onImageClick(img);}});// Extraire les dimensions depuis le style inline ou les attributs\nlet currentWidth,currentHeight;// Priorit√© 1: attributs HTML (ex: width=\"300px\")\nconst attrWidth=img.getAttribute('width');const attrHeight=img.getAttribute('height');// Priorit√© 2: style inline (ex: style=\"width: 300px\")\nconst styleWidth=img.style.width;const styleHeight=img.style.height;if(attrWidth&&attrHeight){currentWidth=parseInt(attrWidth);currentHeight=parseInt(attrHeight);console.log('üìè Dimensions depuis attributs:',currentWidth,'x',currentHeight);}else if(styleWidth&&styleHeight){currentWidth=parseInt(styleWidth);currentHeight=parseInt(styleHeight);console.log('üìè Dimensions depuis style:',currentWidth,'x',currentHeight);}else{// Fallback: dimensions naturelles\ncurrentWidth=img.naturalWidth||300;currentHeight=img.naturalHeight||200;console.log('üìè Dimensions naturelles:',currentWidth,'x',currentHeight);}// Limiter la hauteur maximale √† 300px en pr√©servant le ratio d'aspect\nconst MAX_HEIGHT=300;if(currentHeight>MAX_HEIGHT){const aspectRatio=currentWidth/currentHeight;currentHeight=MAX_HEIGHT;currentWidth=Math.round(currentHeight*aspectRatio);console.log('üîÑ Image redimensionn√©e pour hauteur max 300px:',currentWidth,'x',currentHeight);// Appliquer les nouvelles dimensions √† l'image\nimg.setAttribute('width',currentWidth+'px');img.setAttribute('height',currentHeight+'px');img.style.width=currentWidth+'px';img.style.height=currentHeight+'px';}wrapper.style.width=currentWidth+'px';wrapper.style.height=currentHeight+'px';// Ins√©rer le wrapper\nimg.parentNode.insertBefore(wrapper,img);wrapper.appendChild(img);// Cr√©er les 4 poign√©es\n['nw','ne','sw','se'].forEach(corner=>{const handle=document.createElement('div');handle.className=\"resize-handle \".concat(corner);handle.dataset.corner=corner;handle.addEventListener('mousedown',e=>{e.preventDefault();e.stopPropagation();const startX=e.clientX;const startY=e.clientY;const startWidth=wrapper.offsetWidth;const startHeight=wrapper.offsetHeight;const aspectRatio=startWidth/startHeight;const handleMouseMove=e=>{const deltaX=e.clientX-startX;const deltaY=e.clientY-startY;let newWidth=startWidth;let newHeight=startHeight;// Calculer les nouvelles dimensions selon le coin\nswitch(corner){case'se':// Sud-Est\nnewWidth=Math.max(50,startWidth+deltaX);newHeight=newWidth/aspectRatio;break;case'sw':// Sud-Ouest\nnewWidth=Math.max(50,startWidth-deltaX);newHeight=newWidth/aspectRatio;break;case'ne':// Nord-Est\nnewWidth=Math.max(50,startWidth+deltaX);newHeight=newWidth/aspectRatio;break;case'nw':// Nord-Ouest\nnewWidth=Math.max(50,startWidth-deltaX);newHeight=newWidth/aspectRatio;break;}// Appliquer les nouvelles dimensions\nwrapper.style.width=newWidth+'px';wrapper.style.height=newHeight+'px';img.style.width='100%';img.style.height='100%';// Ajouter les attributs HTML width/height pour persistance lors des conversions\nimg.setAttribute('width',Math.round(newWidth)+'px');img.setAttribute('height',Math.round(newHeight)+'px');};const handleMouseUp=()=>{document.removeEventListener('mousemove',handleMouseMove);document.removeEventListener('mouseup',handleMouseUp);// D√©clencher l'√©v√©nement de changement pour sauvegarder\nif(onInput){const event=new Event('input',{bubbles:true});editorRef.current.dispatchEvent(event);}};document.addEventListener('mousemove',handleMouseMove);document.addEventListener('mouseup',handleMouseUp);});wrapper.appendChild(handle);});};// Observer pour d√©tecter les nouvelles images\nconst handleMutation=mutations=>{mutations.forEach(mutation=>{mutation.addedNodes.forEach(node=>{if(node.nodeName==='IMG'){addResizeHandlesToImage(node);}else if(node.querySelectorAll){node.querySelectorAll('img').forEach(addResizeHandlesToImage);}});});};const observer=new MutationObserver(handleMutation);observer.observe(editorRef.current,{childList:true,subtree:true});// Traiter les images existantes\neditorRef.current.querySelectorAll('img').forEach(addResizeHandlesToImage);return()=>observer.disconnect();}},[viewMode,onInput]);// Effect supprim√© - La gestion des poign√©es est maintenant dans l'effect pr√©c√©dent\n// Rendu conditionnel avec switch/case pour garantir une seule vue\nconsole.log('üîÑ Editor.js - Rendu switch/case, viewMode:',viewMode);switch(viewMode){case'wysiwyg':console.log('üéØ SWITCH - Vue WYSIWYG');return/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"style\",{children:\"\\n            .editor-content h1 { \\n              font-size: 2em; \\n              font-weight: bold; \\n              margin: 0.67em 0; \\n              line-height: 1.2;\\n            }\\n            .editor-content h2 { \\n              font-size: 1.5em; \\n              font-weight: bold; \\n              margin: 0.75em 0; \\n              line-height: 1.3;\\n            }\\n            .editor-content h3 { \\n              font-size: 1.17em; \\n              font-weight: bold; \\n              margin: 0.83em 0; \\n              line-height: 1.4;\\n            }\\n            .editor-content p {\\n              margin: 0.5em 0;\\n            }\\n            .editor-content ul {\\n              margin: 0.5em 0;\\n              padding-left: 2em;\\n              list-style-type: disc;\\n            }\\n            .editor-content ol {\\n              margin: 0.5em 0;\\n              padding-left: 2em;\\n              list-style-type: decimal;\\n            }\\n            .editor-content ol[style*=\\\"lower-alpha\\\"] {\\n              list-style-type: lower-alpha;\\n            }\\n            .editor-content li {\\n              margin: 0.25em 0;\\n            }\\n            \\n            /* Styles pour images redimensionnables */\\n            .editor-content img {\\n              max-width: 100%;\\n              height: auto;\\n              position: relative;\\n              cursor: pointer;\\n            }\\n            \\n            .resizable-image {\\n              position: relative;\\n              display: inline-block;\\n              border: 2px solid transparent;\\n            }\\n            \\n            .resizable-image:hover {\\n              border: 2px solid #3b82f6;\\n            }\\n            \\n            /* Style pour image s\\xE9lectionn\\xE9e */\\n            .image-selected {\\n              border: 3px solid #2563eb !important;\\n              box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);\\n            }\\n            \\n            .resizable-image img {\\n              width: 100%;\\n              height: 100%;\\n              display: block;\\n            }\\n            \\n            .resizable-image .resize-handle {\\n              position: absolute;\\n              width: 10px;\\n              height: 10px;\\n              background: #3b82f6;\\n              border: 2px solid white;\\n              border-radius: 50%;\\n              opacity: 0;\\n              cursor: nw-resize;\\n              transition: opacity 0.2s;\\n            }\\n            \\n            .resizable-image:hover .resize-handle {\\n              opacity: 1;\\n            }\\n            \\n            .resize-handle.nw { top: -6px; left: -6px; cursor: nw-resize; }\\n            .resize-handle.ne { top: -6px; right: -6px; cursor: ne-resize; }\\n            .resize-handle.sw { bottom: -6px; left: -6px; cursor: sw-resize; }\\n            .resize-handle.se { bottom: -6px; right: -6px; cursor: se-resize; }\\n          \"}),/*#__PURE__*/_jsx(\"div\",{ref:editorRef,contentEditable:true,spellCheck:false,onInput:handleChange,onClick:onEditorClick,onKeyDown:onDeleteSelectedImage,suppressContentEditableWarning:true,className:\"editor-content p-2 focus:outline-none h-full\",style:{fontFamily:'var(--dys-font-family)',fontSize:'var(--dys-font-size)',lineHeight:'var(--dys-line-height)',color:'var(--dys-text-color)',backgroundColor:'var(--dys-bg-color)',overflow:'auto',wordWrap:'break-word',whiteSpace:'pre-wrap',border:'1px solid #e5e7eb',paddingBottom:'2rem'}})]},\"wysiwyg\");case'markdown':{console.log('üìù SWITCH - Vue MARKDOWN');const displayContent=getCollapsedContent(content);return/*#__PURE__*/_jsxs(\"div\",{className:\"relative\",children:[/*#__PURE__*/_jsx(\"textarea\",{ref:el=>{editorRef.current=el;},value:displayContent,onChange:e=>{const newValue=e.target.value;const originalWithCollapse=getCollapsedContent(content);if(newValue!==originalWithCollapse){onInput(_objectSpread(_objectSpread({},e),{},{target:_objectSpread(_objectSpread({},e.target),{},{value:newValue})}));}},onClick:handleBase64Toggle,className:\"editor-content p-2 w-full h-full border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none\",style:{fontFamily:'var(--dys-font-family)',fontSize:'var(--dys-font-size)',lineHeight:'var(--dys-line-height)',color:'var(--dys-text-color)',backgroundColor:'var(--dys-bg-color)',overflow:'auto',wordWrap:'break-word',whiteSpace:'pre-wrap',paddingBottom:'2rem'},placeholder:\"\\xC9crivez en Markdown... # Titre 1\\n## Titre 2\\n### Titre 3 **Gras** *Italique* - Liste \\xE0 puces\\n1. Liste num\\xE9rot\\xE9e\\na. Liste alphab\\xE9tique $E = mc^2$ (formule inline)\\n$$\\\\\\\\int_{-\\\\\\\\infty}^{\\\\\\\\infty} e^{-x^2} dx = \\\\\\\\sqrt{\\\\\\\\pi}$$ (formule block)\"}),detectBase64(content).length>0&&/*#__PURE__*/_jsxs(\"div\",{className:\"absolute top-2 right-2 bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs\",children:[\"\\uD83D\\uDCF7 \",detectBase64(content).length,\" image(s) Base64\"]})]},\"markdown\");}case'html':{console.log('üîß SWITCH - Vue HTML');const htmlDisplayContent=formatHtmlForSource(getCollapsedContent(content));return/*#__PURE__*/_jsxs(\"div\",{className:\"relative\",children:[/*#__PURE__*/_jsx(\"textarea\",{ref:el=>{editorRef.current=el;},value:htmlDisplayContent,onChange:e=>{const newValue=e.target.value;const originalWithCollapse=formatHtmlForSource(getCollapsedContent(content));if(newValue!==originalWithCollapse){onInput(_objectSpread(_objectSpread({},e),{},{target:_objectSpread(_objectSpread({},e.target),{},{value:newValue})}));}},onClick:handleBase64Toggle,className:\"w-full h-full p-2 focus:outline-none resize-none\",style:{fontFamily:'Monaco, \"Cascadia Code\", \"Roboto Mono\", monospace',overflow:'auto',wordWrap:'break-word',whiteSpace:'pre-wrap',border:'1px solid #e5e7eb',paddingBottom:'2rem'},placeholder:\"Code source HTML...\"}),detectBase64(content).length>0&&/*#__PURE__*/_jsxs(\"div\",{className:\"absolute top-2 right-2 bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs\",children:[\"\\uD83D\\uDCF7 \",detectBase64(content).length,\" image(s) Base64\"]})]},\"html\");}default:console.log('‚ùå SWITCH - AUCUNE VUE CORRESPONDANTE, viewMode:',viewMode);return null;}};export default Editor;","map":{"version":3,"names":["React","useCallback","useEffect","useState","detectBase64","applyBase64Collapse","convertAllPromptoDysUrlsToBlobs","getCurrentProject","useImageStorage","jsx","_jsx","jsxs","_jsxs","Editor","_ref","viewMode","content","editorRef","onInput","onSelectionChange","currentFormat","convertIndexedUrlsToBlob","selectedImage","onImageClick","onEditorClick","onDeleteSelectedImage","expandedBase64","setExpandedBase64","loadImage","handleTextareaResize","textarea","style","height","Math","max","scrollHeight","handleBase64Toggle","e","clickedText","target","value","cursorPos","selectionStart","beforeCursor","substring","toggleMatch","match","base64Matches","length","toggleIndex","prev","_objectSpread","getCollapsedContent","originalContent","formatHtmlForSource","html","indentLevel","indentSize","replace","startsWith","result","repeat","split","map","line","index","trim","currentIndent","join","handleChange","current","cleanContent","newContent","innerHTML","window","MathJax","typesetPromise","catch","err","console","warn","requestAnimationFrame","document","activeElement","handleSelectionChange","initializeContent","hasFocus","hasSelection","getSelection","rangeCount","currentProject","displayContent","directory","handleCopy","tempDiv","createElement","clonedImg","cloneNode","appendChild","clipboardData","setData","src","preventDefault","error","selection","range","getRangeAt","selectedContent","cloneContents","htmlContent","textContent","handlePaste","setTimeout","log","indexedImages","querySelectorAll","img","imageId","imageData","blobUrl","setAttribute","newImages","forEach","addResizeHandlesToImage","event","Event","bubbles","dispatchEvent","_editorRef$current","_editorRef$current2","addEventListener","_editorRef$current3","_editorRef$current4","removeEventListener","convertAllIndexedImages","images","concat","testImg","Image","onload","onerror","_editorRef$current5","contains","then","addHandles","_editorRef$current6","observer","MutationObserver","mutations","mutation","node","addedNodes","nodeType","Node","ELEMENT_NODE","tagName","type","attributeName","observe","childList","subtree","attributes","attributeFilter","disconnect","allImages","wrapper","closest","classList","remove","add","_img$parentElement","getAttribute","parentElement","complete","naturalWidth","once","className","stopPropagation","currentWidth","currentHeight","attrWidth","attrHeight","styleWidth","width","styleHeight","parseInt","naturalHeight","MAX_HEIGHT","aspectRatio","round","parentNode","insertBefore","corner","handle","dataset","startX","clientX","startY","clientY","startWidth","offsetWidth","startHeight","offsetHeight","handleMouseMove","deltaX","deltaY","newWidth","newHeight","handleMouseUp","handleMutation","nodeName","children","ref","contentEditable","spellCheck","onClick","onKeyDown","suppressContentEditableWarning","fontFamily","fontSize","lineHeight","color","backgroundColor","overflow","wordWrap","whiteSpace","border","paddingBottom","el","onChange","newValue","originalWithCollapse","placeholder","htmlDisplayContent"],"sources":["C:/Users/JEAN-NOELLEFEBVRE-SA/CascadeProjects/editor/src/components/Editor.js"],"sourcesContent":["import React, { useCallback, useEffect, useState } from 'react';\nimport { detectBase64, applyBase64Collapse } from '../utils/base64Collapse';\nimport { convertAllPromptoDysUrlsToBlobs, getCurrentProject } from '../utils/promptoDysManager';\nimport { useImageStorage } from '../hooks/useImageStorage';\n\nconst Editor = ({ \n  viewMode, \n  content, \n  editorRef, \n  onInput, \n  onSelectionChange, \n  currentFormat, \n  convertIndexedUrlsToBlob,\n  selectedImage,\n  onImageClick,\n  onEditorClick,\n  onDeleteSelectedImage\n}) => {\n  \n  // √âtat pour g√©rer l'expansion des donn√©es Base64\n  const [expandedBase64, setExpandedBase64] = useState({});\n  \n  // Hook pour g√©rer les images IndexedDB\n  const { loadImage } = useImageStorage();\n  \n  // Gestionnaire pour l'auto-redimensionnement (toujours d√©clar√©)\n  const handleTextareaResize = useCallback((textarea) => {\n    if (textarea) {\n      textarea.style.height = 'auto';\n      textarea.style.height = Math.max(384, textarea.scrollHeight) + 'px';\n    }\n  }, []);\n\n  // Gestionnaire pour toggle Base64\n  const handleBase64Toggle = useCallback((e) => {\n    const clickedText = e.target.value;\n    const cursorPos = e.target.selectionStart;\n    \n    // Chercher si on a cliqu√© sur un bouton \"üëÅÔ∏è Voir\"\n    const beforeCursor = clickedText.substring(Math.max(0, cursorPos - 100), cursorPos + 20);\n    const toggleMatch = beforeCursor.match(/üëÅÔ∏è Voir/);\n    \n    if (toggleMatch) {\n      // Trouver l'index du Base64 correspondant\n      const base64Matches = detectBase64(content);\n      \n      // Pour simplifier, on toggle le premier Base64 trouv√©\n      // Dans une version plus avanc√©e, on pourrait calculer l'index exact\n      if (base64Matches.length > 0) {\n        const toggleIndex = 0; // Simplifi√© pour cette version\n        setExpandedBase64(prev => ({\n          ...prev,\n          [toggleIndex]: !prev[toggleIndex]\n        }));\n      }\n    }\n  }, [content]);\n\n  // Fonction pour obtenir le contenu avec Base64 collaps√©s\n  const getCollapsedContent = useCallback((originalContent) => {\n    if (viewMode === 'wysiwyg') {\n      return originalContent; // Pas de collapse en WYSIWYG\n    }\n    return applyBase64Collapse(originalContent, expandedBase64);\n  }, [viewMode, expandedBase64]);\n\n  // Fonction pour formater le HTML avec des retours √† la ligne et indentation\n  const formatHtmlForSource = useCallback((html) => {\n    let indentLevel = 0;\n    const indentSize = 2; // 2 espaces par niveau\n    \n    return html\n      .replace(/<br\\s*\\/?>/gi, '<br>\\n')\n      .replace(/<\\/?(h[1-6]|p|div|ul|ol|li|strong|em|span)[^>]*>/gi, (match) => {\n        if (match.startsWith('</')) {\n          // Balise fermante : diminuer l'indentation puis ajouter la balise\n          indentLevel = Math.max(0, indentLevel - 1);\n          return match + '\\n';\n        } else {\n          // Balise ouvrante : ajouter la balise puis augmenter l'indentation\n          const result = '\\n' + ' '.repeat(indentLevel * indentSize) + match;\n          // Augmenter l'indentation pour les balises conteneurs\n          if (match.match(/<(ul|ol|li|div|p|h[1-6])[^>]*>/i)) {\n            indentLevel++;\n          }\n          return result;\n        }\n      })\n      .split('\\n')\n      .map((line, index) => {\n        if (index === 0) return line.trim(); // Premi√®re ligne sans indentation\n        if (line.trim() === '') return ''; // Ligne vide\n        if (line.trim().startsWith('</')) {\n          // Balise fermante : r√©duire l'indentation\n          const currentIndent = Math.max(0, indentLevel - 1);\n          return ' '.repeat(currentIndent * indentSize) + line.trim();\n        }\n        // Contenu texte : utiliser l'indentation actuelle\n        return line.startsWith(' ') ? line : ' '.repeat(indentLevel * indentSize) + line.trim();\n      })\n      .join('\\n')\n      .replace(/^\\n+/, '') // Supprimer les retours √† la ligne en d√©but\n      .replace(/\\n{2,}/g, '\\n') // Supprimer toutes les lignes vides multiples\n      .trim();\n  }, []);\n\n  // Gestionnaire unifi√© pour tous les changements\n  const handleChange = useCallback((e) => {\n    if (viewMode === 'wysiwyg' && editorRef.current) {\n      // Nettoyer les spans vides et les &nbsp; en trop\n      const cleanContent = (html) => {\n        return html\n          .replace(/<span(?![^>]*style=\"[^\"]*color:)[^>]*>\\s*<\\/span>/g, '') // Supprimer spans vides SAUF les spans color√©s\n          .replace(/(&nbsp;\\s*){2,}/g, '&nbsp;') // R√©duire les &nbsp; multiples\n          .replace(/<font[^>]*color=\"([^\"]*)\"[^>]*>(.*?)<\\/font>/g, '<span style=\"color: $1;\">$2</span>') // Convertir font en span\n          .replace(/<b\\b[^>]*>(.*?)<\\/b>/g, '<strong>$1</strong>') // Convertir b en strong\n          .replace(/<i\\b[^>]*>(.*?)<\\/i>/g, '<em>$1</em>'); // Convertir i en em\n      };\n      \n      const newContent = cleanContent(editorRef.current.innerHTML);\n      \n      // √âviter les boucles infinies avec une v√©rification plus stricte\n      if (newContent !== content && newContent.trim() !== content.trim()) {\n        onInput({ target: { innerHTML: newContent, value: newContent } });\n      }\n      \n      // Re-rendre MathJax apr√®s modification du contenu\n      if (window.MathJax && window.MathJax.typesetPromise) {\n        window.MathJax.typesetPromise([editorRef.current]).catch((err) => {\n          console.warn('Erreur MathJax:', err);\n        });\n      }\n      \n      // Mettre √† jour l'√©tat de formatage avec un d√©lai pour √©viter les conflits\n      requestAnimationFrame(() => {\n        if (document.activeElement === editorRef.current) {\n          onSelectionChange();\n        }\n      });\n    }\n  }, [viewMode, editorRef, onInput, onSelectionChange, content]);\n\n  // Gestionnaire pour les √©v√©nements de s√©lection/curseur\n  const handleSelectionChange = useCallback(() => {\n    if (viewMode === 'wysiwyg' && document.activeElement === editorRef.current) {\n      onSelectionChange();\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [viewMode, onSelectionChange]);\n\n\n  // Initialiser le contenu uniquement si n√©cessaire\n  useEffect(() => {\n    const initializeContent = async () => {\n      if (viewMode === 'wysiwyg' && editorRef.current && editorRef.current.innerHTML !== content) {\n        // Ne pas modifier le contenu si l'utilisateur interagit activement\n        const hasFocus = document.activeElement === editorRef.current;\n        const hasSelection = window.getSelection().rangeCount > 0;\n        \n        // √âviter les mises √† jour pendant l'interaction utilisateur\n        if (hasFocus && hasSelection) {\n          return; // Ne pas perturber l'utilisateur\n        }\n        \n        // Convertir les URLs relatives PromptoDYS en Blob URLs pour affichage\n        const currentProject = getCurrentProject();\n        let displayContent = content;\n        \n        if (currentProject.directory) {\n          displayContent = await convertAllPromptoDysUrlsToBlobs(content, currentProject.directory);\n        }\n        \n        // La conversion indexed:// ‚Üí blob: est d√©j√† g√©r√©e par App.js au chargement initial\n        \n        // Mise √† jour avec le contenu converti (IndexedDB g√©r√© par MutationObserver)\n        editorRef.current.innerHTML = displayContent;\n        \n        // Re-rendre MathJax apr√®s mise √† jour du contenu\n        if (window.MathJax && window.MathJax.typesetPromise) {\n          window.MathJax.typesetPromise([editorRef.current]).catch((err) => {\n            console.warn('Erreur MathJax:', err);\n          });\n        }\n      }\n    };\n    \n    initializeContent();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [viewMode, content]);\n\n  // Gestionnaire pour la copie - convertir HTML en texte propre et g√©rer les images s√©lectionn√©es\n  const handleCopy = useCallback((e) => {\n    if (viewMode === 'wysiwyg' && editorRef.current) {\n      // Priorit√© 1: Si une image est s√©lectionn√©e, copier l'image\n      if (selectedImage) {\n        try {\n          // Cr√©er un √©l√©ment temporaire avec l'image\n          const tempDiv = document.createElement('div');\n          const clonedImg = selectedImage.cloneNode(true);\n          tempDiv.appendChild(clonedImg);\n          \n          // Copier au format HTML pour pr√©server la structure\n          e.clipboardData.setData('text/html', tempDiv.innerHTML);\n          // Copier aussi le src comme texte de fallback\n          e.clipboardData.setData('text/plain', selectedImage.src);\n          e.preventDefault();\n          return;\n        } catch (error) {\n          console.warn('Erreur copie image:', error);\n        }\n      }\n      \n      // Priorit√© 2: S√©lection de texte classique\n      const selection = window.getSelection();\n      if (selection.rangeCount > 0) {\n        const range = selection.getRangeAt(0);\n        const selectedContent = range.cloneContents();\n        const tempDiv = document.createElement('div');\n        tempDiv.appendChild(selectedContent);\n        \n        // Convertir HTML en texte avec retours √† la ligne pr√©serv√©s\n        const htmlContent = tempDiv.innerHTML;\n        const textContent = htmlContent\n          .replace(/<div[^>]*>/gi, '')\n          .replace(/<\\/div>/gi, '\\n')\n          .replace(/<br\\s*\\/?>/gi, '\\n')\n          .replace(/<p[^>]*>/gi, '')\n          .replace(/<\\/p>/gi, '\\n')\n          .replace(/<[^>]+>/g, '') // Supprimer toutes les autres balises\n          .replace(/&nbsp;/g, ' ')\n          .replace(/&amp;/g, '&')\n          .replace(/&lt;/g, '<')\n          .replace(/&gt;/g, '>')\n          .replace(/&quot;/g, '\"')\n          .replace(/&#39;/g, \"'\")\n          .replace(/\\n+$/, ''); // Supprimer les retours √† la ligne en fin\n        \n        // Mettre le texte propre dans le presse-papier\n        e.clipboardData.setData('text/plain', textContent);\n        e.preventDefault();\n      }\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [viewMode, selectedImage]);\n\n  // Gestionnaire pour forcer le refresh apr√®s coller\n  const handlePaste = useCallback((e) => {\n    if (viewMode === 'wysiwyg' && editorRef.current) {\n      // Attendre que le contenu soit coll√©\n      setTimeout(async () => {\n        console.log('üîÑ Refresh forc√© apr√®s coller');\n        \n        // Reconvertir toutes les images indexed:// qui pourraient avoir √©t√© coll√©es\n        const indexedImages = editorRef.current.querySelectorAll('img[src^=\"indexed://\"]');\n        for (const img of indexedImages) {\n          const imageId = img.src.replace('indexed://', '');\n          try {\n            const imageData = await loadImage(imageId);\n            if (imageData?.blobUrl) {\n              img.src = imageData.blobUrl;\n              img.setAttribute('data-image-id', imageId);\n              console.log('‚úÖ Image refresh apr√®s coller:', imageId);\n            }\n          } catch (error) {\n            console.warn('‚ö†Ô∏è Erreur refresh image apr√®s coller:', error);\n          }\n        }\n        \n        // Ajouter les poign√©es aux nouvelles images coll√©es\n        const newImages = editorRef.current.querySelectorAll('img:not([data-resizable])');\n        newImages.forEach(img => {\n          if (editorRef.current.addResizeHandlesToImage) {\n            editorRef.current.addResizeHandlesToImage(img);\n          }\n        });\n        \n        // D√©clencher sauvegarde\n        if (onInput) {\n          const event = new Event('input', { bubbles: true });\n          editorRef.current.dispatchEvent(event);\n        }\n      }, 100);\n    }\n  }, [viewMode, loadImage, onInput]);\n\n  // √âcouter les changements de s√©lection, la copie et le coller\n  useEffect(() => {\n    if (viewMode === 'wysiwyg') {\n      document.addEventListener('selectionchange', handleSelectionChange);\n      editorRef.current?.addEventListener('copy', handleCopy);\n      editorRef.current?.addEventListener('paste', handlePaste);\n      \n      return () => {\n        document.removeEventListener('selectionchange', handleSelectionChange);\n        editorRef.current?.removeEventListener('copy', handleCopy);\n        editorRef.current?.removeEventListener('paste', handlePaste);\n      };\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [viewMode, handleSelectionChange, handleCopy, handlePaste]);\n\n  // Effect pour redimensionner au changement de contenu (toujours d√©clar√©)\n  useEffect(() => {\n    if (viewMode !== 'wysiwyg' && editorRef.current) {\n      handleTextareaResize(editorRef.current);\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [content, viewMode, handleTextareaResize]);\n\n  // Fonction pour convertir toutes les images indexed:// pr√©sentes dans le DOM\n  const convertAllIndexedImages = useCallback(async () => {\n    if (viewMode !== 'wysiwyg' || !editorRef.current) return;\n    \n    const images = editorRef.current.querySelectorAll('img[src^=\"indexed://\"]');\n    console.log(`üîç DIAGNOSTIC: ${images.length} images indexed:// trouv√©es dans le DOM`);\n    \n    for (const img of images) {\n      const imageId = img.src.replace('indexed://', '');\n      console.log('üîé DIAGNOSTIC: Tentative chargement imageId:', imageId);\n      \n      try {\n        const imageData = await loadImage(imageId);\n        console.log('üîé DIAGNOSTIC: R√©sultat loadImage:', imageData);\n        \n        if (imageData && imageData.blobUrl) {\n          // Tester si la blob URL est valide\n          const testImg = new Image();\n          testImg.onload = () => console.log('‚úÖ DIAGNOSTIC: Blob URL valide:', imageData.blobUrl);\n          testImg.onerror = () => console.error('‚ùå DIAGNOSTIC: Blob URL invalide:', imageData.blobUrl);\n          testImg.src = imageData.blobUrl;\n          \n          img.src = imageData.blobUrl;\n          console.log('‚úÖ Image convertie au chargement:', imageId, '‚Üí', imageData.blobUrl);\n          \n          // R√©appliquer les poign√©es apr√®s conversion\n          setTimeout(() => {\n            if (editorRef.current?.contains(img) && editorRef.current.addResizeHandlesToImage) {\n              editorRef.current.addResizeHandlesToImage(img);\n            }\n          }, 100);\n        } else {\n          console.error('‚ùå DIAGNOSTIC: loadImage a retourn√© null/undefined pour:', imageId);\n        }\n      } catch (error) {\n        console.error('‚ùå DIAGNOSTIC: Erreur loadImage pour', imageId, ':', error);\n      }\n    }\n  }, [viewMode, loadImage]);\n\n  // MutationObserver pour convertir les images indexed:// en temps r√©el\n  useEffect(() => {\n    if (viewMode !== 'wysiwyg' || !editorRef.current) return;\n\n    // Conversion initiale des images d√©j√† pr√©sentes\n    convertAllIndexedImages().then(() => {\n      // Ajouter les poign√©es apr√®s la conversion\n      setTimeout(() => {\n        const addHandles = () => {\n          const images = editorRef.current?.querySelectorAll('img:not([data-resizable])');\n          images?.forEach((img) => {\n            if (!img.src.startsWith('indexed://')) {\n              img.setAttribute('data-resizable', 'true');\n              // D√©clencher l'ajout des poign√©es\n              const event = new Event('load', { bubbles: true });\n              img.dispatchEvent(event);\n            }\n          });\n        };\n        addHandles();\n      }, 500);\n    });\n\n    const observer = new MutationObserver(async (mutations) => {\n      // Traiter les mutations de fa√ßon s√©quentielle pour √©viter les race conditions\n      for (const mutation of mutations) {\n        // V√©rifier les nouveaux n≈ìuds ajout√©s\n        for (const node of mutation.addedNodes) {\n          if (node.nodeType === Node.ELEMENT_NODE) {\n            // Chercher les images avec src indexed://\n            const images = node.tagName === 'IMG' \n              ? [node] \n              : node.querySelectorAll ? node.querySelectorAll('img[src^=\"indexed://\"]') : [];\n            \n            for (const img of images) {\n              if (img.src && img.src.startsWith('indexed://')) {\n                const imageId = img.src.replace('indexed://', '');\n                console.log('üîç Image IndexedDB d√©tect√©e (mutation):', imageId);\n                \n                try {\n                  // Attendre que loadImage soit compl√®tement r√©solu\n                  const imageData = await loadImage(imageId);\n                  if (imageData && imageData.blobUrl) {\n                    // V√©rifier que la blob URL est valide avant l'assignation\n                    img.src = imageData.blobUrl;\n                    console.log('‚úÖ Image DOM convertie (mutation):', imageId, '‚Üí', imageData.blobUrl);\n                  } else {\n                    console.warn('‚ö†Ô∏è Pas de blob URL g√©n√©r√©e pour:', imageId);\n                  }\n                } catch (error) {\n                  console.warn('‚ö†Ô∏è Erreur conversion image (mutation):', imageId, error);\n                }\n              }\n            }\n          }\n        }\n\n        // V√©rifier les modifications d'attributs (src modifi√©)\n        if (mutation.type === 'attributes' && mutation.attributeName === 'src') {\n          const img = mutation.target;\n          if (img.tagName === 'IMG' && img.src && img.src.startsWith('indexed://')) {\n            const imageId = img.src.replace('indexed://', '');\n            console.log('üîç Attribut src modifi√© vers IndexedDB:', imageId);\n            \n            try {\n              // Attendre que loadImage soit compl√®tement r√©solu\n              const imageData = await loadImage(imageId);\n              if (imageData && imageData.blobUrl) {\n                // V√©rifier que la blob URL est valide avant l'assignation\n                img.src = imageData.blobUrl;\n                console.log('‚úÖ Image DOM convertie (attr):', imageId, '‚Üí', imageData.blobUrl);\n              } else {\n                console.warn('‚ö†Ô∏è Pas de blob URL g√©n√©r√©e pour:', imageId);\n              }\n            } catch (error) {\n              console.warn('‚ö†Ô∏è Erreur conversion image (attr):', imageId, error);\n            }\n          }\n        }\n      }\n    });\n\n  // Observer les modifications dans l'√©diteur\n  observer.observe(editorRef.current, {\n    childList: true,\n    subtree: true,\n    attributes: true,\n    attributeFilter: ['src']\n  });\n\n  return () => {\n    observer.disconnect();\n  };\n}, [viewMode, loadImage, convertAllIndexedImages]);\n\n  // Effect pour appliquer le style de s√©lection d'image\n  useEffect(() => {\n    if (viewMode === 'wysiwyg' && editorRef.current) {\n      // Supprimer la classe de toutes les images\n      const allImages = editorRef.current.querySelectorAll('img');\n      allImages.forEach(img => {\n        const wrapper = img.closest('.resizable-image');\n        if (wrapper) {\n          wrapper.classList.remove('image-selected');\n        }\n      });\n\n      // Ajouter la classe √† l'image s√©lectionn√©e\n      if (selectedImage) {\n        const wrapper = selectedImage.closest('.resizable-image');\n        if (wrapper) {\n          wrapper.classList.add('image-selected');\n        }\n      }\n    }\n  }, [selectedImage, viewMode]);\n\n  // Gestion des poign√©es de redimensionnement pour les images\n  useEffect(() => {\n    if (viewMode === 'wysiwyg' && editorRef.current) {\n      const addResizeHandlesToImage = (img) => {\n        // Exposer la fonction pour r√©utilisation\n        editorRef.current.addResizeHandlesToImage = addResizeHandlesToImage;\n        // Ignorer les images indexed:// non converties\n        if (img.src.startsWith('indexed://')) {\n          console.log('‚è≥ Image indexed:// ignor√©e, en attente de conversion:', img.src);\n          return;\n        }\n        \n        // V√©rifier si d√©j√† trait√©\n        if (img.getAttribute('data-resizable') || img.parentElement?.classList.contains('resizable-image')) {\n          return;\n        }\n        \n        // Attendre que l'image soit charg√©e\n        if (!img.complete || img.naturalWidth === 0) {\n          img.addEventListener('load', () => addResizeHandlesToImage(img), { once: true });\n          return;\n        }\n        \n        img.setAttribute('data-resizable', 'true');\n        \n        // Wrapper l'image dans un conteneur redimensionnable\n        const wrapper = document.createElement('div');\n        wrapper.className = 'resizable-image';\n        \n        // Ajouter gestionnaire de clic pour s√©lection d'image\n        img.addEventListener('click', (e) => {\n          e.stopPropagation();\n          if (onImageClick) {\n            onImageClick(img);\n          }\n        });\n        \n        // Extraire les dimensions depuis le style inline ou les attributs\n        let currentWidth, currentHeight;\n        \n        // Priorit√© 1: attributs HTML (ex: width=\"300px\")\n        const attrWidth = img.getAttribute('width');\n        const attrHeight = img.getAttribute('height');\n        \n        // Priorit√© 2: style inline (ex: style=\"width: 300px\")\n        const styleWidth = img.style.width;\n        const styleHeight = img.style.height;\n        \n        if (attrWidth && attrHeight) {\n          currentWidth = parseInt(attrWidth);\n          currentHeight = parseInt(attrHeight);\n          console.log('üìè Dimensions depuis attributs:', currentWidth, 'x', currentHeight);\n        } else if (styleWidth && styleHeight) {\n          currentWidth = parseInt(styleWidth);\n          currentHeight = parseInt(styleHeight);\n          console.log('üìè Dimensions depuis style:', currentWidth, 'x', currentHeight);\n        } else {\n          // Fallback: dimensions naturelles\n          currentWidth = img.naturalWidth || 300;\n          currentHeight = img.naturalHeight || 200;\n          console.log('üìè Dimensions naturelles:', currentWidth, 'x', currentHeight);\n        }\n        \n        // Limiter la hauteur maximale √† 300px en pr√©servant le ratio d'aspect\n        const MAX_HEIGHT = 300;\n        if (currentHeight > MAX_HEIGHT) {\n          const aspectRatio = currentWidth / currentHeight;\n          currentHeight = MAX_HEIGHT;\n          currentWidth = Math.round(currentHeight * aspectRatio);\n          console.log('üîÑ Image redimensionn√©e pour hauteur max 300px:', currentWidth, 'x', currentHeight);\n          \n          // Appliquer les nouvelles dimensions √† l'image\n          img.setAttribute('width', currentWidth + 'px');\n          img.setAttribute('height', currentHeight + 'px');\n          img.style.width = currentWidth + 'px';\n          img.style.height = currentHeight + 'px';\n        }\n        \n        wrapper.style.width = currentWidth + 'px';\n        wrapper.style.height = currentHeight + 'px';\n          \n          // Ins√©rer le wrapper\n          img.parentNode.insertBefore(wrapper, img);\n          wrapper.appendChild(img);\n          \n          // Cr√©er les 4 poign√©es\n          ['nw', 'ne', 'sw', 'se'].forEach((corner) => {\n            const handle = document.createElement('div');\n            handle.className = `resize-handle ${corner}`;\n            handle.dataset.corner = corner;\n            \n            handle.addEventListener('mousedown', (e) => {\n              e.preventDefault();\n              e.stopPropagation();\n              \n              const startX = e.clientX;\n              const startY = e.clientY;\n              const startWidth = wrapper.offsetWidth;\n              const startHeight = wrapper.offsetHeight;\n              const aspectRatio = startWidth / startHeight;\n              \n              const handleMouseMove = (e) => {\n                const deltaX = e.clientX - startX;\n                const deltaY = e.clientY - startY;\n                \n                let newWidth = startWidth;\n                let newHeight = startHeight;\n                \n                // Calculer les nouvelles dimensions selon le coin\n                switch(corner) {\n                  case 'se': // Sud-Est\n                    newWidth = Math.max(50, startWidth + deltaX);\n                    newHeight = newWidth / aspectRatio;\n                    break;\n                  case 'sw': // Sud-Ouest\n                    newWidth = Math.max(50, startWidth - deltaX);\n                    newHeight = newWidth / aspectRatio;\n                    break;\n                  case 'ne': // Nord-Est\n                    newWidth = Math.max(50, startWidth + deltaX);\n                    newHeight = newWidth / aspectRatio;\n                    break;\n                  case 'nw': // Nord-Ouest\n                    newWidth = Math.max(50, startWidth - deltaX);\n                    newHeight = newWidth / aspectRatio;\n                    break;\n                }\n                \n                // Appliquer les nouvelles dimensions\n                wrapper.style.width = newWidth + 'px';\n                wrapper.style.height = newHeight + 'px';\n                img.style.width = '100%';\n                img.style.height = '100%';\n                \n                // Ajouter les attributs HTML width/height pour persistance lors des conversions\n                img.setAttribute('width', Math.round(newWidth) + 'px');\n                img.setAttribute('height', Math.round(newHeight) + 'px');\n              };\n              \n              const handleMouseUp = () => {\n                document.removeEventListener('mousemove', handleMouseMove);\n                document.removeEventListener('mouseup', handleMouseUp);\n                \n                // D√©clencher l'√©v√©nement de changement pour sauvegarder\n                if (onInput) {\n                  const event = new Event('input', { bubbles: true });\n                  editorRef.current.dispatchEvent(event);\n                }\n              };\n              \n              document.addEventListener('mousemove', handleMouseMove);\n              document.addEventListener('mouseup', handleMouseUp);\n            });\n            \n            wrapper.appendChild(handle);\n          });\n      };\n      \n      // Observer pour d√©tecter les nouvelles images\n      const handleMutation = (mutations) => {\n        mutations.forEach(mutation => {\n          mutation.addedNodes.forEach(node => {\n            if (node.nodeName === 'IMG') {\n              addResizeHandlesToImage(node);\n            } else if (node.querySelectorAll) {\n              node.querySelectorAll('img').forEach(addResizeHandlesToImage);\n            }\n          });\n        });\n      };\n      \n      const observer = new MutationObserver(handleMutation);\n      observer.observe(editorRef.current, {\n        childList: true,\n        subtree: true\n      });\n      \n      // Traiter les images existantes\n      editorRef.current.querySelectorAll('img').forEach(addResizeHandlesToImage);\n      \n      return () => observer.disconnect();\n    }\n  }, [viewMode, onInput]);\n  \n  // Effect supprim√© - La gestion des poign√©es est maintenant dans l'effect pr√©c√©dent\n\n  // Rendu conditionnel avec switch/case pour garantir une seule vue\n  console.log('üîÑ Editor.js - Rendu switch/case, viewMode:', viewMode);\n  \n  switch (viewMode) {\n    case 'wysiwyg':\n      console.log('üéØ SWITCH - Vue WYSIWYG');\n      return (\n        <div key=\"wysiwyg\">\n          <style>{`\n            .editor-content h1 { \n              font-size: 2em; \n              font-weight: bold; \n              margin: 0.67em 0; \n              line-height: 1.2;\n            }\n            .editor-content h2 { \n              font-size: 1.5em; \n              font-weight: bold; \n              margin: 0.75em 0; \n              line-height: 1.3;\n            }\n            .editor-content h3 { \n              font-size: 1.17em; \n              font-weight: bold; \n              margin: 0.83em 0; \n              line-height: 1.4;\n            }\n            .editor-content p {\n              margin: 0.5em 0;\n            }\n            .editor-content ul {\n              margin: 0.5em 0;\n              padding-left: 2em;\n              list-style-type: disc;\n            }\n            .editor-content ol {\n              margin: 0.5em 0;\n              padding-left: 2em;\n              list-style-type: decimal;\n            }\n            .editor-content ol[style*=\"lower-alpha\"] {\n              list-style-type: lower-alpha;\n            }\n            .editor-content li {\n              margin: 0.25em 0;\n            }\n            \n            /* Styles pour images redimensionnables */\n            .editor-content img {\n              max-width: 100%;\n              height: auto;\n              position: relative;\n              cursor: pointer;\n            }\n            \n            .resizable-image {\n              position: relative;\n              display: inline-block;\n              border: 2px solid transparent;\n            }\n            \n            .resizable-image:hover {\n              border: 2px solid #3b82f6;\n            }\n            \n            /* Style pour image s√©lectionn√©e */\n            .image-selected {\n              border: 3px solid #2563eb !important;\n              box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);\n            }\n            \n            .resizable-image img {\n              width: 100%;\n              height: 100%;\n              display: block;\n            }\n            \n            .resizable-image .resize-handle {\n              position: absolute;\n              width: 10px;\n              height: 10px;\n              background: #3b82f6;\n              border: 2px solid white;\n              border-radius: 50%;\n              opacity: 0;\n              cursor: nw-resize;\n              transition: opacity 0.2s;\n            }\n            \n            .resizable-image:hover .resize-handle {\n              opacity: 1;\n            }\n            \n            .resize-handle.nw { top: -6px; left: -6px; cursor: nw-resize; }\n            .resize-handle.ne { top: -6px; right: -6px; cursor: ne-resize; }\n            .resize-handle.sw { bottom: -6px; left: -6px; cursor: sw-resize; }\n            .resize-handle.se { bottom: -6px; right: -6px; cursor: se-resize; }\n          `}</style>\n          <div\n            ref={editorRef}\n            contentEditable\n            spellCheck={false}\n            onInput={handleChange}\n            onClick={onEditorClick}\n            onKeyDown={onDeleteSelectedImage}\n            suppressContentEditableWarning={true}\n            className=\"editor-content p-2 focus:outline-none h-full\"\n            style={{ \n              fontFamily: 'var(--dys-font-family)',\n              fontSize: 'var(--dys-font-size)',\n              lineHeight: 'var(--dys-line-height)',\n              color: 'var(--dys-text-color)',\n              backgroundColor: 'var(--dys-bg-color)',\n              overflow: 'auto',\n              wordWrap: 'break-word',\n              whiteSpace: 'pre-wrap',\n              border: '1px solid #e5e7eb',\n              paddingBottom: '2rem'\n            }}\n          />\n        </div>\n      );\n\n    case 'markdown': {\n      console.log('üìù SWITCH - Vue MARKDOWN');\n      const displayContent = getCollapsedContent(content);\n      \n      return (\n        <div key=\"markdown\" className=\"relative\">\n          <textarea\n            ref={(el) => {\n              editorRef.current = el;\n            }}\n            value={displayContent}\n            onChange={(e) => {\n              const newValue = e.target.value;\n              const originalWithCollapse = getCollapsedContent(content);\n              \n              if (newValue !== originalWithCollapse) {\n                onInput({ ...e, target: { ...e.target, value: newValue } });\n              }\n            }}\n            onClick={handleBase64Toggle}\n            className=\"editor-content p-2 w-full h-full border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none\"\n            style={{\n              fontFamily: 'var(--dys-font-family)',\n              fontSize: 'var(--dys-font-size)',\n              lineHeight: 'var(--dys-line-height)',\n              color: 'var(--dys-text-color)',\n              backgroundColor: 'var(--dys-bg-color)',\n              overflow: 'auto',\n              wordWrap: 'break-word',\n              whiteSpace: 'pre-wrap',\n              paddingBottom: '2rem'\n            }}\n            placeholder=\"√âcrivez en Markdown...\n\n# Titre 1\n## Titre 2\n### Titre 3\n\n**Gras** *Italique*\n\n- Liste √† puces\n1. Liste num√©rot√©e\na. Liste alphab√©tique\n\n$E = mc^2$ (formule inline)\n$$\\\\int_{-\\\\infty}^{\\\\infty} e^{-x^2} dx = \\\\sqrt{\\\\pi}$$ (formule block)\"\n          />\n          {detectBase64(content).length > 0 && (\n            <div className=\"absolute top-2 right-2 bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs\">\n              üì∑ {detectBase64(content).length} image(s) Base64\n            </div>\n          )}\n        </div>\n      );\n    }\n\n    case 'html': {\n      console.log('üîß SWITCH - Vue HTML');\n      const htmlDisplayContent = formatHtmlForSource(getCollapsedContent(content));\n    \n      return (\n        <div key=\"html\" className=\"relative\">\n          <textarea\n            ref={(el) => {\n              editorRef.current = el;\n            }}\n            value={htmlDisplayContent}\n            onChange={(e) => {\n              const newValue = e.target.value;\n              const originalWithCollapse = formatHtmlForSource(getCollapsedContent(content));\n              \n              if (newValue !== originalWithCollapse) {\n                onInput({ ...e, target: { ...e.target, value: newValue } });\n              }\n            }}\n            onClick={handleBase64Toggle}\n            className=\"w-full h-full p-2 focus:outline-none resize-none\"\n            style={{ \n              fontFamily: 'Monaco, \"Cascadia Code\", \"Roboto Mono\", monospace',\n              overflow: 'auto',\n              wordWrap: 'break-word',\n              whiteSpace: 'pre-wrap',\n              border: '1px solid #e5e7eb',\n              paddingBottom: '2rem'\n            }}\n            placeholder=\"Code source HTML...\"\n          />\n          {detectBase64(content).length > 0 && (\n            <div className=\"absolute top-2 right-2 bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs\">\n              üì∑ {detectBase64(content).length} image(s) Base64\n            </div>\n          )}\n        </div>\n      );\n    }\n\n    default:\n      console.log('‚ùå SWITCH - AUCUNE VUE CORRESPONDANTE, viewMode:', viewMode);\n      return null;\n  }\n};\n\nexport default Editor;\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}