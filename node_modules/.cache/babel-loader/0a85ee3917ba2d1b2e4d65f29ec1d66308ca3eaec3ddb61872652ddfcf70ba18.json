{"ast":null,"code":"// ImageStore - Gestion persistante des images avec IndexedDB\n// Utilise idb-keyval pour simplicit√© et robustesse\nimport { get, set, del } from 'idb-keyval';\n\n/**\n * Sauvegarde un fichier image en IndexedDB\n * @param {string} imageId - UUID pour identifier l'image\n * @param {File|Blob} file - Fichier image √† sauvegarder\n * @returns {Promise<string>} - UUID utilis√© pour identifier l'image\n */\nexport const saveImage = async (imageId, file) => {\n  console.log('üîÑ [ImageStore] D√©but sauvegarde image:', file.name || 'blob', `(${Math.round(file.size / 1024)}KB)`);\n  console.log('üÜî [ImageStore] Utilisation ID fourni:', imageId);\n  try {\n    // Sauvegarder en IndexedDB avec l'ID fourni\n    await set(imageId, file);\n    console.log('‚úÖ [ImageStore] Image sauvegard√©e en IndexedDB:', imageId);\n    console.log('üìä [ImageStore] D√©tails:', {\n      imageId,\n      fileName: file.name || 'unnamed',\n      fileSize: `${Math.round(file.size / 1024)}KB`,\n      fileType: file.type\n    });\n    return imageId;\n  } catch (error) {\n    console.error('‚ùå [ImageStore] Erreur sauvegarde:', error);\n    throw new Error(`√âchec sauvegarde image: ${error.message}`);\n  }\n};\n\n/**\n * R√©cup√®re une image depuis IndexedDB et cr√©e une Object URL\n * @param {string} imageId - UUID de l'image\n * @returns {Promise<string|null>} - Object URL temporaire ou null si non trouv√©e\n */\nexport const loadImage = async imageId => {\n  console.log('üîç [ImageStore] Chargement image:', imageId);\n  try {\n    // R√©cup√©rer le Blob depuis IndexedDB\n    const blob = await get(imageId);\n    if (!blob) {\n      console.warn('‚ö†Ô∏è [ImageStore] Image non trouv√©e en IndexedDB:', imageId);\n      return null;\n    }\n    console.log('üì¶ [ImageStore] Blob r√©cup√©r√©:', {\n      imageId,\n      blobSize: `${Math.round(blob.size / 1024)}KB`,\n      blobType: blob.type\n    });\n\n    // Cr√©er Object URL temporaire\n    const objectUrl = URL.createObjectURL(blob);\n    console.log('üîó [ImageStore] Object URL cr√©√©e:', objectUrl);\n    return objectUrl;\n  } catch (error) {\n    console.error('‚ùå [ImageStore] Erreur chargement:', error);\n    return null;\n  }\n};\n\n/**\n * Supprime une image de IndexedDB\n * @param {string} imageId - UUID de l'image √† supprimer\n * @returns {Promise<boolean>} - true si supprim√©e avec succ√®s\n */\nexport const deleteImage = async imageId => {\n  console.log('üóëÔ∏è [ImageStore] Suppression image:', imageId);\n  try {\n    await del(imageId);\n    console.log('‚úÖ [ImageStore] Image supprim√©e de IndexedDB:', imageId);\n    return true;\n  } catch (error) {\n    console.error('‚ùå [ImageStore] Erreur suppression:', error);\n    return false;\n  }\n};\n\n/**\n * Liste toutes les images stock√©es (debug uniquement)\n * @returns {Promise<string[]>} - Liste des imageIds\n */\nexport const listAllImages = async () => {\n  console.log('üìã [ImageStore] Listing toutes les images...');\n  try {\n    // Note: idb-keyval ne fournit pas de m√©thode keys() directe\n    // Cette fonction est pour debug - en production on trackera les IDs diff√©remment\n    console.warn('‚ö†Ô∏è [ImageStore] listAllImages() est pour debug uniquement');\n    return [];\n  } catch (error) {\n    console.error('‚ùå [ImageStore] Erreur listing:', error);\n    return [];\n  }\n};\n\n/**\n * Nettoie les Object URLs pour √©viter les fuites m√©moire\n * @param {string} objectUrl - URL √† r√©voquer\n */\nexport const revokeImageUrl = objectUrl => {\n  if (objectUrl && objectUrl.startsWith('blob:')) {\n    console.log('üßπ [ImageStore] R√©vocation Object URL:', objectUrl);\n    URL.revokeObjectURL(objectUrl);\n  }\n};\n\n/**\n * Demande au navigateur de rendre le stockage persistant\n * @returns {Promise<boolean>} - true si accord√©\n */\nexport const requestPersistentStorage = async () => {\n  console.log('üîí [ImageStore] Demande stockage persistant...');\n  if ('storage' in navigator && 'persist' in navigator.storage) {\n    try {\n      const isPersistent = await navigator.storage.persist();\n      console.log(isPersistent ? '‚úÖ [ImageStore] Stockage persistant accord√©' : '‚ö†Ô∏è [ImageStore] Stockage persistant refus√©');\n      return isPersistent;\n    } catch (error) {\n      console.error('‚ùå [ImageStore] Erreur demande persistance:', error);\n      return false;\n    }\n  } else {\n    console.warn('‚ö†Ô∏è [ImageStore] API storage.persist() non support√©e');\n    return false;\n  }\n};\n\n/**\n * Nettoyage intelligent des images orphelines\n * Supprime les images d'IndexedDB qui ne sont plus r√©f√©renc√©es dans le document\n * @param {string} htmlContent - Contenu HTML du document √† analyser\n * @returns {Promise<number>} - Nombre d'images nettoy√©es\n */\nexport const cleanupOrphanedImages = async htmlContent => {\n  console.log('üßπ [ImageStore] D√©but nettoyage des images orphelines...');\n  try {\n    // Parser le HTML pour trouver les imageIds actuellement utilis√©s\n    const parser = new DOMParser();\n    const doc = parser.parseFromString(htmlContent, 'text/html');\n    const usedImageIds = new Set();\n\n    // Collecter tous les data-image-id dans le document\n    const imagesWithIds = doc.querySelectorAll('img[data-image-id]');\n    imagesWithIds.forEach(img => {\n      const imageId = img.getAttribute('data-image-id');\n      if (imageId) {\n        usedImageIds.add(imageId);\n      }\n    });\n    console.log('üîç [ImageStore] Images utilis√©es dans le document:', usedImageIds.size);\n    console.log('üìã [ImageStore] IDs utilis√©s:', Array.from(usedImageIds));\n\n    // Note: idb-keyval ne fournit pas de m√©thode keys() native\n    // En production, on maintiendrait une liste des imageIds dans localStorage\n    // Pour l'instant, on log seulement les images utilis√©es\n    console.log('‚ÑπÔ∏è [ImageStore] Nettoyage limit√© - pas de liste globale des cl√©s IndexedDB');\n    return 0; // Pas de nettoyage effectu√© pour l'instant\n  } catch (error) {\n    console.error('‚ùå [ImageStore] Erreur nettoyage:', error);\n    return 0;\n  }\n};\n\n// Log d'initialisation\nconsole.log('üöÄ [ImageStore] Module initialis√© avec idb-keyval');","map":{"version":3,"names":["get","set","del","saveImage","imageId","file","console","log","name","Math","round","size","fileName","fileSize","fileType","type","error","Error","message","loadImage","blob","warn","blobSize","blobType","objectUrl","URL","createObjectURL","deleteImage","listAllImages","revokeImageUrl","startsWith","revokeObjectURL","requestPersistentStorage","navigator","storage","isPersistent","persist","cleanupOrphanedImages","htmlContent","parser","DOMParser","doc","parseFromString","usedImageIds","Set","imagesWithIds","querySelectorAll","forEach","img","getAttribute","add","Array","from"],"sources":["C:/Users/JEAN-NOELLEFEBVRE-SA/CascadeProjects/editor/src/utils/imageStore.js"],"sourcesContent":["// ImageStore - Gestion persistante des images avec IndexedDB\n// Utilise idb-keyval pour simplicit√© et robustesse\nimport { get, set, del } from 'idb-keyval';\n\n/**\n * Sauvegarde un fichier image en IndexedDB\n * @param {string} imageId - UUID pour identifier l'image\n * @param {File|Blob} file - Fichier image √† sauvegarder\n * @returns {Promise<string>} - UUID utilis√© pour identifier l'image\n */\nexport const saveImage = async (imageId, file) => {\n  console.log('üîÑ [ImageStore] D√©but sauvegarde image:', file.name || 'blob', `(${Math.round(file.size/1024)}KB)`);\n  console.log('üÜî [ImageStore] Utilisation ID fourni:', imageId);\n  \n  try {\n    // Sauvegarder en IndexedDB avec l'ID fourni\n    await set(imageId, file);\n    console.log('‚úÖ [ImageStore] Image sauvegard√©e en IndexedDB:', imageId);\n    console.log('üìä [ImageStore] D√©tails:', {\n      imageId,\n      fileName: file.name || 'unnamed',\n      fileSize: `${Math.round(file.size/1024)}KB`,\n      fileType: file.type\n    });\n    \n    return imageId;\n  } catch (error) {\n    console.error('‚ùå [ImageStore] Erreur sauvegarde:', error);\n    throw new Error(`√âchec sauvegarde image: ${error.message}`);\n  }\n};\n\n/**\n * R√©cup√®re une image depuis IndexedDB et cr√©e une Object URL\n * @param {string} imageId - UUID de l'image\n * @returns {Promise<string|null>} - Object URL temporaire ou null si non trouv√©e\n */\nexport const loadImage = async (imageId) => {\n  console.log('üîç [ImageStore] Chargement image:', imageId);\n  \n  try {\n    // R√©cup√©rer le Blob depuis IndexedDB\n    const blob = await get(imageId);\n    \n    if (!blob) {\n      console.warn('‚ö†Ô∏è [ImageStore] Image non trouv√©e en IndexedDB:', imageId);\n      return null;\n    }\n    \n    console.log('üì¶ [ImageStore] Blob r√©cup√©r√©:', {\n      imageId,\n      blobSize: `${Math.round(blob.size/1024)}KB`,\n      blobType: blob.type\n    });\n    \n    // Cr√©er Object URL temporaire\n    const objectUrl = URL.createObjectURL(blob);\n    console.log('üîó [ImageStore] Object URL cr√©√©e:', objectUrl);\n    \n    return objectUrl;\n  } catch (error) {\n    console.error('‚ùå [ImageStore] Erreur chargement:', error);\n    return null;\n  }\n};\n\n/**\n * Supprime une image de IndexedDB\n * @param {string} imageId - UUID de l'image √† supprimer\n * @returns {Promise<boolean>} - true si supprim√©e avec succ√®s\n */\nexport const deleteImage = async (imageId) => {\n  console.log('üóëÔ∏è [ImageStore] Suppression image:', imageId);\n  \n  try {\n    await del(imageId);\n    console.log('‚úÖ [ImageStore] Image supprim√©e de IndexedDB:', imageId);\n    return true;\n  } catch (error) {\n    console.error('‚ùå [ImageStore] Erreur suppression:', error);\n    return false;\n  }\n};\n\n/**\n * Liste toutes les images stock√©es (debug uniquement)\n * @returns {Promise<string[]>} - Liste des imageIds\n */\nexport const listAllImages = async () => {\n  console.log('üìã [ImageStore] Listing toutes les images...');\n  \n  try {\n    // Note: idb-keyval ne fournit pas de m√©thode keys() directe\n    // Cette fonction est pour debug - en production on trackera les IDs diff√©remment\n    console.warn('‚ö†Ô∏è [ImageStore] listAllImages() est pour debug uniquement');\n    return [];\n  } catch (error) {\n    console.error('‚ùå [ImageStore] Erreur listing:', error);\n    return [];\n  }\n};\n\n/**\n * Nettoie les Object URLs pour √©viter les fuites m√©moire\n * @param {string} objectUrl - URL √† r√©voquer\n */\nexport const revokeImageUrl = (objectUrl) => {\n  if (objectUrl && objectUrl.startsWith('blob:')) {\n    console.log('üßπ [ImageStore] R√©vocation Object URL:', objectUrl);\n    URL.revokeObjectURL(objectUrl);\n  }\n};\n\n/**\n * Demande au navigateur de rendre le stockage persistant\n * @returns {Promise<boolean>} - true si accord√©\n */\nexport const requestPersistentStorage = async () => {\n  console.log('üîí [ImageStore] Demande stockage persistant...');\n  \n  if ('storage' in navigator && 'persist' in navigator.storage) {\n    try {\n      const isPersistent = await navigator.storage.persist();\n      console.log(isPersistent ? \n        '‚úÖ [ImageStore] Stockage persistant accord√©' : \n        '‚ö†Ô∏è [ImageStore] Stockage persistant refus√©'\n      );\n      return isPersistent;\n    } catch (error) {\n      console.error('‚ùå [ImageStore] Erreur demande persistance:', error);\n      return false;\n    }\n  } else {\n    console.warn('‚ö†Ô∏è [ImageStore] API storage.persist() non support√©e');\n    return false;\n  }\n};\n\n/**\n * Nettoyage intelligent des images orphelines\n * Supprime les images d'IndexedDB qui ne sont plus r√©f√©renc√©es dans le document\n * @param {string} htmlContent - Contenu HTML du document √† analyser\n * @returns {Promise<number>} - Nombre d'images nettoy√©es\n */\nexport const cleanupOrphanedImages = async (htmlContent) => {\n  console.log('üßπ [ImageStore] D√©but nettoyage des images orphelines...');\n  \n  try {\n    // Parser le HTML pour trouver les imageIds actuellement utilis√©s\n    const parser = new DOMParser();\n    const doc = parser.parseFromString(htmlContent, 'text/html');\n    const usedImageIds = new Set();\n    \n    // Collecter tous les data-image-id dans le document\n    const imagesWithIds = doc.querySelectorAll('img[data-image-id]');\n    imagesWithIds.forEach(img => {\n      const imageId = img.getAttribute('data-image-id');\n      if (imageId) {\n        usedImageIds.add(imageId);\n      }\n    });\n    \n    console.log('üîç [ImageStore] Images utilis√©es dans le document:', usedImageIds.size);\n    console.log('üìã [ImageStore] IDs utilis√©s:', Array.from(usedImageIds));\n    \n    // Note: idb-keyval ne fournit pas de m√©thode keys() native\n    // En production, on maintiendrait une liste des imageIds dans localStorage\n    // Pour l'instant, on log seulement les images utilis√©es\n    console.log('‚ÑπÔ∏è [ImageStore] Nettoyage limit√© - pas de liste globale des cl√©s IndexedDB');\n    \n    return 0; // Pas de nettoyage effectu√© pour l'instant\n  } catch (error) {\n    console.error('‚ùå [ImageStore] Erreur nettoyage:', error);\n    return 0;\n  }\n};\n\n// Log d'initialisation\nconsole.log('üöÄ [ImageStore] Module initialis√© avec idb-keyval');\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}